<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@4.4.1/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@4.4.1/dist/maplibre-gl.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lyon Cards - Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            background: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-container {
            width: 390px;
            height: 844px;
            max-height: 100vh;
            margin: 0 auto;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border-radius: 20px;
            overflow: hidden;
            /* HUD overlaid on map - no header bar */
        }

        @media (max-width: 480px) {
            body { background: white; }
            .app-container {
                width: 100vw;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
        }

        /* ---- MAP HUD OVERLAY ---- */
        .map-hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 30;
            pointer-events: none;
            padding: 14px 14px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .map-hud > * { pointer-events: all; }

        /* Avatar button */
        .hud-avatar-wrap { position: relative; }

        .hud-avatar-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            border: 3px solid white;
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            transition: transform 0.15s;
        }

        .hud-avatar-btn:active { transform: scale(0.93); }

        /* Dropdown menu */
        .avatar-menu {
            position: absolute;
            top: 58px;
            left: 0;
            background: white;
            border-radius: 14px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.18);
            overflow: hidden;
            min-width: 190px;
            animation: menuPop 0.18s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes menuPop {
            from { opacity: 0; transform: scale(0.85) translateY(-8px); transform-origin: top left; }
            to   { opacity: 1; transform: scale(1)    translateY(0);      transform-origin: top left; }
        }

        .avatar-menu-name {
            padding: 12px 16px 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #9ca3af;
        }

        .avatar-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            background: none;
            border: none;
            padding: 11px 16px;
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
            text-align: left;
            transition: background 0.15s;
        }

        .avatar-menu-item:hover { background: #f3f4f6; }
        .avatar-menu-item:last-child { margin-bottom: 6px; }

        .avatar-menu-item--disabled {
            opacity: 0.45;
            cursor: default;
        }

        .avatar-menu-item--disabled:hover { background: none; }

        .soon-badge {
            margin-left: auto;
            background: #EEF2FF;
            color: #4F46E5;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 20px;
        }

        /* Dust counter top-right */
        .hud-dust {
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            padding: 7px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 15px;
            font-weight: 700;
            color: #1f2937;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        }

        /* Keep old class stubs to avoid JS errors if referenced */
        .collections-btn { display: none; }

        #map {
            flex: 1;
            position: relative;
            /* Map fills full space since HUD is overlaid */
        }

        /* isometric-fallback CSS removed — tilt handled natively by Google Maps API */

        .controls {
            position: absolute;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 16px;
            z-index: 20;
        }

        .controls-hint {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .nearby-poi {
            background: #ECFDF5;
            border: 2px solid #10B981;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .nearby-poi-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .nearby-poi-name { font-weight: bold; color: #047857; font-size: 16px; }
        .nearby-poi-distance { font-size: 14px; color: #059669; margin-top: 4px; }

        .collect-btn {
            width: 100%;
            background: #10B981;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .collect-btn:hover { background: #059669; }

        /* Success toast (replaces old popup overlay) */
        .card-success-toast {
            display: none;
            position: absolute;
            bottom: 160px;
            left: 16px;
            right: 16px;
            z-index: 200;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: toastSlideUp 0.45s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes toastSlideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.92); }
            to   { opacity: 1; transform: translateY(0)    scale(1); }
        }

        .card-success-toast.show { display: block; }

        .toast-glow {
            position: absolute;
            inset: 0;
            opacity: 0.18;
        }

        .toast-inner {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 10px 14px 14px;
            background: rgba(15, 10, 30, 0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .toast-icon {
            font-size: 36px;
            flex-shrink: 0;
            animation: toastIconPop 0.5s 0.2s cubic-bezier(0.34,1.56,0.64,1) both;
        }

        @keyframes toastIconPop {
            from { transform: scale(0); }
            to   { transform: scale(1); }
        }

        .toast-text { flex: 1; }
        .toast-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.5); margin-bottom: 3px; }
        .toast-name  { font-size: 17px; font-weight: 800; color: white; }
        .toast-type  { font-size: 12px; color: rgba(255,255,255,0.55); margin-top: 2px; }

        .toast-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: rgba(255,255,255,0.6);
            width: 30px; height: 30px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .toast-close:hover { background: rgba(255,255,255,0.2); }

        .toast-clickable {
            display: flex; align-items: center; gap: 14px;
            flex: 1; cursor: pointer;
            padding: 2px 0;
        }
        .toast-clickable:hover .toast-name { text-decoration: underline; text-decoration-color: rgba(255,255,255,0.4); }

        .toast-tap-hint {
            font-size: 9px;
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 1px 5px;
            margin-left: 6px;
            letter-spacing: 0.3px;
            vertical-align: middle;
        }

        .toast-arrow {
            font-size: 22px;
            color: rgba(255,255,255,0.4);
            flex-shrink: 0;
            margin-right: 4px;
        }

        /* Keep old class stubs if any JS references them */
        .popup-overlay { display: none !important; }
        .popup-content { }
        .popup-icon { }
        .popup-title { }
        .popup-card-info { }

        .popup-card-name { font-size: 18px; font-weight: bold; color: #312E81; }
        .popup-card-type { font-size: 14px; color: #4F46E5; margin-top: 4px; }

        .popup-close-btn {
            width: 100%;
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .popup-close-btn:hover { background: #4338CA; }

        .collections-panel {
            display: none;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 200;
            flex-direction: column;
        }

        .collections-panel.show { display: flex; }

        .collections-header {
            background: #4F46E5;
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collections-title { font-size: 20px; font-weight: bold; }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collections-content { flex: 1; overflow-y: auto; padding: 16px; }

        .collection-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .collection-item:hover { border-color: #818CF8; }

        .collection-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .collection-item-title { font-size: 18px; font-weight: bold; color: #1f2937; }
        .collection-item-desc { font-size: 14px; color: #6b7280; margin-bottom: 12px; }

        .collection-badge {
            background: #EEF2FF;
            color: #4F46E5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill { height: 100%; background: #4F46E5; transition: width 0.3s; }

        .empty-state { text-align: center; padding: 48px 24px; color: #6b7280; }
        .empty-icon { font-size: 64px; opacity: 0.5; margin-bottom: 16px; }

        /* Collection tabs (Cartes / Échos) */
        .col-tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }

        .col-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .col-tab.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
            background: white;
        }

        .col-tab:hover { background: #f9fafb; }

        /* Echo cards in the panel */
        .echo-type-section {
            margin-bottom: 20px;
        }

        .echo-type-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: white;
            font-weight: 700;
            font-size: 15px;
        }

        .echo-type-count {
            background: rgba(255,255,255,0.25);
            border-radius: 20px;
            padding: 2px 10px;
            font-size: 13px;
            font-weight: 600;
            margin-left: auto;
        }

        .echo-compatible-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 8px;
        }

        .echo-compatible-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.15s;
        }

        .echo-compatible-card:hover {
            border-color: #818CF8;
            transform: translateX(4px);
        }

        .echo-compatible-card.not-collected {
            opacity: 0.5;
            cursor: default;
        }

        .echo-compatible-card.not-collected:hover {
            border-color: #e5e7eb;
            transform: none;
        }

        .echo-card-icon {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            color: white;
        }

        .echo-card-info { flex: 1; }
        .echo-card-name { font-size: 14px; font-weight: 600; color: #1f2937; }
        .echo-card-meta { font-size: 12px; color: #6b7280; margin-top: 2px; }

        .echo-card-status {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 20px;
            flex-shrink: 0;
        }

        .echo-card-status.collected {
            background: #ECFDF5;
            color: #059669;
        }

        .echo-card-status.locked {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .echo-empty {
            text-align: center;
            padding: 32px 16px;
            color: #9ca3af;
            font-size: 14px;
        }

        .collection-detail { display: none; }
        .collection-detail.show { display: block; }

        .back-btn {
            background: none;
            border: none;
            color: #4F46E5;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 16px;
            padding: 8px 0;
        }

        .collection-detail-header { margin-bottom: 24px; }
        .collection-detail-title { font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .collection-detail-desc { color: #6b7280; margin-bottom: 12px; }

        .cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .card-item {
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .card-item:hover { transform: scale(1.05); }
        .card-item.collected { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; }
        .card-item.locked { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .card-item.locked:hover { transform: none; }

        .card-icon {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 8px;
        }

        .card-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .card-type { font-size: 12px; opacity: 0.8; }

        .card-detail-view {
            display: none;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 300;
            flex-direction: column;
        }

        .card-detail-view.show { display: flex; }

        .card-detail-header {
            background: #4F46E5;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .card-detail-title-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-detail-dust-display {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .card-detail-back {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .card-detail-body { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding-bottom: max(0px, env(safe-area-inset-bottom)); }

        .card-display {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 480px;
        }

        @media (max-width: 480px) {
            .card-display { padding: 16px; min-height: 380px; }
        }

        .card-frame {
            background: white;
            border-radius: 16px;
            padding: 16px;
            width: 100%;
            max-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            min-height: 420px;
        }

        @media (max-width: 480px) {
            .card-frame { max-width: 220px; padding: 12px; border-radius: 12px; min-height: 300px; }
        }

        .card-rarity-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #F59E0B;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .card-category-badge {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            color: #92400E;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 12px;
        }

        .card-art-area {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border-radius: 12px;
            min-height: 390px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 16px;
            position: relative;
            padding: 16px;
            padding-top: 90px;
        }

        @media (max-width: 480px) {
            .card-art-area { min-height: 300px; margin-bottom: 12px; padding-top: 75px; }
        }

        .card-art-title {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #1f2937;
            border-radius: 12px;
            padding: 8px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            max-width: calc(100% - 32px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        @media (max-width: 480px) {
            .card-art-title { font-size: 15px; padding: 6px 16px; }
        }

        .card-art-placeholder { font-size: 80px; }

        @media (max-width: 480px) {
            .card-art-placeholder { font-size: 60px; }
        }

        .card-footer {
            margin-top: auto;
            text-align: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            position: relative;
        }

        .card-level-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .card-level-label { font-size: 14px; font-weight: 600; color: #1f2937; }

        .card-exp-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .card-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #A855F7 0%, #7C3AED 100%);
            transition: width 0.3s ease;
        }

        .card-level-up-btn {
            width: 100%;
            background: linear-gradient(135deg, #A855F7 0%, #7C3AED 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: transform 0.2s;
        }

        .card-level-up-btn:hover { transform: scale(1.05); }
        .card-level-up-btn:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }

        .rarity-gem {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gem-triangle { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 26px solid; }
        .gem-pentagon { width: 20px; height: 18px; position: relative; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .gem-hexagon { width: 24px; height: 24px; clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); }

        .card-dialogue-bubble {
            display: none;
            position: absolute;
            top: calc(50% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 3px solid #1f2937;
            border-radius: 16px;
            padding: 12px 16px;
            max-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            animation: bubblePop 0.3s ease;
        }

        .card-dialogue-bubble.show { display: block; }

        .card-dialogue-bubble::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #1f2937;
        }

        .card-dialogue-text { font-size: 13px; color: #1f2937; line-height: 1.4; text-align: center; }

        @keyframes bubblePop {
            0% { opacity: 0; transform: translateX(-50%) scale(0.8); }
            100% { opacity: 1; transform: translateX(-50%) scale(1); }
        }

        .card-supertype-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid white;
            z-index: 2;
        }
        .card-supertype-badge2 {
            position: absolute;
            top: -10px;
            right: 28px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid white;
            z-index: 1;
        }

        .card-tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .card-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 4px;
            font-size: 14px;
            font-weight: bold;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 70px;
        }

        .card-tab.journal-tab {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            margin: 0 2px;
            position: relative;
        }

        .card-tab.journal-tab .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes levelUpPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(168, 85, 247, 0.8); }
            100% { transform: scale(1); }
        }

        .card-tab.journal-tab:hover { background: linear-gradient(135deg, #D97706 0%, #B45309 100%); }

        .card-tab.studio-tab {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            margin: 0 2px;
        }

        .card-tab.studio-tab:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); }

        .card-tab.studio-tab.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border-bottom-color: transparent;
        }

        .card-tab.active { color: #4F46E5; border-bottom-color: #4F46E5; background: white; font-size: 12px; }

        .card-tab.journal-tab.active {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            border-bottom-color: transparent;
        }

        .card-tab:hover { background: #f9fafb; }

        .tab-content { display: none; padding: 20px; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }
        .tab-content p { color: #6b7280; line-height: 1.6; margin-bottom: 12px; }

        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; }
        .info-label { font-weight: 600; color: #374151; }
        .info-value { color: #6b7280; }

        .journal-screen {
            display: none;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 400;
            flex-direction: column;
        }

        .journal-screen.show { display: flex; }

        .journal-screen-header {
            background: #4F46E5;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .journal-screen-back {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .journal-screen-card-mini { display: flex; align-items: center; gap: 12px; flex: 1; }

        .journal-screen-card-image {
            width: 50px;
            height: 70px;
            background: linear-gradient(135deg, #818CF8 0%, #6366F1 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .journal-screen-card-info h3 { font-size: 16px; font-weight: bold; margin: 0; }
        .journal-screen-card-info p { font-size: 13px; margin: 2px 0 0 0; opacity: 0.9; }

        .journal-screen-body { flex: 1; overflow-y: auto; background: #f9fafb; }
        .journal-screen-content { padding: 16px; }

        .journal-notebook {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            background-image: repeating-linear-gradient(transparent, transparent 30px, #F59E0B 30px, #F59E0B 31px);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .journal-level-overlay {
            position: absolute;
            left: 0;
            right: 0;
            height: 0%;
            overflow: hidden;
            opacity: 0.45;
            transition: height 1.3s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
            z-index: 3;
        }
        #journalLevelOverlay1 { top: 0%;      border-radius: 10px 10px 0 0; }
        #journalLevelOverlay2 { top: 33.33%;  border-radius: 0; }
        #journalLevelOverlay3 { top: 66.66%;  border-radius: 0 0 10px 10px; }

        .journal-notebook > *:not(.journal-level-overlay) { position: relative; z-index: 2; }

        .journal-screen-footer {
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 16px;
        }

        .journal-inventory-title { font-size: 14px; font-weight: 600; color: #1f2937; margin-bottom: 12px; text-align: center; }

        .joystick-container {
            position: absolute;
            bottom: 180px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 15;
        }

        .joystick-base {
            width: 120px;
            height: 120px;
            background: rgba(79, 70, 229, 0.3);
            border: 3px solid rgba(79, 70, 229, 0.5);
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }

        .joystick-stick {
            width: 50px;
            height: 50px;
            background: #4F46E5;
            border: 3px solid white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            touch-action: none;
        }

        .gps-toggle {
            position: absolute;
            bottom: 180px;
            right: 20px;
            z-index: 15;
        }

        /* Studio button on map */
        .studio-map-btn-container {
            position: absolute;
            bottom: 250px;
            right: 20px;
            z-index: 15;
        }

        .studio-map-btn {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16,185,129,0.4);
            transition: all 0.2s;
        }

        .studio-map-btn:active { transform: scale(0.95); }

        .echo-orb {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: grab;
            transition: transform 0.2s;
            position: relative;
        }

        .echo-orb:hover { transform: scale(1.1); }
        .echo-orb.dragging { opacity: 0.5; cursor: grabbing; }

        .supertype-histoire { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
        .supertype-nature { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .supertype-science { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }
        .supertype-arts { background: linear-gradient(135deg, #EC4899 0%, #BE185D 100%); }
        .supertype-societe { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }

        .card-supertype-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid white; z-index: 2;
        }
        .card-supertype-badge2 {
            position: absolute;
            top: -10px; right: 28px;
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid white; z-index: 1;
        }

        .echo-slot {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px dashed #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.5);
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .echo-slot.filled { border-style: solid; border-width: 3px; }
        .echo-slot.drag-over { border-color: #4F46E5; background: rgba(79, 70, 229, 0.1); transform: scale(1.1); }

        .echo-slot-content {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .unlocked-content {
            background: rgba(147, 197, 253, 0.2);
            border: 2px solid #3B82F6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            animation: unlockFade 0.6s ease;
        }

        .unlocked-content-text { font-size: 13px; color: #1e40af; font-family: 'Courier New', monospace; font-style: italic; }

        @keyframes unlockFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .journal-item-with-slot { display: flex; gap: 12px; margin-bottom: 16px; align-items: flex-start; position: relative; }
        .journal-content-wrapper { flex: 1; }

        .echo-inventory {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            flex-wrap: wrap;
            min-height: 80px;
        }

        .echo-inventory-item { position: relative; }

        .echo-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .journal-quote {
            font-family: 'Courier New', monospace;
            font-style: italic;
            color: #78350F;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .journal-item { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; }

        .journal-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            flex-shrink: 0;
        }

        .journal-date { font-size: 12px; font-weight: 600; color: #92400E; margin-bottom: 4px; }
        .journal-text { font-size: 14px; color: #78350F; font-family: 'Courier New', monospace; }

        .journal-interaction-btn { animation: fadeIn 0.6s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) scale(0.8); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }

        .interaction-button {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .interaction-button:hover { border-color: #4F46E5; transform: scale(1.1); }
        .interaction-button.locked { background: #f3f4f6; opacity: 0.5; cursor: not-allowed; }
        .interaction-button.locked:hover { transform: none; border-color: #e5e7eb; }

        /* ==================== MISE AU POINT ==================== */

        .mapoint-screen {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 500;
            background: black;
            overflow: hidden;
        }

        .mapoint-screen.active { display: block; }

        #mapointCanvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        .mapoint-ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 60px;
            gap: 20px;
        }

        .mapoint-hint {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            text-align: center;
            padding: 8px 20px;
            background: rgba(0,0,0,0.35);
            border-radius: 20px;
            letter-spacing: 0.3px;
            transition: opacity 0.5s;
        }

        .mapoint-progress-ring {
            width: 80px;
            height: 80px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mapoint-progress-ring.visible { opacity: 1; }

        #mapointRing {
            transition: stroke-dashoffset 0.05s linear, stroke 0.3s;
        }

        .hidden { display: none !important; }

        /* ==================== STUDIO ==================== */

        /* ==================== STUDIO ==================== */
        .studio-screen {
            display: none; position: absolute; inset: 0;
            background: #1a0f2e; z-index: 400; flex-direction: column;
        }
        .studio-screen.show { display: flex; }

        .studio-header {
            background: linear-gradient(135deg, #2d1040 0%, #1a0f2e 100%);
            border-bottom: 1px solid rgba(255,200,80,0.2);
            color: white; padding: 12px 16px;
            display: flex; align-items: center; gap: 12px; flex-shrink: 0;
        }
        .studio-back { background: none; border: none; color: rgba(255,200,80,0.9); font-size: 22px; cursor: pointer; padding: 0; line-height: 1; }
        .studio-header-info { flex: 1; display: flex; flex-direction: column; }
        .studio-title { font-size: 15px; font-weight: 800; letter-spacing: 0.5px; color: rgba(255,220,120,0.95); }
        .studio-card-name { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 1px; }
        .studio-dust-display {
            background: rgba(255,200,80,0.15); border: 1px solid rgba(255,200,80,0.3);
            padding: 5px 10px; border-radius: 20px;
            display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 700; color: #ffd050;
        }

        .studio-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        .studio-room-wrapper {
            flex: 1; min-height: 0;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
            background: radial-gradient(ellipse at 50% 25%, #1a1035 0%, #0d0820 60%, #060412 100%);
        }
        .studio-scene {
            transform-origin: top center;
        }
        @media (max-height: 700px) {
            .studio-scene { transform: scale(0.82); }
        }
        @media (max-height: 600px) {
            .studio-scene { transform: scale(0.68); }
        }

        /* Ambient light orb */
        .studio-room-wrapper::before {
            content: ''; position: absolute;
            width: 200px; height: 200px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,180,40,0.12) 0%, transparent 70%);
            top: 10%; left: 50%; transform: translateX(-50%);
            pointer-events: none;
        }

        .studio-scene {
            position: relative; width: 400px; height: 370px;
        }

        /* ---- TOOLTIP ---- */
        .studio-tooltip {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #1e1035 0%, #120828 100%);
            border-top: 2px solid rgba(255,180,40,0.5);
            padding: 14px 16px; display: flex; align-items: center; gap: 12px;
            z-index: 50; animation: slideUp 0.25s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to   { transform: translateY(0);    opacity: 1; }
        }
        .tooltip-icon { font-size: 30px; flex-shrink: 0; }
        .tooltip-content { flex: 1; }
        .tooltip-name { font-size: 14px; font-weight: 700; color: #ffd050; margin-bottom: 3px; }
        .tooltip-desc { font-size: 12px; color: rgba(255,255,255,0.6); line-height: 1.4; }
        .tooltip-close {
            background: rgba(255,200,80,0.1); border: 1px solid rgba(255,200,80,0.2);
            color: #ffd050; width: 28px; height: 28px;
            border-radius: 50%; cursor: pointer; font-size: 14px; flex-shrink: 0;
        }

        /* Studio items — SVG-based, positioned absolutely */
        .studio-item {
            position: absolute; cursor: pointer;
            transition: filter 0.2s, transform 0.2s;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.7));
        }
        .studio-item:hover { filter: drop-shadow(0 8px 16px rgba(0,0,0,0.8)) brightness(1.15); transform: translateY(-3px); }
        .studio-item svg { display: block; }

        /* Glow outline for interactive items (bookshelf, arch) */
        #item-bookshelf polygon, #item-arch ellipse { transition: stroke 0.2s, stroke-width 0.2s; }
        #item-bookshelf:hover polygon { stroke: rgba(255,220,80,0.0); }  

        /* SVG group hover glow via outline stroke */
        .studio-nav-item { cursor: pointer; }
        .studio-nav-item .nav-glow-ring { 
            opacity: 0; 
            transition: opacity 0.25s ease;
        }
        .studio-nav-item:hover .nav-glow-ring { opacity: 1; }

        /* Glow animations */
        .lamp-glow-anim { animation: lampFlicker 3s ease-in-out infinite; }
        .window-glow-anim { animation: windowPulse 4s ease-in-out infinite; }
        @keyframes lampFlicker {
            0%,100% { opacity: 0.8; } 40% { opacity: 1; } 60% { opacity: 0.7; }
        }
        @keyframes windowPulse {
            0%,100% { opacity: 0.6; } 50% { opacity: 1; }
        }

        /* ---- SHOP BAR ---- */
        /* ---- SHOP BAR ---- */
        .studio-shop {
            background: rgba(5,2,15,0.92);
            border-top: 2px solid rgba(255,200,80,0.25);
            padding: 10px 12px;
            padding-bottom: max(14px, env(safe-area-inset-bottom, 14px));
            flex-shrink: 0;
            position: relative;
            z-index: 20;
        }

        .studio-shop-title {
            font-size: 10px;
            font-weight: 700;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .studio-shop-items {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .studio-shop-items::-webkit-scrollbar { height: 3px; }
        .studio-shop-items::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .studio-shop-items::-webkit-scrollbar-thumb { background: rgba(255,200,80,0.3); border-radius: 2px; }

        .shop-item {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 8px 10px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s, border-color 0.2s;
            min-width: 64px;
        }

        .shop-item:hover {
            background: rgba(16,185,129,0.2);
            border-color: #10B981;
        }

        .shop-item.owned {
            background: rgba(16,185,129,0.15);
            border-color: #10B981;
            cursor: default;
        }

        .shop-item-icon { font-size: 24px; margin-bottom: 3px; }
        .shop-item-name { font-size: 10px; color: rgba(255,255,255,0.7); font-weight: 600; margin-bottom: 2px; }
        .shop-item-price { font-size: 10px; color: #A78BFA; font-weight: 700; }
        .shop-item.owned .shop-item-price { color: #10B981; }

        /* ==================== PROGRESSION SYSTEM ==================== */

        /* Avatar menu XP mini bar */
        .avatar-menu-xp {
            padding: 10px 16px 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        .avatar-menu-xp-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .avatar-menu-rank {
            font-size: 13px;
            font-weight: 800;
            color: #4F46E5;
        }
        .avatar-menu-level {
            font-size: 11px;
            font-weight: 700;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 20px;
        }
        .avatar-menu-xp-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        .avatar-menu-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4F46E5 0%, #7C3AED 100%);
            border-radius: 3px;
            transition: width 0.4s cubic-bezier(0.34,1.56,0.64,1);
        }
        .avatar-menu-xp-label {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 4px;
            text-align: right;
        }

        /* Progression Screen */
        .progression-screen {
            display: none;
            position: absolute;
            inset: 0;
            background: #0f0a1e;
            z-index: 450;
            flex-direction: column;
            overflow: hidden;
        }
        .progression-screen.show { display: flex; }

        .prog-header {
            background: linear-gradient(135deg, #1a0f2e 0%, #0f0a1e 100%);
            border-bottom: 1px solid rgba(139,92,246,0.3);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .prog-back {
            background: none;
            border: none;
            color: rgba(167,139,250,0.9);
            font-size: 22px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .prog-header-info { flex: 1; }
        .prog-header-title {
            font-size: 16px;
            font-weight: 800;
            color: #e9d5ff;
            letter-spacing: 0.3px;
        }
        .prog-header-subtitle {
            font-size: 11px;
            color: rgba(167,139,250,0.6);
            margin-top: 1px;
        }

        /* Player rank card */
        .prog-player-card {
            background: linear-gradient(135deg, #1e1035 0%, #160c28 100%);
            border-bottom: 1px solid rgba(139,92,246,0.2);
            padding: 18px 16px;
            flex-shrink: 0;
        }
        .prog-player-top {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }
        .prog-avatar-ring {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            border: 3px solid rgba(139,92,246,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 0 20px rgba(139,92,246,0.4);
            flex-shrink: 0;
            position: relative;
        }
        .prog-avatar-level-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #F59E0B;
            color: white;
            font-size: 10px;
            font-weight: 800;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #0f0a1e;
        }
        .prog-player-info { flex: 1; }
        .prog-player-rank {
            font-size: 18px;
            font-weight: 900;
            color: #e9d5ff;
            letter-spacing: 0.3px;
        }
        .prog-player-title {
            font-size: 12px;
            color: rgba(167,139,250,0.7);
            margin-top: 2px;
        }
        .prog-player-xp-total {
            font-size: 11px;
            color: #A78BFA;
            font-weight: 700;
            margin-top: 4px;
        }
        .prog-xp-bar-wrap { position: relative; }
        .prog-xp-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: rgba(167,139,250,0.6);
            margin-bottom: 5px;
        }
        .prog-xp-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.07);
            border-radius: 5px;
            overflow: hidden;
        }
        .prog-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #6D28D9 0%, #A855F7 60%, #C084FC 100%);
            border-radius: 5px;
            transition: width 0.6s cubic-bezier(0.34,1.56,0.64,1);
            position: relative;
        }
        .prog-xp-fill::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 20px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35));
            border-radius: 5px;
            animation: xpShine 2s ease-in-out infinite;
        }
        @keyframes xpShine {
            0%,100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Tabs */
        .prog-tabs {
            display: flex;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(139,92,246,0.15);
            flex-shrink: 0;
        }
        .prog-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 11px 4px;
            font-size: 12px;
            font-weight: 700;
            color: rgba(167,139,250,0.5);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        .prog-tab.active {
            color: #C084FC;
            border-bottom-color: #A855F7;
        }

        .prog-body { flex: 1; overflow-y: auto; }

        /* ---- BATTLEPASS TRACK ---- */
        .battlepass-track {
            padding: 16px;
        }
        .battlepass-season-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(167,139,250,0.5);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 14px;
            text-align: center;
        }
        .bp-node-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 0;
        }
        .bp-connector {
            width: 3px;
            height: 20px;
            background: rgba(255,255,255,0.08);
            margin: 0 auto;
            display: block;
            transition: background 0.3s;
        }
        .bp-connector.done { background: linear-gradient(180deg, #A855F7, #7C3AED); }

        .bp-node {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            transition: all 0.3s;
            position: relative;
        }
        .bp-node.done {
            background: linear-gradient(135deg, #6D28D9, #A855F7);
            border-color: #C084FC;
            box-shadow: 0 0 12px rgba(168,85,247,0.4);
        }
        .bp-node.current {
            background: rgba(168,85,247,0.2);
            border-color: #A855F7;
            box-shadow: 0 0 16px rgba(168,85,247,0.5);
            animation: currentPulse 2s ease-in-out infinite;
        }
        .bp-node.locked {
            opacity: 0.4;
        }
        @keyframes currentPulse {
            0%,100% { box-shadow: 0 0 16px rgba(168,85,247,0.5); }
            50% { box-shadow: 0 0 28px rgba(168,85,247,0.8); }
        }
        .bp-node-num {
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 9px;
            font-weight: 800;
            color: rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 1px 4px;
            line-height: 1.4;
        }
        .bp-node.done .bp-node-num { color: #C084FC; }

        .bp-reward-card {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .bp-reward-card.done {
            background: rgba(109,40,217,0.12);
            border-color: rgba(168,85,247,0.25);
        }
        .bp-reward-icon { font-size: 22px; flex-shrink: 0; }
        .bp-reward-info { flex: 1; }
        .bp-reward-name { font-size: 13px; font-weight: 700; color: #e9d5ff; }
        .bp-reward-type { font-size: 10px; color: rgba(167,139,250,0.55); margin-top: 1px; }
        .bp-reward-status {
            font-size: 10px;
            font-weight: 700;
            color: #10B981;
            flex-shrink: 0;
        }
        .bp-reward-status.locked { color: rgba(255,255,255,0.2); }
        .bp-reward-status.current { color: #F59E0B; }

        /* Milestone paliers */
        .bp-milestone {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05));
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 12px;
            padding: 12px 14px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .bp-milestone-icon { font-size: 26px; flex-shrink: 0; }
        .bp-milestone-info { flex: 1; }
        .bp-milestone-name { font-size: 14px; font-weight: 800; color: #FCD34D; }
        .bp-milestone-desc { font-size: 11px; color: rgba(252,211,77,0.6); margin-top: 2px; }
        .bp-milestone-badge {
            background: rgba(245,158,11,0.2);
            border: 1px solid rgba(245,158,11,0.4);
            color: #FCD34D;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
        }

        /* ---- ACHIEVEMENTS ---- */
        .achievements-list { padding: 14px; }

        .achievement-category {
            margin-bottom: 20px;
        }
        .achievement-cat-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(167,139,250,0.5);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 10px;
            padding-left: 4px;
        }
        .achievement-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }
        .achievement-item.unlocked {
            background: rgba(16,185,129,0.08);
            border-color: rgba(16,185,129,0.25);
        }
        .achievement-item.in-progress {
            background: rgba(79,70,229,0.08);
            border-color: rgba(79,70,229,0.2);
        }
        .achievement-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            position: relative;
        }
        .achievement-item.unlocked .achievement-icon {
            background: rgba(16,185,129,0.15);
        }
        .achievement-check {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: #10B981;
            border-radius: 50%;
            border: 2px solid #0f0a1e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: white;
            font-weight: 800;
        }
        .achievement-info { flex: 1; min-width: 0; }
        .achievement-name {
            font-size: 14px;
            font-weight: 700;
            color: #e9d5ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .achievement-item.unlocked .achievement-name { color: #6EE7B7; }
        .achievement-desc {
            font-size: 11px;
            color: rgba(167,139,250,0.5);
            margin-top: 2px;
        }
        .achievement-progress-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
        }
        .achievement-prog-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.07);
            border-radius: 2px;
            overflow: hidden;
        }
        .achievement-prog-fill {
            height: 100%;
            background: linear-gradient(90deg, #4F46E5, #7C3AED);
            border-radius: 2px;
        }
        .achievement-item.unlocked .achievement-prog-fill { background: #10B981; }
        .achievement-prog-label {
            font-size: 10px;
            color: rgba(167,139,250,0.5);
            font-weight: 600;
            flex-shrink: 0;
        }
        .achievement-xp {
            font-size: 11px;
            font-weight: 700;
            color: #A78BFA;
            flex-shrink: 0;
            text-align: right;
        }
        .achievement-item.unlocked .achievement-xp { color: #6EE7B7; }

        /* Unlock toast for achievements */
        .achievement-toast {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: linear-gradient(135deg, #1e1035 0%, #120828 100%);
            border: 1px solid rgba(16,185,129,0.5);
            border-radius: 14px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 20px rgba(16,185,129,0.2);
            min-width: 260px;
            animation: achieveSlideDown 0.4s cubic-bezier(0.34,1.56,0.64,1);
            pointer-events: none;
        }
        @keyframes achieveSlideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.9); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }
        .achievement-toast-icon { font-size: 26px; flex-shrink: 0; }
        .achievement-toast-text { flex: 1; }
        .achievement-toast-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #10B981;
        }
        .achievement-toast-name {
            font-size: 14px;
            font-weight: 800;
            color: #e9d5ff;
            margin-top: 1px;
        }
        .achievement-toast-xp {
            font-size: 11px;
            color: #A78BFA;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Level-up overlay */
        .levelup-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15,10,30,0.85);
            z-index: 800;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .levelup-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        .levelup-burst {
            font-size: 64px;
            animation: levelBurst 0.6s cubic-bezier(0.34,1.56,0.64,1);
        }
        @keyframes levelBurst {
            0% { transform: scale(0) rotate(-20deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .levelup-text {
            font-size: 28px;
            font-weight: 900;
            color: #e9d5ff;
            text-align: center;
            letter-spacing: 1px;
        }
        .levelup-rank {
            font-size: 16px;
            font-weight: 700;
            color: #A78BFA;
        }
        .levelup-xp {
            font-size: 14px;
            color: #FCD34D;
            font-weight: 700;
        }
        .levelup-close {
            margin-top: 8px;
            background: rgba(168,85,247,0.2);
            border: 1px solid rgba(168,85,247,0.4);
            color: #C084FC;
            padding: 10px 28px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            pointer-events: all;
        }

        /* HUD XP bar */
        .hud-xp-bar {
            position: absolute;
            top: 70px;
            left: 14px;
            right: 14px;
            z-index: 30;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .hud-xp-pill {
            flex: 1;
            height: 5px;
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
            overflow: hidden;
            backdrop-filter: blur(4px);
        }
        .hud-xp-pill-fill {
            height: 100%;
            background: linear-gradient(90deg, #6D28D9, #A855F7, #C084FC);
            border-radius: 3px;
            transition: width 0.5s cubic-bezier(0.34,1.56,0.64,1);
        }
        .hud-xp-level-label {
            font-size: 10px;
            font-weight: 800;
            color: rgba(255,255,255,0.85);
            background: rgba(109,40,217,0.6);
            backdrop-filter: blur(4px);
            padding: 2px 7px;
            border-radius: 10px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div id="mainApp" class="app-container">
        <!-- Top HUD overlay (no header bar, overlaid on map) -->
        <div class="map-hud">
            <!-- Avatar button (top-left) -->
            <div class="hud-avatar-wrap">
                <button class="hud-avatar-btn" onclick="toggleAvatarMenu()" id="avatarBtn">
                    <span class="avatar-emoji">🧙</span>
                </button>
                <!-- Dropdown menu -->
                <div class="avatar-menu hidden" id="avatarMenu">
                    <div class="avatar-menu-name">Lyon Cards</div>
                    <!-- Mini XP display -->
                    <div class="avatar-menu-xp">
                        <div class="avatar-menu-xp-top">
                            <span class="avatar-menu-rank" id="menuRankName">Novice</span>
                            <span class="avatar-menu-level" id="menuLevelBadge">Nv. 1</span>
                        </div>
                        <div class="avatar-menu-xp-bar">
                            <div class="avatar-menu-xp-fill" id="menuXpFill" style="width:0%"></div>
                        </div>
                        <div class="avatar-menu-xp-label" id="menuXpLabel">0 / 100 XP</div>
                    </div>
                    <button class="avatar-menu-item" onclick="closeAvatarMenu(); openProgressionScreen()">
                        <span>🗺️</span> Progression
                    </button>
                    <button class="avatar-menu-item" onclick="closeAvatarMenu(); openCollections()">
                        <span>📦</span> Collections
                    </button>
                    <button class="avatar-menu-item" onclick="closeAvatarMenu(); openStudioFromMap()">
                        <span>🏠</span> Studio
                    </button>
                    <button class="avatar-menu-item avatar-menu-item--disabled">
                        <span>🛒</span> Magasin <span class="soon-badge">Bientôt</span>
                    </button>
                </div>
            </div>
            <!-- Dust counter (top-right) -->
            <div class="hud-dust">
                <svg width="22" height="22" viewBox="0 0 24 24" style="display:inline-block;vertical-align:middle" xmlns="http://www.w3.org/2000/svg"><ellipse cx="12" cy="19" rx="9" ry="3" fill="#c084fc" opacity="0.7"/><path d="M5,18 Q7,10 12,7 Q17,10 19,18 Z" fill="#a855f7"/><circle cx="9" cy="14" r="1.2" fill="rgba(255,255,255,0.7)"/><circle cx="13" cy="11" r="1" fill="rgba(255,255,255,0.6)"/><circle cx="15" cy="15" r="0.9" fill="rgba(255,255,255,0.5)"/></svg>
                <span id="dustCounter">0</span>
            </div>
        </div>

        <!-- HUD XP bar -->
        <div class="hud-xp-bar" id="hudXpBar">
            <div class="hud-xp-level-label" id="hudXpLevel">Nv.1</div>
            <div class="hud-xp-pill">
                <div class="hud-xp-pill-fill" id="hudXpFill" style="width:0%"></div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Joystick -->
        <div class="joystick-container">
            <div class="joystick-base" id="joystickBase">
                <div class="joystick-stick" id="joystickStick"></div>
            </div>
        </div>

        <!-- GPS Toggle -->
        <div class="gps-toggle">
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-hint">Utilisez les flèches ← ↑ → ↓ pour vous déplacer</div>

            <div id="nearbyPOI" class="nearby-poi hidden">
                <div class="nearby-poi-header">
                    <div>
                        <div class="nearby-poi-name" id="poiName"></div>
                        <div class="nearby-poi-distance">À portée de collecte!</div>
                    </div>
                </div>
                <button onclick="collectCard()" class="collect-btn">Collecter la carte</button>
            </div>

            <div id="nearbyDust" class="nearby-poi hidden" style="background: #F3E8FF; border-color: #A855F7;">
                <div class="nearby-poi-header">
                    <div>
                        <div class="nearby-poi-name" style="color: #7C3AED;"><svg width="22" height="22" viewBox="0 0 24 24" style="display:inline-block;vertical-align:middle" xmlns="http://www.w3.org/2000/svg"><ellipse cx="12" cy="19" rx="9" ry="3" fill="#c084fc" opacity="0.7"/><path d="M5,18 Q7,10 12,7 Q17,10 19,18 Z" fill="#a855f7"/><circle cx="9" cy="14" r="1.2" fill="rgba(255,255,255,0.7)"/><circle cx="13" cy="11" r="1" fill="rgba(255,255,255,0.6)"/><circle cx="15" cy="15" r="0.9" fill="rgba(255,255,255,0.5)"/></svg> Poudre mémorielle</div>
                        <div class="nearby-poi-distance" style="color: #9333EA;">À portée de collecte!</div>
                    </div>
                </div>
                <button onclick="collectDust()" class="collect-btn" style="background: #A855F7;">Collecter la poudre</button>
            </div>

            <div id="nearbyEcho" class="nearby-poi hidden" style="background: #F3E8FF; border-color: #A855F7;">
                <div class="nearby-poi-header">
                    <div>
                        <div class="nearby-poi-name" style="color: #7C3AED;" id="echoName">✨ Écho</div>
                        <div class="nearby-poi-distance" style="color: #9333EA;">À portée de collecte!</div>
                    </div>
                </div>
                <button onclick="collectEcho()" class="collect-btn" style="background: #A855F7;">Collecter l'écho</button>
            </div>
        </div>

        <!-- Mise au Point Screen -->
        <div id="miseAuPointScreen" class="mapoint-screen">
            <canvas id="mapointCanvas"></canvas>
            <div class="mapoint-ui">
                <div class="mapoint-hint" id="mapointHint">Déplacez doucement votre doigt pour accorder</div>
                <div class="mapoint-progress-ring">
                    <svg viewBox="0 0 80 80" id="mapointRingSvg">
                        <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="4"/>
                        <circle cx="40" cy="40" r="34" fill="none" stroke="white" stroke-width="4"
                            stroke-dasharray="213.6" stroke-dashoffset="213.6"
                            stroke-linecap="round" id="mapointRing"
                            transform="rotate(-90 40 40)"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Card Popup -->
        <div id="cardPopup" class="card-success-toast">
            <div class="toast-glow" id="toastGlow"></div>
            <div class="toast-inner">
                <div class="toast-clickable" onclick="openRevealedCard()">
                    <div class="toast-icon">🎴</div>
                    <div class="toast-text">
                        <div class="toast-label">Carte révélée ✦ <span class="toast-tap-hint">Appuyer pour voir</span></div>
                        <div class="toast-name" id="popupCardName"></div>
                        <div class="toast-type" id="popupCardType"></div>
                    </div>
                    <div class="toast-arrow">›</div>
                </div>
                <button class="toast-close" onclick="closeCardPopup()">✕</button>
            </div>
        </div>

        <!-- Collections Panel -->
        <div id="collectionsPanel" class="collections-panel">
            <div class="collections-header">
                <h2 class="collections-title">Mes Collections</h2>
                <button onclick="closeCollections()" class="close-btn">✕</button>
            </div>
            <!-- Tabs -->
            <div class="col-tabs">
                <button class="col-tab active" id="colTabCollections" onclick="switchColTab('collections')">🎴 Cartes</button>
                <button class="col-tab" id="colTabEchoes" onclick="switchColTab('echoes')"><span id="echoTabIcon" style="display:inline-flex;align-items:center;vertical-align:middle;margin-right:2px;"><svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="7" cy="12" r="3" fill="currentColor"/><path d="M13,6 Q19,12 13,18" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/><path d="M17,3 Q25,12 17,21" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.55"/></svg></span> Échos</button>
            </div>
            <div class="collections-content">
                <!-- COLLECTIONS TAB -->
                <div id="colPaneCollections">
                    <div id="collectionsList"></div>
                    <div id="collectionDetail" class="collection-detail">
                        <button onclick="backToCollections()" class="back-btn">← Retour</button>
                        <div class="collection-detail-header">
                            <h3 class="collection-detail-title" id="detailTitle"></h3>
                            <p class="collection-detail-desc" id="detailDesc"></p>
                            <span class="collection-badge" id="detailBadge"></span>
                        </div>
                        <div class="cards-grid" id="cardsGrid"></div>
                    </div>
                </div>
                <!-- ECHOES TAB -->
                <div id="colPaneEchoes" class="hidden">
                    <div id="echoesPanel"></div>
                </div>
            </div>
        </div>

        <!-- Card Detail View -->
        <div id="cardDetailView" class="card-detail-view">
            <div class="card-detail-header">
                <div class="card-detail-title-section">
                    <h2 class="collections-title" id="cardDetailHeaderTitle"></h2>
                    <div class="card-detail-dust-display">
                        <svg width="22" height="22" viewBox="0 0 24 24" style="display:inline-block;vertical-align:middle" xmlns="http://www.w3.org/2000/svg"><ellipse cx="12" cy="19" rx="9" ry="3" fill="#c084fc" opacity="0.7"/><path d="M5,18 Q7,10 12,7 Q17,10 19,18 Z" fill="#a855f7"/><circle cx="9" cy="14" r="1.2" fill="rgba(255,255,255,0.7)"/><circle cx="13" cy="11" r="1" fill="rgba(255,255,255,0.6)"/><circle cx="15" cy="15" r="0.9" fill="rgba(255,255,255,0.5)"/></svg>
                        <span id="cardDetailDustCounter">0</span>
                    </div>
                </div>
            </div>
            <div class="card-detail-body">
                <div class="card-display" onclick="closeCardDetail()" style="cursor: pointer;">
                    <div class="card-frame" onclick="event.stopPropagation()" style="cursor: pointer; position: relative;">
                        <div class="card-dialogue-bubble" id="cardDialogueBubble">
                            <div class="card-dialogue-text" id="cardDialogueText"></div>
                        </div>
                        <div class="card-supertype-badge2 hidden" id="cardSupertypeBadge2"></div><div class="card-supertype-badge" id="cardSupertypeBadge">🏛️</div>
                        <div class="card-category-badge" id="cardCategory">Personnage</div>
                        <div class="card-art-area">
                            <div class="card-art-placeholder" onclick="showCardDialogue()">👤</div>
                            <div class="card-art-title" id="cardDetailName">Marie Curie</div>
                            <div class="card-footer">
                                <div class="rarity-gem" id="cardRarityGem"></div>
                                <div class="card-level-info">
                                    <span class="card-level-label" id="cardLevelDisplay">Niveau 1</span>
                                    <span class="card-level-label" id="cardExpDisplay">0/10 ✦</span>
                                </div>
                                <div class="card-exp-bar">
                                    <div class="card-exp-fill" id="cardExpBar" style="width: 0%"></div>
                                </div>
                                <button id="addExpBtn" class="card-level-up-btn" onclick="addExperience()" disabled>
                                    Ajouter 50 poudre (+EXP)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-tabs">
                    <button class="card-tab active" onclick="switchTab('general', event)">Général</button>
                    <button class="card-tab" onclick="switchTab('skins', event)">Skins</button>
                    <button class="card-tab" onclick="switchTab('competences', event)">Skills</button>
                    <button class="card-tab journal-tab" onclick="openJournalScreen()" id="journalTabBtn">
                        📖 Carnet
                        <span class="notification-badge hidden" id="journalNotification">!</span>
                    </button>
                </div>

                <div id="generalTab" class="tab-content active">
                    <div class="info-row"><span class="info-label">Naissance</span><span class="info-value">7 novembre 1867</span></div>
                    <div class="info-row"><span class="info-label">Décès</span><span class="info-value">4 juillet 1934</span></div>
                    <div class="info-row"><span class="info-label">Nationalité</span><span class="info-value">Polonaise, Française</span></div>
                    <div class="info-row"><span class="info-label">Conjoint</span><span class="info-value">Pierre Curie</span></div>
                    <p style="margin-top: 20px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                </div>

                <div id="skinsTab" class="tab-content">
                    <h3 style="margin-bottom: 16px; color: #1f2937;">Apparences disponibles</h3>
                    <div class="info-row"><span class="info-label">Skin 1</span><span class="info-value">Tenue de laboratoire</span></div>
                    <div class="info-row"><span class="info-label">Skin 2</span><span class="info-value">Tenue de cérémonie</span></div>
                    <p style="margin-top: 20px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                </div>

                <div id="competencesTab" class="tab-content">
                    <h3 style="margin-bottom: 16px; color: #1f2937;">Compétences à débloquer</h3>
                    <div class="info-row"><span class="info-label">Radioactivité</span><span class="info-value">À définir</span></div>
                    <div class="info-row"><span class="info-label">Physique</span><span class="info-value">À définir</span></div>
                    <div class="info-row"><span class="info-label">Chimie</span><span class="info-value">À définir</span></div>
                    <p style="margin-top: 20px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                </div>
            </div>
        </div>

        <!-- Studio Screen -->
        <div id="studioScreen" class="studio-screen">
            <div class="studio-header">
                <button onclick="closeStudioScreen()" class="studio-back">←</button>
                <div class="studio-header-info">
                    <span class="studio-title">🏠 Mon Studio</span>
                    <span class="studio-card-name" id="studioCardName"></span>
                </div>
                <div class="studio-dust-display">
                    <svg width="22" height="22" viewBox="0 0 24 24" style="display:inline-block;vertical-align:middle" xmlns="http://www.w3.org/2000/svg"><ellipse cx="12" cy="19" rx="9" ry="3" fill="#c084fc" opacity="0.7"/><path d="M5,18 Q7,10 12,7 Q17,10 19,18 Z" fill="#a855f7"/><circle cx="9" cy="14" r="1.2" fill="rgba(255,255,255,0.7)"/><circle cx="13" cy="11" r="1" fill="rgba(255,255,255,0.6)"/><circle cx="15" cy="15" r="0.9" fill="rgba(255,255,255,0.5)"/></svg>
                    <span id="studioDustCounter">0</span>
                </div>
            </div>

            <div class="studio-body">
                <div class="studio-room-wrapper">
                    <div class="studio-scene">

                        <!-- ===== SVG ISOMETRIC ROOM ===== -->
                        <svg id="studioSvg" width="400" height="370" viewBox="0 0 400 370" style="position:absolute;top:0;left:0;overflow:visible">
  <defs>
    <!-- Wood plank pattern for walls -->
    <pattern id="woodPlanksLeft" x="0" y="0" width="20" height="60" patternUnits="userSpaceOnUse" patternTransform="skewY(-27) scaleX(0.5)">
      <rect width="20" height="60" fill="#5a3010"/>
      <rect x="1" width="18" height="58" fill="#7a4520"/>
      <rect x="2" y="1" width="16" height="2" fill="rgba(255,200,100,0.08)"/>
      <line x1="0" y1="0" x2="20" y2="0" stroke="rgba(0,0,0,0.3)" stroke-width="2"/>
    </pattern>
    <pattern id="woodPlanksRight" x="0" y="0" width="20" height="60" patternUnits="userSpaceOnUse" patternTransform="skewY(27) scaleX(0.5)">
      <rect width="20" height="60" fill="#3d2008"/>
      <rect x="1" width="18" height="58" fill="#5a3010"/>
      <rect x="2" y="1" width="16" height="2" fill="rgba(255,200,100,0.05)"/>
      <line x1="0" y1="0" x2="20" y2="0" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
    </pattern>
    <!-- Floor wood -->
    <pattern id="floorWood" x="0" y="0" width="40" height="20" patternUnits="userSpaceOnUse" patternTransform="rotate(-27) scaleY(0.5)">
      <rect width="40" height="20" fill="#3a6020"/>
      <rect y="1" width="40" height="18" fill="#486828"/>
      <line x1="0" y1="0" x2="40" y2="0" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
    </pattern>
    <!-- Wall lamp glow -->
    <radialGradient id="lampGlow" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="#ffcc44" stop-opacity="0.8"/>
      <stop offset="60%" stop-color="#ff8800" stop-opacity="0.3"/>
      <stop offset="100%" stop-color="#ff4400" stop-opacity="0"/>
    </radialGradient>
    <!-- Arch glow -->
    <radialGradient id="archGlow" cx="50%" cy="60%" r="50%">
      <stop offset="0%" stop-color="#00ffcc" stop-opacity="0.9"/>
      <stop offset="50%" stop-color="#00aaff" stop-opacity="0.5"/>
      <stop offset="100%" stop-color="#0044ff" stop-opacity="0"/>
    </radialGradient>
    <!-- Drop shadow filter -->
    <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="rgba(0,0,0,0.6)"/>
    </filter>
    <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
      <feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="rgba(0,0,0,0.5)"/>
    </filter>
    <!-- Arch inner glow blur -->
    <filter id="glowBlur">
      <feGaussianBlur stdDeviation="8" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <!-- Ceiling beam clip -->
    <clipPath id="leftWallClip">
      <polygon points="200,10 60,100 60,230 200,140"/>
    </clipPath>
    <clipPath id="rightWallClip">
      <polygon points="200,10 340,100 340,230 200,140"/>
    </clipPath>
  </defs>

  <!-- ═══════════════════════════════════════════
       ROOM SHELL — three faces of a box
       back=(200,110) left=(60,200) front=(200,290) right=(340,200)
       wall height=100px
  ════════════════════════════════════════════ -->

  <!-- CEILING / TOP EDGE (thin) -->
  <polygon points="200,10 60,100 200,140 340,100" fill="#2a1800" opacity="0.6"/>

  <!-- LEFT WALL (north-west face) — darker wood -->
  <polygon points="200,10 60,100 60,230 200,140" fill="#5a3010"/>
  <!-- Wood planks on left wall (vertical lines) -->
  <line x1="107" y1="78" x2="107" y2="208" stroke="rgba(0,0,0,0.25)" stroke-width="1.5"/>
  <line x1="130" y1="65" x2="130" y2="195" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <line x1="153" y1="52" x2="153" y2="182" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <line x1="176" y1="39" x2="176" y2="169" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <line x1="84" y1="91" x2="84" y2="221" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <!-- Highlight top edge left wall -->
  <line x1="200" y1="10" x2="60" y2="100" stroke="rgba(255,200,80,0.25)" stroke-width="1.5"/>
  <!-- Left wall ambient from arch -->
  <polygon points="200,10 60,100 60,230 200,140" fill="#00cc88" opacity="0.04"/>

  <!-- RIGHT WALL (north-east face) — slightly darker -->
  <polygon points="200,10 340,100 340,230 200,140" fill="#3d2008"/>
  <!-- Wood planks right wall -->
  <line x1="247" y1="52" x2="247" y2="182" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <line x1="270" y1="65" x2="270" y2="195" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <line x1="293" y1="78" x2="293" y2="208" stroke="rgba(0,0,0,0.25)" stroke-width="1.5"/>
  <line x1="316" y1="91" x2="316" y2="221" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <line x1="224" y1="39" x2="224" y2="169" stroke="rgba(0,0,0,0.2)" stroke-width="1.5"/>
  <!-- Highlight top edge right wall -->
  <line x1="200" y1="10" x2="340" y2="100" stroke="rgba(255,200,80,0.18)" stroke-width="1.5"/>
  <!-- Lamp warm light on right wall -->
  <ellipse cx="310" cy="130" rx="60" ry="50" fill="url(#lampGlow)" opacity="0.35"/>

  <!-- FLOOR (top face of box) — warm green wood -->
  <polygon points="200,140 60,230 200,320 340,230" fill="#4a6818"/>
  <!-- Floor plank lines (going front-left to front-right direction) -->
  <line x1="60" y1="230" x2="200" y2="140" stroke="rgba(0,0,0,0.15)" stroke-width="1"/>
  <line x1="90" y1="245" x2="230" y2="155" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
  <line x1="120" y1="260" x2="260" y2="170" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
  <line x1="150" y1="275" x2="290" y2="185" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
  <line x1="180" y1="290" x2="320" y2="200" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
  <line x1="200" y1="320" x2="340" y2="230" stroke="rgba(0,0,0,0.15)" stroke-width="1"/>
  <!-- Cross planks -->
  <line x1="60" y1="230" x2="200" y2="320" stroke="rgba(0,0,0,0.08)" stroke-width="1"/>
  <line x1="107" y1="203" x2="247" y2="293" stroke="rgba(0,0,0,0.07)" stroke-width="1"/>
  <line x1="154" y1="176" x2="294" y2="266" stroke="rgba(0,0,0,0.07)" stroke-width="1"/>
  <!-- Floor highlight near arch (glow spill) -->
  <ellipse cx="100" cy="220" rx="50" ry="25" fill="#00ffcc" opacity="0.06"/>
  <!-- Rug -->
  <polygon points="140,200 200,165 260,200 200,235" fill="#6a1f5a" opacity="0.6"/>
  <polygon points="148,200 200,170 252,200 200,230" fill="none" stroke="rgba(220,130,200,0.5)" stroke-width="1.5"/>
  <circle cx="200" cy="165" r="3" fill="rgba(220,130,200,0.6)"/>
  <circle cx="140" cy="200" r="3" fill="rgba(220,130,200,0.6)"/>
  <circle cx="260" cy="200" r="3" fill="rgba(220,130,200,0.6)"/>
  <circle cx="200" cy="235" r="3" fill="rgba(220,130,200,0.6)"/>

  <!-- Wall/floor join edges -->
  <line x1="60" y1="100" x2="60" y2="230" stroke="rgba(0,0,0,0.5)" stroke-width="2"/>
  <line x1="340" y1="100" x2="340" y2="230" stroke="rgba(0,0,0,0.5)" stroke-width="2"/>
  <line x1="60" y1="230" x2="200" y2="140" stroke="rgba(255,200,80,0.15)" stroke-width="1"/>
  <line x1="340" y1="230" x2="200" y2="140" stroke="rgba(255,200,80,0.12)" stroke-width="1"/>

  <!-- Ceiling beams -->
  <line x1="130" y1="55" x2="130" y2="170" stroke="rgba(30,15,0,0.6)" stroke-width="8" stroke-linecap="round"/>
  <line x1="270" y1="55" x2="270" y2="170" stroke="rgba(30,15,0,0.5)" stroke-width="8" stroke-linecap="round"/>

  <!-- ═══════════════════════════════════════════
       MAGIC ARCH (left wall, back corner) — replaces globe → back to map
  ════════════════════════════════════════════ -->
  <g id="item-arch" class="studio-nav-item" onclick="studioItemClick('arch')" style="cursor:pointer" filter="url(#dropShadow)">
    <!-- Stone frame outer -->
    <ellipse cx="100" cy="165" rx="34" ry="46" fill="#3a3040" stroke="#504858" stroke-width="3"/>
    <!-- Stone bricks around arch -->
    <path d="M66,165 Q66,120 100,119 Q134,120 134,165" fill="none" stroke="#605068" stroke-width="6" stroke-dasharray="10,4"/>
    <!-- Stone frame inner -->
    <ellipse cx="100" cy="165" rx="26" ry="37" fill="#1a1028"/>
    <!-- Portal glow layers -->
    <ellipse cx="100" cy="165" rx="22" ry="33" class="window-glow-anim" fill="url(#archGlow)" opacity="0.9" filter="url(#glowBlur)"/>
    <ellipse cx="100" cy="165" rx="16" ry="26" fill="#00ffcc" opacity="0.3">
      <animate attributeName="opacity" values="0.3;0.7;0.3" dur="2s" repeatCount="indefinite"/>
    </ellipse>
    <!-- Rune carvings -->
    <text x="77" y="138" font-size="9" fill="rgba(0,255,200,0.6)" font-family="serif">ᚱ</text>
    <text x="100" y="126" font-size="9" fill="rgba(0,255,200,0.5)" font-family="serif">ᚷ</text>
    <text x="121" y="138" font-size="9" fill="rgba(0,255,200,0.6)" font-family="serif">ᚦ</text>
    <!-- Ground glow spill -->
    <ellipse cx="100" cy="200" rx="30" ry="10" fill="#00ffcc" opacity="0.15">
      <animate attributeName="opacity" values="0.15;0.3;0.15" dur="2s" repeatCount="indefinite"/>
    </ellipse>
    <!-- Hover glow ring around arch -->
    <ellipse cx="100" cy="165" rx="38" ry="52" fill="none"
             stroke="rgba(0,255,200,0.9)" stroke-width="3"
             class="nav-glow-ring" filter="url(#glowBlur)"/>
    <!-- Label -->
    <text x="100" y="220" font-size="8" fill="rgba(0,255,200,0.8)" text-anchor="middle" font-family="sans-serif">← Carte</text>
  </g>

  <!-- ═══════════════════════════════════════════
       BOOKSHELF (left wall)
  ════════════════════════════════════════════ -->
  <g id="item-bookshelf" class="studio-nav-item" onclick="studioItemClick('bookshelf')" style="cursor:pointer">
    <!-- Bookshelf against RIGHT wall, upper area, well above armchair -->
    <!-- Back face against wall (hidden): (230,42)→(265,64)→(265,124)→(230,102) -->
    <!-- Left face (visible, faces viewer): (230,42)→(216,49)→(216,109)→(230,102) -->
    <!-- Top face: (216,49)→(230,42)→(265,64)→(251,71) -->

    <!-- Back panel -->
    <polygon points="230,42 265,64 265,124 230,102" fill="#1e0e04"/>
    <!-- Left face — main visible surface with book spines -->
    <polygon points="230,42 216,49 216,109 230,102" fill="#5a3018" id="shelf-face"/>
    <!-- Top panel -->
    <polygon points="216,49 230,42 265,64 251,71" fill="#7a4a20"/>

    <!-- Shelf boards on left face (horizontal dividers) -->
    <line x1="230" y1="68" x2="216" y2="75" stroke="#3d2010" stroke-width="2"/>
    <line x1="230" y1="87" x2="216" y2="94" stroke="#3d2010" stroke-width="2"/>

    <!-- Books row 1 (top shelf, y 44-66) — spines on left face -->
    <polygon points="230,44 224,47 224,66 230,63" fill="#c0392b"/>
    <polygon points="224,47 219,50 219,69 224,66" fill="#2980b9"/>
    <polygon points="219,50 216,51 216,70 219,69" fill="#27ae60"/>

    <!-- Books row 2 (mid shelf, y 70-85) -->
    <polygon points="230,70 224,73 224,85 230,82" fill="#f39c12"/>
    <polygon points="224,73 219,76 219,88 224,85" fill="#8e44ad"/>
    <polygon points="219,76 216,77 216,89 219,88" fill="#e74c3c"/>

    <!-- Books row 3 (bottom shelf, y 89-107) -->
    <polygon points="230,89 224,92 224,105 230,102" fill="#16a085"/>
    <polygon points="224,92 218,95 218,108 224,105" fill="#c0392b"/>
    <polygon points="218,95 216,96 216,109 218,108" fill="#2980b9"/>

    <!-- Hover glow outline (shown via CSS filter on hover) -->
    <polygon points="230,42 216,49 216,109 230,102" fill="none" stroke="rgba(255,220,80,0)" stroke-width="2" class="item-hover-glow"/>
    <polygon points="216,49 230,42 265,64 251,71" fill="none" stroke="rgba(255,220,80,0)" stroke-width="2" class="item-hover-glow"/>

    <!-- Hover glow ring -->
    <polygon points="229,40 214,48 214,111 229,104 266,126 266,62" fill="none" 
             stroke="rgba(255,220,60,0.9)" stroke-width="2.5" stroke-linejoin="round"
             class="nav-glow-ring" filter="url(#glowBlur)"/>
    <text x="232" y="118" font-size="8" fill="rgba(255,220,120,0.85)" text-anchor="middle" font-family="sans-serif">Collections →</text>
  </g>

  </g>

  <!-- ═══════════════════════════════════════════
       LAMP (right wall, hanging/wall sconce)
  ════════════════════════════════════════════ -->
  <g id="item-lamp" onclick="studioItemClick('lamp')" style="cursor:pointer">
    <!-- Warm glow bloom on wall -->
    <ellipse cx="308" cy="148" rx="55" ry="45" fill="url(#lampGlow)" opacity="0.5" class="lamp-glow-anim"/>
    <!-- Bracket arm -->
    <line x1="325" y1="130" x2="308" y2="118" stroke="#8c6020" stroke-width="4" stroke-linecap="round"/>
    <!-- Lamp shade top -->
    <polygon points="296,104 322,110 316,118 290,112" fill="#d4900a"/>
    <polygon points="290,112 316,118 312,130 286,124" fill="#c07808"/>
    <!-- Flame -->
    <ellipse cx="303" cy="122" rx="5" ry="7" fill="#ffdd44">
      <animate attributeName="ry" values="7;9;7" dur="1.2s" repeatCount="indefinite"/>
    </ellipse>
    <ellipse cx="303" cy="120" rx="3" ry="5" fill="#ff8800">
      <animate attributeName="ry" values="5;7;5" dur="1.2s" repeatCount="indefinite"/>
    </ellipse>
    <!-- Label -->
    <text x="305" y="148" font-size="8" fill="rgba(255,220,120,0.7)" text-anchor="middle" font-family="sans-serif">Lampe</text>
  </g>

  <!-- ═══════════════════════════════════════════
       ARMCHAIR (right side, mid)
  ════════════════════════════════════════════ -->
  <g id="item-armchair" onclick="studioItemClick('armchair')" style="cursor:pointer" filter="url(#softShadow)">
    <!-- Floor shadow -->
    <ellipse cx="282" cy="228" rx="38" ry="13" fill="rgba(0,0,0,0.45)"/>
    <!-- Back legs -->
    <polygon points="250,216 258,212 258,228 250,232" fill="#3d1f08"/>
    <polygon points="310,200 318,196 318,212 310,216" fill="#3d1f08"/>
    <!-- Chair back right face -->
    <polygon points="310,180 322,174 322,200 310,206" fill="#7a3a10"/>
    <!-- Chair back top face -->
    <polygon points="248,178 310,148 322,154 260,184" fill="#c87030"/>
    <!-- Chair back left face -->
    <polygon points="248,178 260,184 260,204 248,210" fill="#a05020"/>
    <!-- Chair back main -->
    <polygon points="260,184 322,154 322,174 260,204" fill="#b86028"/>
    <!-- Seat top -->
    <polygon points="248,204 310,174 322,180 260,210" fill="#d4782e"/>
    <!-- Seat right face -->
    <polygon points="310,174 322,180 322,198 310,192" fill="#8c4518"/>
    <!-- Seat left face -->
    <polygon points="248,204 260,210 260,228 248,222" fill="#a05020"/>
    <!-- Right armrest top -->
    <polygon points="310,168 324,162 322,174 308,180" fill="#c87030"/>
    <!-- Left armrest -->
    <polygon points="248,196 262,190 260,204 246,210" fill="#c87030"/>
    <!-- Cushion detail -->
    <circle cx="284" cy="185" r="4" fill="#8c4518"/>
    <!-- Label -->
    <text x="284" y="244" font-size="8" fill="rgba(255,220,120,0.85)" text-anchor="middle" font-family="sans-serif">Fauteuil</text>
  </g>

  <!-- ═══════════════════════════════════════════
       CHEST (center-right)
  ════════════════════════════════════════════ -->
  <g id="item-chest" onclick="studioItemClick('chest')" style="cursor:pointer" filter="url(#softShadow)">
    <!-- Floor shadow -->
    <ellipse cx="230" cy="220" rx="30" ry="10" fill="rgba(0,0,0,0.4)"/>
    <!-- Chest right face -->
    <polygon points="248,192 278,176 278,210 248,226" fill="#3d1f08"/>
    <!-- Chest front/left face -->
    <polygon points="200,210 248,226 248,192 200,176" fill="#7a3a10"/>
    <!-- Lid top -->
    <polygon points="200,176 248,192 278,176 230,160" fill="#c87030"/>
    <!-- Body top -->
    <polygon points="200,188 248,204 278,188 230,172" fill="#a05020"/>
    <!-- Metal band lid -->
    <polygon points="200,176 248,192 278,176 230,160" fill="none" stroke="#d4a010" stroke-width="2.5"/>
    <!-- Metal band body -->
    <polygon points="200,200 248,216 278,200 230,184" fill="none" stroke="#d4a010" stroke-width="1.5" opacity="0.7"/>
    <!-- Lock -->
    <circle cx="233" cy="192" r="5" fill="#d4a010"/>
    <rect x="230" y="186" width="6" height="5" rx="2" fill="none" stroke="#d4a010" stroke-width="2"/>
    <!-- Corner rivets -->
    <circle cx="202" cy="177" r="3" fill="#b88000"/>
    <circle cx="276" cy="177" r="3" fill="#b88000"/>
    <!-- Label -->
    <text x="235" y="232" font-size="8" fill="rgba(255,220,120,0.85)" text-anchor="middle" font-family="sans-serif">Coffre</text>
  </g>

  <!-- ═══════════════════════════════════════════
       SMALL TABLE with potion bottles (center, foreground)  
  ════════════════════════════════════════════ -->
  <g id="item-desk" onclick="studioItemClick('desk')" style="cursor:pointer" filter="url(#softShadow)">
    <!-- Floor shadow -->
    <ellipse cx="185" cy="264" rx="30" ry="10" fill="rgba(0,0,0,0.45)"/>
    <!-- Table legs -->
    <rect x="158" y="250" width="5" height="18" fill="#3d1f08" rx="2" transform="rotate(-15 160 250)"/>
    <rect x="205" y="244" width="5" height="18" fill="#3d1f08" rx="2" transform="rotate(10 207 244)"/>
    <!-- Table right face -->
    <polygon points="210,240 228,231 228,244 210,253" fill="#5a3010"/>
    <!-- Table top -->
    <polygon points="155,244 210,220 228,231 173,255" fill="#8c5422"/>
    <!-- Table left face -->
    <polygon points="155,244 173,255 173,264 155,253" fill="#6a3d18"/>
    <!-- Potion 1 (green) -->
    <ellipse cx="175" cy="236" rx="7" ry="4" fill="#2d6010"/>
    <rect x="170" y="218" width="10" height="18" fill="#3a8018" rx="2"/>
    <rect x="173" y="213" width="4" height="7" fill="#5a9020" rx="1"/>
    <ellipse cx="175" cy="218" rx="5" ry="2.5" fill="#4a9820" opacity="0.7"/>
    <!-- Potion 2 (orange) -->
    <ellipse cx="195" cy="229" rx="6" ry="3" fill="#8c3010"/>
    <rect x="190" y="213" width="9" height="16" fill="#c04818" rx="2"/>
    <rect x="193" y="209" width="3" height="6" fill="#d05820" rx="1"/>
    <ellipse cx="195" cy="213" rx="4.5" ry="2" fill="#e06828" opacity="0.7"/>
    <!-- Label -->
    <text x="185" y="274" font-size="8" fill="rgba(255,220,120,0.85)" text-anchor="middle" font-family="sans-serif">Bureau</text>
  </g>

  <!-- ═══════════════════════════════════════════
       MAGIC PARTICLES
  ════════════════════════════════════════════ -->
  <circle cx="180" cy="260" r="2" fill="rgba(255,200,80,0.7)">
    <animate attributeName="opacity" values="0.7;0.1;0.7" dur="2.1s" repeatCount="indefinite"/>
    <animate attributeName="cy" values="260;255;260" dur="2.1s" repeatCount="indefinite"/>
  </circle>
  <circle cx="240" cy="240" r="1.5" fill="rgba(0,255,200,0.6)">
    <animate attributeName="opacity" values="0.6;0.1;0.6" dur="3.2s" repeatCount="indefinite"/>
    <animate attributeName="cy" values="240;235;240" dur="3.2s" repeatCount="indefinite"/>
  </circle>
  <circle cx="155" cy="245" r="1.5" fill="rgba(200,100,255,0.6)">
    <animate attributeName="opacity" values="0.5;0.1;0.5" dur="1.9s" repeatCount="indefinite"/>
  </circle>
  <circle cx="110" cy="210" r="2" fill="rgba(0,255,200,0.5)">
    <animate attributeName="opacity" values="0.5;0.9;0.5" dur="1.5s" repeatCount="indefinite"/>
    <animate attributeName="cy" values="210;205;210" dur="1.5s" repeatCount="indefinite"/>
  </circle>

</svg>
                    </div>
                </div>

                <!-- Tooltip popup -->
                <div class="studio-tooltip hidden" id="studioTooltip">
                    <div class="tooltip-icon" id="tooltipIcon"></div>
                    <div class="tooltip-content">
                        <div class="tooltip-name" id="tooltipName"></div>
                        <div class="tooltip-desc" id="tooltipDesc"></div>
                    </div>
                    <button class="tooltip-close" onclick="closeStudioTooltip()">✕</button>
                </div>

                <!-- Bottom bar: unlockable items -->
                <div class="studio-shop">
                    <div class="studio-shop-title">Objets disponibles</div>
                    <div class="studio-shop-items">
                        <div class="shop-item" onclick="buyStudioItem('mirror', 200)">
                            <div class="shop-item-icon">🔮</div>
                            <div class="shop-item-name">Miroir magique</div>
                            <div class="shop-item-price">200 ✦</div>
                        </div>
                        <div class="shop-item owned" onclick="buyStudioItem('globe', 300)">
                            <div class="shop-item-icon">🌍</div>
                            <div class="shop-item-name">Globe</div>
                            <div class="shop-item-price">Possédé ✓</div>
                        </div>
                        <div class="shop-item" onclick="buyStudioItem('harp', 500)">
                            <div class="shop-item-icon">🎵</div>
                            <div class="shop-item-name">Harpe lyonnaise</div>
                            <div class="shop-item-price">500 ✦</div>
                        </div>
                        <div class="shop-item" onclick="buyStudioItem('cauldron', 400)">
                            <div class="shop-item-icon">🫙</div>
                            <div class="shop-item-name">Chaudron</div>
                            <div class="shop-item-price">400 ✦</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Journal Screen -->
        <div id="journalScreen" class="journal-screen">
            <div class="journal-screen-header">
                <button onclick="closeJournalScreen()" class="journal-screen-back">←</button>
                <div class="journal-screen-card-mini">
                    <div class="journal-screen-card-image">🎴</div>
                    <div class="journal-screen-card-info">
                        <h3 id="journalScreenCardName">Marie Curie</h3>
                        <p id="journalScreenCardType">Personnage</p>
                    </div>
                </div>
            </div>

            <div class="journal-screen-body">
                <div class="journal-screen-content">
                    <div class="journal-notebook">
                        <div class="journal-level-overlay" id="journalLevelOverlay1"></div>
                        <div class="journal-level-overlay" id="journalLevelOverlay2"></div>
                        <div class="journal-level-overlay" id="journalLevelOverlay3"></div>

                        <div class="journal-quote">
                            "J'ai appris que la voie du progrès n'était ni rapide, ni facile..."
                        </div>

                        <div class="journal-item-with-slot">
                            <div class="echo-slot" id="echoSlot1" data-slot-id="slot1" ondragover="allowDrop(event)" ondrop="dropEcho(event)">
                                <div class="echo-slot-content"></div>
                            </div>
                            <div class="journal-content-wrapper">
                                <div class="journal-item" style="margin: 0;">
                                    <div class="journal-image">🏅</div>
                                    <div>
                                        <div class="journal-date">1903</div>
                                        <div class="journal-text">Prix Nobel de Physique</div>
                                    </div>
                                </div>
                                <div id="unlockedContent1" class="unlocked-content hidden">
                                    <div class="unlocked-content-text"></div>
                                </div>
                            </div>
                        </div>

                        <div class="journal-item-with-slot">
                            <div class="echo-slot" id="echoSlot2" data-slot-id="slot2" ondragover="allowDrop(event)" ondrop="dropEcho(event)">
                                <div class="echo-slot-content"></div>
                            </div>
                            <div class="journal-content-wrapper">
                                <div class="journal-item" style="margin: 0;">
                                    <div class="journal-image">🏛️</div>
                                    <div>
                                        <div class="journal-date">1891</div>
                                        <div class="journal-text">Arrive à Paris pour étudier</div>
                                    </div>
                                </div>
                                <div id="unlockedContent2" class="unlocked-content hidden">
                                    <div class="unlocked-content-text"></div>
                                </div>
                            </div>
                        </div>

                        <div class="journal-item-with-slot">
                            <div class="echo-slot" id="echoSlot3" data-slot-id="slot3" ondragover="allowDrop(event)" ondrop="dropEcho(event)">
                                <div class="echo-slot-content"></div>
                            </div>
                            <div class="journal-content-wrapper">
                                <div class="journal-item" style="margin: 0;">
                                    <div class="journal-image">🧪</div>
                                    <div>
                                        <div class="journal-date">1898</div>
                                        <div class="journal-text">Découverte du radium</div>
                                    </div>
                                </div>
                                <div id="unlockedContent3" class="unlocked-content hidden">
                                    <div class="unlocked-content-text"></div>
                                </div>
                            </div>
                        </div>

                        <div class="journal-interaction-btn" id="journalBtn1" style="position: absolute; top: 16.66%; left: 50%; transform: translateX(-50%); z-index: 10; display: none;">
                            <div class="interaction-button">🎵</div>
                        </div>
                        <div class="journal-interaction-btn" id="journalBtn2" style="position: absolute; top: 50%; left: 50%; transform: translateX(-50%); z-index: 10; display: none;">
                            <div class="interaction-button">🔒</div>
                        </div>
                        <div class="journal-interaction-btn" id="journalBtn3" style="position: absolute; top: 83.33%; left: 50%; transform: translateX(-50%); z-index: 10; display: none;">
                            <div class="interaction-button">🔧</div>
                        </div>
                    </div>
                </div>

                <div class="journal-screen-footer" style="padding-bottom: max(16px, env(safe-area-inset-bottom));">
                    <div class="journal-inventory-title">Échos collectés</div>
                    <div class="echo-inventory" id="echoInventory"></div>
                </div>
            </div>
        </div>
        <!-- ==================== PROGRESSION SCREEN ==================== -->
        <div id="progressionScreen" class="progression-screen">

            <div class="prog-header">
                <button class="prog-back" onclick="closeProgressionScreen()">←</button>
                <div class="prog-header-info">
                    <div class="prog-header-title">Chemin de l'Explorateur</div>
                    <div class="prog-header-subtitle" id="progHeaderSub">Saison 1 · Lyon à travers les âges</div>
                </div>
            </div>

            <!-- Player rank card -->
            <div class="prog-player-card">
                <div class="prog-player-top">
                    <div class="prog-avatar-ring" id="progAvatar">
                        🧙
                        <div class="prog-avatar-level-badge" id="progAvatarLevel">1</div>
                    </div>
                    <div class="prog-player-info">
                        <div class="prog-player-rank" id="progRankName">Novice</div>
                        <div class="prog-player-title" id="progRankTitle">Les premiers pas de l'explorateur</div>
                        <div class="prog-player-xp-total" id="progXpTotal">0 XP accumulés</div>
                    </div>
                </div>
                <div class="prog-xp-bar-wrap">
                    <div class="prog-xp-label">
                        <span id="progXpCurrent">0 XP</span>
                        <span id="progXpNext">Prochain rang : 100 XP</span>
                    </div>
                    <div class="prog-xp-bar">
                        <div class="prog-xp-fill" id="progXpFill" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="prog-tabs">
                <button class="prog-tab active" id="progTabBP" onclick="switchProgTab('battlepass')">🗺️ Parcours</button>
                <button class="prog-tab" id="progTabAchiev" onclick="switchProgTab('achievements')">🏆 Succès</button>
            </div>

            <div class="prog-body">
                <div id="progPaneBP" class="battlepass-track">
                    <div class="battlepass-season-title">⟡ Saison 1 · Paliers de progression ⟡</div>
                    <div id="bpNodesList"></div>
                </div>
                <div id="progPaneAchiev" class="achievements-list hidden">
                    <div id="achievementsList"></div>
                </div>
            </div>
        </div>

        <!-- Level-up overlay -->
        <div id="levelupOverlay" class="levelup-overlay" onclick="closeLevelupOverlay()">
            <div class="levelup-burst" id="levelupBurst">⭐</div>
            <div class="levelup-text">NIVEAU <span id="levelupNum">2</span></div>
            <div class="levelup-rank" id="levelupRank">Chroniqueur</div>
            <div class="levelup-xp" id="levelupXpBonus">Nouveau rang débloqué !</div>
            <button class="levelup-close" onclick="closeLevelupOverlay()">Continuer →</button>
        </div>

    </div><!-- fin mainApp -->

    <script>
        // ==================== DATA ====================

        const COLLECTIONS = {
            lumieres: {
                id: 'lumieres',
                name: 'Lumières de Lyon',
                type: 'thématique',
                description: 'Personnages historiques lyonnais',
                cards: [
                    { id: 'card1', name: 'Antoine de Saint-Exupéry', type: 'Personnage', poiId: 'bellecour', rarity: 'rare', supertype: 'arts' },
                    { id: 'card2', name: 'Les Frères Lumière', type: 'Personnage', poiId: 'institut_lumiere', rarity: 'legendary', supertype: 'science' },
                    { id: 'card3', name: 'Paul Bocuse', type: 'Personnage', poiId: 'halles_bocuse', rarity: 'rare', supertype: 'societe' },
                    { id: 'card4', name: 'Guignol', type: 'Personnage', poiId: 'vieux_lyon', rarity: 'common', supertype: 'arts', supertype2: 'societe' },
                    { id: 'card5', name: 'Tony Garnier', type: 'Personnage', poiId: 'confluence', rarity: 'common', supertype: 'histoire', supertype2: 'arts' },
                ]
            },
            presquile: {
                id: 'presquile',
                name: 'Presqu\'île',
                type: 'locale',
                description: 'Trésors de la Presqu\'île lyonnaise',
                cards: [
                    { id: 'card6', name: 'Place Bellecour', type: 'Lieu', poiId: 'bellecour', rarity: 'legendary', supertype: 'histoire' },
                    { id: 'card7', name: 'Opéra de Lyon', type: 'Lieu', poiId: 'opera', rarity: 'rare', supertype: 'arts' },
                    { id: 'card8', name: 'Hôtel de Ville', type: 'Lieu', poiId: 'hotel_ville', rarity: 'common', supertype: 'societe' },
                    { id: 'card9', name: 'Les Terreaux', type: 'Lieu', poiId: 'terreaux', rarity: 'common', supertype: 'histoire', supertype2: 'nature' },
                    { id: 'card10', name: 'Fontaine Bartholdi', type: 'Objet', poiId: 'terreaux', rarity: 'rare', supertype: 'arts' },
                ]
            },
            fourviere: {
                id: 'fourviere',
                name: 'Fourvière & Vieux-Lyon',
                type: 'locale',
                description: 'Patrimoine de la colline et du Vieux-Lyon',
                cards: [
                    { id: 'card11', name: 'Basilique Notre-Dame', type: 'Lieu', poiId: 'fourviere', rarity: 'legendary', supertype: 'histoire', supertype2: 'nature' },
                    { id: 'card12', name: 'Théâtre Romain', type: 'Lieu', poiId: 'theatre_romain', rarity: 'rare', supertype: 'histoire' },
                    { id: 'card13', name: 'Cathédrale Saint-Jean', type: 'Lieu', poiId: 'saint_jean', rarity: 'rare', supertype: 'histoire' },
                    { id: 'card14', name: 'Traboule Renaissance', type: 'Lieu', poiId: 'vieux_lyon', rarity: 'common', supertype: 'societe', supertype2: 'histoire' },
                    { id: 'card15', name: 'Horloge Astronomique', type: 'Objet', poiId: 'saint_jean', rarity: 'common', supertype: 'science' },
                    { id: 'card16', name: 'Parc de la Tête d\'Or', type: 'Lieu', poiId: 'confluence', rarity: 'rare', supertype: 'nature' },
                    { id: 'card17', name: 'Jardin des Curiosités', type: 'Lieu', poiId: 'fourviere', rarity: 'common', supertype: 'nature', supertype2: 'science' },
                ]
            }
        };

        const POIS = [
            { id: 'fourviere', name: 'Basilique de Fourvière', lat: 45.7624, lng: 4.8227 },
            { id: 'bellecour', name: 'Place Bellecour', lat: 45.7578, lng: 4.8320 },
            { id: 'vieux_lyon', name: 'Vieux-Lyon', lat: 45.7640, lng: 4.8270 },
            { id: 'parc_tete_or', name: 'Parc de la Tête d\'Or', lat: 45.7772, lng: 4.8542 },
            { id: 'confluence', name: 'Musée des Confluences', lat: 45.7326, lng: 4.8181 },
            { id: 'terreaux', name: 'Place des Terreaux', lat: 45.7675, lng: 4.8336 },
            { id: 'opera', name: 'Opéra de Lyon', lat: 45.7673, lng: 4.8361 },
            { id: 'hotel_ville', name: 'Hôtel de Ville', lat: 45.7674, lng: 4.8348 },
            { id: 'theatre_romain', name: 'Théâtre Romain', lat: 45.7605, lng: 4.8205 },
            { id: 'saint_jean', name: 'Cathédrale Saint-Jean', lat: 45.7606, lng: 4.8268 },
            { id: 'institut_lumiere', name: 'Institut Lumière', lat: 45.7432, lng: 4.8687 },
            { id: 'halles_bocuse', name: 'Halles Paul Bocuse', lat: 45.7638, lng: 4.8542 },
        ];

        const DUST_POINTS = [
            { id: 'dust1', lat: 45.7590, lng: 4.8290 },{ id: 'dust2', lat: 45.7610, lng: 4.8310 },
            { id: 'dust3', lat: 45.7630, lng: 4.8330 },{ id: 'dust4', lat: 45.7650, lng: 4.8300 },
            { id: 'dust5', lat: 45.7620, lng: 4.8250 },{ id: 'dust6', lat: 45.7600, lng: 4.8230 },
            { id: 'dust7', lat: 45.7660, lng: 4.8320 },{ id: 'dust8', lat: 45.7640, lng: 4.8380 },
            { id: 'dust9', lat: 45.7680, lng: 4.8360 },{ id: 'dust10', lat: 45.7700, lng: 4.8340 },
            { id: 'dust11', lat: 45.7720, lng: 4.8380 },{ id: 'dust12', lat: 45.7740, lng: 4.8420 },
            { id: 'dust13', lat: 45.7760, lng: 4.8460 },{ id: 'dust14', lat: 45.7780, lng: 4.8500 },
            { id: 'dust15', lat: 45.7650, lng: 4.8420 },{ id: 'dust16', lat: 45.7580, lng: 4.8380 },
            { id: 'dust17', lat: 45.7560, lng: 4.8340 },{ id: 'dust18', lat: 45.7540, lng: 4.8280 },
            { id: 'dust19', lat: 45.7520, lng: 4.8240 },{ id: 'dust20', lat: 45.7500, lng: 4.8200 },
            { id: 'dust21', lat: 45.7480, lng: 4.8260 },{ id: 'dust22', lat: 45.7460, lng: 4.8300 },
            { id: 'dust23', lat: 45.7440, lng: 4.8340 },{ id: 'dust24', lat: 45.7420, lng: 4.8380 },
            { id: 'dust25', lat: 45.7400, lng: 4.8420 },{ id: 'dust26', lat: 45.7380, lng: 4.8280 },
            { id: 'dust27', lat: 45.7360, lng: 4.8240 },{ id: 'dust28', lat: 45.7340, lng: 4.8200 },
            { id: 'dust29', lat: 45.7600, lng: 4.8460 },{ id: 'dust30', lat: 45.7620, lng: 4.8500 },
        ];

        const SUPERTYPES = {
            histoire: { name: 'Histoire', color: '#8B5CF6', symbol: '📜' },
            nature:   { name: 'Nature',   color: '#10B981', symbol: '🌿' },
            science:  { name: 'Science',  color: '#3B82F6', symbol: '⚗️'  },
            arts:     { name: 'Arts',     color: '#EC4899', symbol: '🎨' },
            societe:  { name: 'Société',  color: '#F59E0B', symbol: '🏛️' }
        };


        // Shared echo SVG icon — used on map markers, orbs, panels
        // Unified echo icon: symmetric wave on a square viewbox
        // Same shape used on map markers, orbs, panels, slots
        function echoSvg(color, size) {
            size = size || 28;
            return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <circle cx="7" cy="12" r="3" fill="${color}"/>
              <path d="M13,6 Q19,12 13,18" fill="none" stroke="${color}" stroke-width="2.2" stroke-linecap="round"/>
              <path d="M17,3 Q25,12 17,21" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" opacity="0.55"/>
            </svg>`;
        }
        const ECHO_POINTS = [
            { id: 'echo1',  supertype: 'histoire', lat: 45.7592, lng: 4.8292 },
            { id: 'echo2',  supertype: 'nature',   lat: 45.7612, lng: 4.8312 },
            { id: 'echo3',  supertype: 'science',  lat: 45.7632, lng: 4.8332 },
            { id: 'echo4',  supertype: 'arts',     lat: 45.7652, lng: 4.8302 },
            { id: 'echo5',  supertype: 'societe',  lat: 45.7622, lng: 4.8252 },
            { id: 'echo6',  supertype: 'histoire', lat: 45.7602, lng: 4.8232 },
            { id: 'echo7',  supertype: 'nature',   lat: 45.7662, lng: 4.8322 },
            { id: 'echo8',  supertype: 'science',  lat: 45.7642, lng: 4.8382 },
            { id: 'echo9',  supertype: 'arts',     lat: 45.7682, lng: 4.8362 },
            { id: 'echo10', supertype: 'societe',  lat: 45.7702, lng: 4.8342 },
        ];

        const ECHO_UNLOCKS = {
            slot1: "Cette découverte marqua un tournant dans l'histoire des sciences. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            slot2: "Une rencontre qui changea le cours des événements. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",
            slot3: "L'innovation qui révolutionna le domaine. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris."
        };

        const LYON_CENTER = { lat: 45.7640, lng: 4.8357 };
        const isMobileDevice = window.matchMedia('(max-width: 768px)').matches ||
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const COLLECTION_RADIUS = 50;
        const DUST_RADIUS = 30;
        const ECHO_RADIUS = 30;
        const MOVE_SPEED = 0.000015;
        // Tilt offset: shift camera center north so player appears in lower third of screen
        const TILT_OFFSET_LAT = 0.0018;
        const ISOMETRIC_TILT = 67.5;
        const ISOMETRIC_HEADING = 0;  // keep north-up like Waze default
        const DUST_INCREMENT = 50;
        const MIN_DUST_DROP = 25;
        const MAX_DUST_DROP = 75;
        const MAX_LEVEL = 3;

        const RARITY_CONFIG = {
            common:    { name: 'Commune',   color: '#10B981', shape: 'triangle', exp: { 0: 50,  1: 150, 2: 300  } },
            rare:      { name: 'Rare',      color: '#3B82F6', shape: 'pentagon', exp: { 0: 100, 1: 250, 2: 500  } },
            legendary: { name: 'Légendaire',color: '#F97316', shape: 'hexagon',  exp: { 0: 150, 1: 400, 2: 800  } }
        };

        const CARD_DIALOGUES = {
            random: [
                "Bonjour, je suis ravi de te rencontrer !",
                "As-tu exploré Lyon aujourd'hui ?",
                "Continue comme ça, tu fais du bon travail !"
            ],
            milestone: "Merci d'avoir dépensé 100 poudres sur moi ! Tu es formidable !"
        };

        // ==================== STATE ====================

        let playerPos = { ...LYON_CENTER };
        let collectedCards = [];
        let cardLevels = {};
        let memorialDust = 1000;
        let collectedEchoes = [];
        let echoInventory = {};
        let placedEchoes = {}; // kept for compat
        let cardJournals = {}; // { cardId: { slot1: supertype, slot2: ..., slot3: ... } }
        let collectedDustPoints = [];

        let map = null;
        let playerMarker = null;
        let poiMarkers = [];
        let dustMarkers = [];
        let echoMarkers = [];

        let currentNearbyPOI = null;
        let currentNearbyDust = null;
        let currentNearbyEcho = null;

        let selectedCollectionId = null;
        let currentTab = 'general';
        let selectedCard = null;

        let gpsWatchId = null;
        let gpsActive = false;

        let joystickActive = false;
        let joystickInterval = null;
        let joystickDirection = { x: 0, y: 0 };


        // Init echo inventory
        Object.keys(SUPERTYPES).forEach(type => { echoInventory[type] = 0; });

        // ==================== INIT ====================

        function startApp() {
            initMap();
        }

        window.addEventListener('load', () => {
            startApp();
            setTimeout(() => {
                initJoystick();
                if (isMobileDevice && 'geolocation' in navigator) {
                    setTimeout(startGPS, 500);
                }
            }, 1500);
        });

        function initMap() {
            playerPos = { ...LYON_CENTER };
            document.getElementById('dustCounter').textContent = memorialDust;
            createMap();
        }

        // Mapbox uses pixel offset in flyTo/easeTo - no lat offset needed
        function getCameraCenter(pos) {
            return pos; // kept for compatibility, Mapbox handles offset natively
        }

        function applyIsometricCamera() {
            // Mapbox pitch is set at creation and after moves - nothing to do here
        }

        function createMap() {
            // no token needed for MapLibre+OpenFreeMap
            // maplibregl is free and open source = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z28yMzJoMGoxaWNhbzAifQ.az9JUrQP7klCgD3W-ueILQ';

            map = new maplibregl.Map({
                container: 'map',
                style: 'https://tiles.openfreemap.org/styles/bright',
                transformRequest: (url, resourceType) => {
                    // Ensure HTTPS for all tile requests (GitHub Pages requires it)
                    if (url.startsWith('http://')) {
                        return { url: url.replace('http://', 'https://') };
                    }
                },
                center: [playerPos.lng, playerPos.lat],
                zoom: 17,
                pitch: ISOMETRIC_TILT,
                bearing: ISOMETRIC_HEADING,
                attributionControl: false
            });

            map.addControl(new maplibregl.AttributionControl({ compact: true }));

            // Disable default interactions we don't want
            map.doubleClickZoom.disable();

            // ---- Player marker (HTML element) ----
            const playerEl = document.createElement('div');
            playerEl.style.cssText = `
                width: 22px; height: 22px; border-radius: 50%;
                background: #4F46E5; border: 3px solid white;
                box-shadow: 0 2px 8px rgba(79,70,229,0.6);
                cursor: default;
            `;
            playerMarker = new maplibregl.Marker({ element: playerEl, anchor: 'center' })
                .setLngLat([playerPos.lng, playerPos.lat])
                .addTo(map);

            // ---- POI markers (card icon + capture radius circle) ----
            // Add GeoJSON source + layer inside load event
            map.on('load', () => {
            // ── Calibrated capture zone circles (exact meters → pixels at Lyon lat 45.76°) ──
            // POI: 50m, Dust: 30m, Echo: 30m
            // Pixel formula: meters * 512 * 2^zoom * cos(45.76°) / (2π * 6378137)

            map.addSource('poi-circles', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }
            });
            map.addLayer({
                id: 'poi-capture-circles',
                type: 'circle',
                source: 'poi-circles',
                paint: {
                    'circle-radius': [
                        'interpolate', ['exponential', 2], ['zoom'],
                        14, 7.3,
                        15, 14.6,
                        16, 29.2,
                        17, 58.4,
                        17.5, 82.6,
                        18, 116.8,
                        19, 233.7
                    ],
                    'circle-color': '#EF4444',
                    'circle-opacity': 0.08,
                    'circle-stroke-color': '#EF4444',
                    'circle-stroke-width': 1.5,
                    'circle-stroke-opacity': 0.4
                }
            });

            // Dust circles (30m)
            map.addSource('dust-circles', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: DUST_POINTS.map(d => ({
                        type: 'Feature',
                        properties: { id: d.id },
                        geometry: { type: 'Point', coordinates: [d.lng, d.lat] }
                    }))
                }
            });
            map.addLayer({
                id: 'dust-capture-circles',
                type: 'circle',
                source: 'dust-circles',
                paint: {
                    'circle-radius': [
                        'interpolate', ['exponential', 2], ['zoom'],
                        14, 4.4,
                        15, 8.8,
                        16, 17.5,
                        17, 35.0,
                        17.5, 49.6,
                        18, 70.1,
                        19, 140.2
                    ],
                    'circle-color': '#A855F7',
                    'circle-opacity': 0.08,
                    'circle-stroke-color': '#A855F7',
                    'circle-stroke-width': 1.2,
                    'circle-stroke-opacity': 0.35
                }
            });

            // Echo circles (30m)
            map.addSource('echo-circles', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: ECHO_POINTS.map(e => ({
                        type: 'Feature',
                        properties: { id: e.id, supertype: e.supertype },
                        geometry: { type: 'Point', coordinates: [e.lng, e.lat] }
                    }))
                }
            });
            map.addLayer({
                id: 'echo-capture-circles',
                type: 'circle',
                source: 'echo-circles',
                paint: {
                    'circle-radius': [
                        'interpolate', ['exponential', 2], ['zoom'],
                        14, 4.4,
                        15, 8.8,
                        16, 17.5,
                        17, 35.0,
                        17.5, 49.6,
                        18, 70.1,
                        19, 140.2
                    ],
                    'circle-color': '#6366F1',
                    'circle-opacity': 0.08,
                    'circle-stroke-color': '#6366F1',
                    'circle-stroke-width': 1.2,
                    'circle-stroke-opacity': 0.35
                }
            });
                // Hide POI icon labels (metro, restaurants, etc.)
                const style = map.getStyle();
                if (style && style.layers) {
                    style.layers.forEach(layer => {
                        const id = layer.id.toLowerCase();
                        if (layer.type === 'symbol') {
                            const keep = id.includes('road') || id.includes('street') ||
                                         id.includes('place') || id.includes('city') ||
                                         id.includes('town') || id.includes('village') ||
                                         id.includes('state') || id.includes('country') ||
                                         id.includes('water') || id.includes('label');
                            if (!keep) {
                                try { map.setLayoutProperty(layer.id, 'visibility', 'none'); } catch(e) {}
                            }
                        }
                    });
                }
                // Populate circles with initial data now that sources exist
                updatePOIVisibility();
                updateDustVisibility();
                updateEchoVisibility();
                checkNearbyPOI();
            }); // end map.on('load')

            POIS.forEach(poi => {
                // Single centered element: card icon centered in its own space
                // The GeoJSON circle renders separately underneath via MapLibre layer
                // Outer wrapper: zero size, never transforms (keeps marker stable)
                const el = document.createElement('div');
                el.style.cssText = 'width:0;height:0;overflow:visible;cursor:pointer;';
                el.title = poi.name;
                // Inner icon: scales without affecting marker anchor
                const inner = document.createElement('div');
                inner.style.cssText = `
                    position: absolute;
                    width: 28px; height: 28px;
                    transform: translate(-50%, -50%);
                    display: flex; align-items: center; justify-content: center;
                    font-size: 20px;
                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
                    transition: transform 0.15s, filter 0.15s;
                    pointer-events: none;
                `;
                inner.textContent = '🎴';
                el.appendChild(inner);

                const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
                    .setLngLat([poi.lng, poi.lat])
                    .addTo(map);



                poiMarkers.push({ marker, el, inner, poi });
            });



            // ---- Dust markers — powder icon (triangle pile) ----
            DUST_POINTS.forEach(dust => {
                const el = document.createElement('div');
                el.style.cssText = 'width:24px;height:24px;cursor:default;filter:drop-shadow(0 2px 4px rgba(168,85,247,0.6));';
                el.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- Plate/base -->
                  <ellipse cx="12" cy="19" rx="9" ry="3" fill="#c084fc" opacity="0.6"/>
                  <!-- Powder mound (triangle) -->
                  <path d="M5,18 Q7,10 12,7 Q17,10 19,18 Z" fill="#a855f7"/>
                  <!-- Sparkle dots -->
                  <circle cx="9" cy="14" r="1" fill="rgba(255,255,255,0.7)"/>
                  <circle cx="13" cy="11" r="0.8" fill="rgba(255,255,255,0.6)"/>
                  <circle cx="15" cy="15" r="0.8" fill="rgba(255,255,255,0.5)"/>
                </svg>`;
                const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
                    .setLngLat([dust.lng, dust.lat])
                    .addTo(map);
                dustMarkers.push({ marker, el, dust });
            });

            // ---- Echo markers — sound wave / echo icon ----
            ECHO_POINTS.forEach(echo => {
                const info = SUPERTYPES[echo.supertype];
                // Parse color hex to rgb for wave arcs
                const hex = info.color.replace('#','');
                const r = parseInt(hex.slice(0,2),16);
                const g = parseInt(hex.slice(2,4),16);
                const b = parseInt(hex.slice(4,6),16);
                const el = document.createElement('div');
                el.style.cssText = 'width:28px;height:24px;cursor:default;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));';
                el.title = `Écho ${info.name}`;
                el.innerHTML = echoSvg(info.color, 28);
                const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
                    .setLngLat([echo.lng, echo.lat])
                    .addTo(map);
                echoMarkers.push({ marker, el, echo });
            });

            // Hide all POI icons and labels to keep the map clean

        }

        // Move player marker and pan camera
        // We shift the camera center slightly north so the player appears in the lower third.
        // Geographic offset doesn't affect marker positions (unlike pixel padding/offset).
        const CAM_LAT_OFFSET = 0.0012; // degrees north (~130m) — adjust if needed
        function updatePlayerOnMap() {
            if (!map || !playerMarker) return;
            playerMarker.setLngLat([playerPos.lng, playerPos.lat]);
            map.easeTo({
                center: [playerPos.lng, playerPos.lat + CAM_LAT_OFFSET],
                pitch: ISOMETRIC_TILT,
                bearing: ISOMETRIC_HEADING,
                duration: 80
            });
        }


        // ==================== MOVEMENT ====================

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('collectionsPanel').classList.contains('show') ||
                document.getElementById('cardPopup').classList.contains('show') ||
                document.getElementById('cardDetailView').classList.contains('show')) return;

            let newLat = playerPos.lat;
            let newLng = playerPos.lng;

            switch (e.key) {
                case 'ArrowUp':    newLat += MOVE_SPEED; break;
                case 'ArrowDown':  newLat -= MOVE_SPEED; break;
                case 'ArrowLeft':  newLng -= MOVE_SPEED; break;
                case 'ArrowRight': newLng += MOVE_SPEED; break;
                default: return;
            }

            e.preventDefault();
            playerPos = { lat: newLat, lng: newLng };
            if (playerMarker && map) {
                updatePlayerOnMap();
            }
            checkNearbyPOI();
        });

        function initJoystick() {
            const base = document.getElementById('joystickBase');
            const stick = document.getElementById('joystickStick');
            if (!base || !stick) return;

            let isDragging = false;
            let centerX = 0, centerY = 0;

            function isUIOpen() {
                return document.getElementById('collectionsPanel').classList.contains('show') ||
                       document.getElementById('cardPopup').classList.contains('show') ||
                       document.getElementById('cardDetailView').classList.contains('show') ||
                       document.getElementById('journalScreen').classList.contains('show');
            }

            function handleStart(e) {
                if (isUIOpen()) return;
                isDragging = true;
                const rect = base.getBoundingClientRect();
                centerX = rect.left + rect.width / 2;
                centerY = rect.top + rect.height / 2;
                handleMove(e);
            }

            function handleMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                const maxDist = 35;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > maxDist) { dx = (dx / dist) * maxDist; dy = (dy / dist) * maxDist; }
                stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                joystickDirection.x = dx / maxDist;
                joystickDirection.y = -dy / maxDist;
                if (!joystickActive) {
                    joystickActive = true;
                    startJoystickMovement();
                }
            }

            function handleEnd() {
                isDragging = false;
                stick.style.transform = 'translate(-50%, -50%)';
                joystickDirection = { x: 0, y: 0 };
                joystickActive = false;
                if (joystickInterval) { clearInterval(joystickInterval); joystickInterval = null; }
            }

            base.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
            base.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
        }

        function startJoystickMovement() {
            joystickInterval = setInterval(() => {
                if (!joystickActive || gpsActive) return;
                const speed = MOVE_SPEED * 2;
                playerPos = {
                    lat: playerPos.lat + joystickDirection.y * speed,
                    lng: playerPos.lng + joystickDirection.x * speed
                };
                if (playerMarker && map) {
                    updatePlayerOnMap();
                }
                checkNearbyPOI();
            }, 50);
        }

        // ==================== NEARBY CHECKS ====================

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180, Δλ = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function checkNearbyPOI() {
            // POI
            const nearby = POIS.find(poi => {
                const dist = getDistance(playerPos.lat, playerPos.lng, poi.lat, poi.lng);
                if (dist > COLLECTION_RADIUS) return false;
                const allCards = Object.values(COLLECTIONS).flatMap(c => c.cards);
                return allCards.some(card => card.poiId === poi.id && !collectedCards.includes(card.id));
            });
            currentNearbyPOI = nearby;
            const nearbyDiv = document.getElementById('nearbyPOI');
            if (nearby) { document.getElementById('poiName').textContent = nearby.name; nearbyDiv.classList.remove('hidden'); }
            else { nearbyDiv.classList.add('hidden'); }

            // Dust
            const nearbyDust = DUST_POINTS.find(d =>
                !collectedDustPoints.includes(d.id) &&
                getDistance(playerPos.lat, playerPos.lng, d.lat, d.lng) <= DUST_RADIUS
            );
            currentNearbyDust = nearbyDust;
            const nearbyDustDiv = document.getElementById('nearbyDust');
            if (nearbyDust) nearbyDustDiv.classList.remove('hidden');
            else nearbyDustDiv.classList.add('hidden');

            // Echo
            const nearbyEcho = ECHO_POINTS.find(e =>
                !collectedEchoes.includes(e.id) &&
                getDistance(playerPos.lat, playerPos.lng, e.lat, e.lng) <= ECHO_RADIUS
            );
            currentNearbyEcho = nearbyEcho;
            const nearbyEchoDiv = document.getElementById('nearbyEcho');
            if (nearbyEcho) {
                const info = SUPERTYPES[nearbyEcho.supertype];
                document.getElementById('echoName').textContent = `${info.symbol} Écho ${info.name}`;
                nearbyEchoDiv.classList.remove('hidden');
            } else {
                nearbyEchoDiv.classList.add('hidden');
            }
        }

        // ==================== VISIBILITY ====================

        function updatePOIVisibility() {
            const allCards = Object.values(COLLECTIONS).flatMap(c => c.cards);
            const visiblePOIIds = [];
            poiMarkers.forEach(({ marker, el, poi }) => {
                const hasCards = allCards.some(card => card.poiId === poi.id && !collectedCards.includes(card.id));
                el.style.display = hasCards ? 'block' : 'none';
                if (hasCards) visiblePOIIds.push(poi.id);
            });
            // Update the GeoJSON circle source to only show uncollected POIs
            if (map.getSource('poi-circles')) {
                map.getSource('poi-circles').setData({
                    type: 'FeatureCollection',
                    features: POIS
                        .filter(poi => visiblePOIIds.includes(poi.id))
                        .map(poi => ({
                            type: 'Feature',
                            properties: { id: poi.id },
                            geometry: { type: 'Point', coordinates: [poi.lng, poi.lat] }
                        }))
                });
            }
        }

        function updateDustVisibility() {
            const visible = [];
            dustMarkers.forEach(({ marker, el, dust }) => {
                const show = !collectedDustPoints.includes(dust.id);
                el.style.display = show ? 'block' : 'none';
                if (show) visible.push(dust);
            });
            if (map.getSource('dust-circles')) {
                map.getSource('dust-circles').setData({
                    type: 'FeatureCollection',
                    features: visible.map(d => ({
                        type: 'Feature', properties: { id: d.id },
                        geometry: { type: 'Point', coordinates: [d.lng, d.lat] }
                    }))
                });
            }
        }

        function updateEchoVisibility() {
            const visible = [];
            echoMarkers.forEach(({ marker, el, echo }) => {
                const show = !collectedEchoes.includes(echo.id);
                el.style.display = show ? 'block' : 'none';
                if (show) visible.push(echo);
            });
            if (map.getSource('echo-circles')) {
                map.getSource('echo-circles').setData({
                    type: 'FeatureCollection',
                    features: visible.map(e => ({
                        type: 'Feature', properties: { id: e.id },
                        geometry: { type: 'Point', coordinates: [e.lng, e.lat] }
                    }))
                });
            }
        }

        // ==================== COLLECTION ====================

        // ==================== MISE AU POINT ====================

        let mapointCard = null;
        let lastRevealedCard = null;
        let mapointAnimId = null;
        let mapointState = {};

        function openMiseAuPoint(card) {
            mapointCard = card;
            const screen = document.getElementById('miseAuPointScreen');
            screen.classList.add('active');
            initMapointCanvas(card);
        }

        function closeMiseAuPoint() {
            const screen = document.getElementById('miseAuPointScreen');
            screen.classList.remove('active');
            if (mapointAnimId) { cancelAnimationFrame(mapointAnimId); mapointAnimId = null; }
            mapointCard = null;
        }

        function initMapointCanvas(card) {
            const canvas = document.getElementById('mapointCanvas');
            const ctx = canvas.getContext('2d');
            const W = canvas.width  = canvas.offsetWidth;
            const H = canvas.height = canvas.offsetHeight;

            const supertype = card.supertype || 'histoire';
            const info = SUPERTYPES[supertype];
            const color = info.color;

            const hexToRgb = h => {
                const r = parseInt(h.slice(1,3),16), g = parseInt(h.slice(3,5),16), b = parseInt(h.slice(5,7),16);
                return `${r},${g},${b}`;
            };
            const rgb = hexToRgb(color);

            const accordX = W * 0.3 + Math.random() * W * 0.4;
            const accordY = H * 0.25 + Math.random() * H * 0.35;
            const accordR = 55;

            const NUM_FRAGMENTS = 14;
            const fragments = Array.from({length: NUM_FRAGMENTS}, (_, i) => ({
                angle: (i / NUM_FRAGMENTS) * Math.PI * 2,
                radius: 90 + Math.random() * 50,
                speed: (0.003 + Math.random() * 0.004) * (Math.random() > 0.5 ? 1 : -1),
                size:  4 + Math.random() * 7,
                opacity: 0.4 + Math.random() * 0.6,
                phase: Math.random() * Math.PI * 2,
            }));

            let pointer = { x: W / 2, y: H / 2, active: false };
            let focusX = W / 2, focusY = H / 2;
            let inAccordZone = false;
            let accordStart = null;
            let revealed = false;
            let revealProgress = 0;
            let done = false;
            const ACCORD_DURATION = 1500;

            const hint = document.getElementById('mapointHint');
            const ring = document.querySelector('.mapoint-progress-ring');
            const ringEl = document.getElementById('mapointRing');
            const RING_LEN = 213.6;
            hint.style.opacity = '1';
            hint.textContent = 'Déplacez doucement votre doigt pour accorder';
            ring.classList.remove('visible');
            ringEl.style.strokeDashoffset = RING_LEN;

            const canvas2 = document.getElementById('mapointCanvas');
            function getPos(e) {
                const rect = canvas2.getBoundingClientRect();
                const src = e.touches ? e.touches[0] : e;
                return { x: src.clientX - rect.left, y: src.clientY - rect.top };
            }
            function onMove(e) {
                e.preventDefault();
                if (done) return;
                const p = getPos(e);
                pointer = { x: p.x, y: p.y, active: true };
            }
            function onEnd() { pointer.active = false; }
            canvas2.addEventListener('touchmove', onMove, { passive: false });
            canvas2.addEventListener('touchstart', onMove, { passive: false });
            canvas2.addEventListener('touchend', onEnd);
            canvas2.addEventListener('mousemove', onMove);
            canvas2.addEventListener('mousedown', onMove);
            canvas2.addEventListener('mouseup', onEnd);
            mapointState.cleanup = () => {
                canvas2.removeEventListener('touchmove', onMove);
                canvas2.removeEventListener('touchstart', onMove);
                canvas2.removeEventListener('touchend', onEnd);
                canvas2.removeEventListener('mousemove', onMove);
                canvas2.removeEventListener('mousedown', onMove);
                canvas2.removeEventListener('mouseup', onEnd);
            };

            let lastTime = null;

            function draw(ts) {
                if (!lastTime) lastTime = ts;
                const dt = Math.min(ts - lastTime, 50);
                lastTime = ts;

                ctx.clearRect(0, 0, W, H);

                const dx = pointer.x - accordX, dy = pointer.y - accordY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                inAccordZone = pointer.active && dist < accordR && !revealed;

                if (inAccordZone) {
                    if (!accordStart) accordStart = ts;
                    const elapsed = ts - accordStart;
                    ring.classList.add('visible');
                    const progress = Math.min(elapsed / ACCORD_DURATION, 1);
                    ringEl.style.strokeDashoffset = RING_LEN * (1 - progress);
                    ringEl.style.stroke = `rgba(${rgb},${0.7 + progress * 0.3})`;
                    if (elapsed >= ACCORD_DURATION && !revealed) {
                        revealed = true;
                        hint.textContent = '✦ Accord établi ✦';
                        ring.classList.remove('visible');
                    }
                } else {
                    accordStart = null;
                    ring.classList.remove('visible');
                    ringEl.style.strokeDashoffset = RING_LEN;
                }

                if (pointer.active) {
                    focusX += (pointer.x - focusX) * 0.08;
                    focusY += (pointer.y - focusY) * 0.08;
                }

                const cx = W / 2, cy = H * 0.42;
                const fdx = focusX - cx, fdy = focusY - cy;
                const focusDist = Math.sqrt(fdx*fdx + fdy*fdy);
                const maxFocus = Math.sqrt(W*W + H*H) / 2;
                const rawClarity = Math.max(0, 1 - focusDist / (maxFocus * 0.6));
                const clarity = revealed ? Math.min(revealProgress, 1) : rawClarity;
                if (revealed && revealProgress < 1) revealProgress += dt / 1200;

                // Background
                ctx.fillStyle = '#080612';
                ctx.fillRect(0, 0, W, H);
                const bgGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.max(W, H) * 0.85);
                bgGrad.addColorStop(0,   `rgba(${rgb},${0.18 + clarity * 0.15})`);
                bgGrad.addColorStop(0.5, `rgba(${rgb},0.06)`);
                bgGrad.addColorStop(1,   'rgba(0,0,0,0)');
                ctx.fillStyle = bgGrad;
                ctx.fillRect(0, 0, W, H);
                const t = ts * 0.0003;
                const nx = cx + Math.sin(t * 0.7) * 40, ny = cy + Math.cos(t * 0.5) * 30;
                const ng = ctx.createRadialGradient(nx, ny, 0, nx, ny, 180);
                ng.addColorStop(0,   `rgba(${rgb},0.10)`);
                ng.addColorStop(1,   'rgba(0,0,0,0)');
                ctx.fillStyle = ng;
                ctx.fillRect(0, 0, W, H);

                // Fragments
                fragments.forEach(f => {
                    f.angle += f.speed * (revealed ? 0.15 : (1 - clarity * 0.6));
                    const fx = cx + Math.cos(f.angle) * f.radius * (1 - clarity * 0.75);
                    const fy = cy + Math.sin(f.angle) * f.radius * (1 - clarity * 0.75);
                    const pulse = 0.6 + 0.4 * Math.sin(ts * 0.002 + f.phase);
                    const alpha = f.opacity * pulse * (1 - clarity * 0.85);
                    if (alpha < 0.02) return;
                    const fg = ctx.createRadialGradient(fx, fy, 0, fx, fy, f.size * 3);
                    fg.addColorStop(0, `rgba(${rgb},${alpha})`);
                    fg.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = fg;
                    ctx.fillRect(fx - f.size*3, fy - f.size*3, f.size*6, f.size*6);
                    ctx.beginPath();
                    ctx.arc(fx, fy, f.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${rgb},${alpha})`;
                    ctx.fill();
                });

                // Silhouette
                const silW = 90 + clarity * 20;
                const silH = 140 + clarity * 30;
                const blur = Math.max(0, (1 - clarity) * 16);
                ctx.save();
                ctx.filter = blur > 0.5 ? `blur(${blur}px)` : 'none';
                ctx.globalAlpha = 0.15 + clarity * 0.75;
                const sg = ctx.createRadialGradient(cx, cy, 0, cx, cy, silW * 1.8);
                sg.addColorStop(0,   `rgba(${rgb},${0.35 + clarity * 0.45})`);
                sg.addColorStop(1,   'rgba(0,0,0,0)');
                ctx.fillStyle = sg;
                ctx.fillRect(cx - silW*2, cy - silH, silW*4, silH*2.5);
                ctx.fillStyle = revealed ? `rgba(${rgb},0.9)` : `rgba(255,255,255,${0.5 + clarity * 0.4})`;
                // Head
                ctx.beginPath(); ctx.arc(cx, cy - silH * 0.38, silW * 0.28, 0, Math.PI * 2); ctx.fill();
                // Torso
                ctx.beginPath();
                ctx.moveTo(cx - silW*0.38, cy - silH*0.1); ctx.lineTo(cx + silW*0.38, cy - silH*0.1);
                ctx.lineTo(cx + silW*0.28, cy + silH*0.22); ctx.lineTo(cx - silW*0.28, cy + silH*0.22);
                ctx.closePath(); ctx.fill();
                // Arms
                [[- 1],[1]].forEach(([s]) => {
                    ctx.beginPath();
                    ctx.moveTo(cx + s*silW*0.38, cy - silH*0.08);
                    ctx.lineTo(cx + s*silW*0.58, cy + silH*0.15);
                    ctx.lineTo(cx + s*silW*0.45, cy + silH*0.18);
                    ctx.lineTo(cx + s*silW*0.28, cy + silH*0.0);
                    ctx.closePath(); ctx.fill();
                });
                // Legs
                [[-1],[1]].forEach(([s]) => {
                    ctx.beginPath();
                    ctx.moveTo(cx + s*silW*0.18, cy + silH*0.22);
                    ctx.lineTo(cx + s*silW*0.28, cy + silH*0.5);
                    ctx.lineTo(cx + s*silW*0.12, cy + silH*0.5);
                    ctx.lineTo(cx + s*silW*0.05, cy + silH*0.22);
                    ctx.closePath(); ctx.fill();
                });
                ctx.filter = 'none';
                ctx.globalAlpha = 1;
                ctx.restore();

                // Focus lens
                if (pointer.active && !revealed) {
                    const lg = ctx.createRadialGradient(focusX, focusY, 0, focusX, focusY, 80);
                    lg.addColorStop(0, 'rgba(255,255,255,0.07)');
                    lg.addColorStop(1, 'rgba(255,255,255,0)');
                    ctx.fillStyle = lg;
                    ctx.fillRect(focusX - 80, focusY - 80, 160, 160);
                }

                // Celebration burst
                if (revealed && revealProgress > 0.55) {
                    const burstP = Math.min((revealProgress - 0.55) / 0.35, 1);
                    ctx.globalAlpha = burstP * (1 - Math.max(0, (revealProgress - 0.88) / 0.12));
                    for (let i = 0; i < 16; i++) {
                        const a = (i / 16) * Math.PI * 2;
                        const r1 = silW * 0.95 + burstP * 20, r2 = r1 + 30 + burstP * 40;
                        ctx.beginPath();
                        ctx.moveTo(cx + Math.cos(a)*r1, cy + Math.sin(a)*r1);
                        ctx.lineTo(cx + Math.cos(a)*r2, cy + Math.sin(a)*r2);
                        ctx.strokeStyle = `rgba(${rgb},0.9)`;
                        ctx.lineWidth = 2.5;
                        ctx.stroke();
                    }
                    ctx.globalAlpha = 1;
                }

                // Card name reveal
                if (revealProgress > 0.8 && revealed) {
                    const na = Math.min(1, (revealProgress - 0.8) / 0.2);
                    ctx.globalAlpha = na;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'white';
                    ctx.font = `bold 22px system-ui, sans-serif`;
                    ctx.fillText(card.name, cx, cy + silH * 0.7);
                    ctx.font = `14px system-ui, sans-serif`;
                    ctx.fillStyle = color;
                    ctx.fillText(info.name, cx, cy + silH * 0.7 + 26);
                    ctx.globalAlpha = 1;
                }

                // Transition to popup
                if (revealProgress >= 1 && !done) {
                    done = true;
                    setTimeout(() => {
                        mapointState.cleanup?.();
                        closeMiseAuPoint();
                        // Show toast on map with supertype color glow
                        lastRevealedCard = card;
                        document.getElementById('popupCardName').textContent = card.name;
                        document.getElementById('popupCardType').textContent = info.name + ' · ' + card.type;
                        const glow = document.getElementById('toastGlow');
                        glow.style.background = `radial-gradient(ellipse at 20% 50%, ${color}, transparent 70%)`;
                        const toast = document.getElementById('cardPopup');
                        toast.classList.add('show');
                        // Auto-dismiss after 5 seconds
                        setTimeout(() => toast.classList.remove('show'), 5000);
                    }, 700);
                }

                if (!done) mapointAnimId = requestAnimationFrame(draw);
            }

            mapointAnimId = requestAnimationFrame(draw);
        }

        function collectCard() {
            if (!currentNearbyPOI) return;
            const allCards = Object.values(COLLECTIONS).flatMap(c => c.cards);
            const card = allCards.find(c => c.poiId === currentNearbyPOI.id && !collectedCards.includes(c.id));
            if (!card) return;
            collectedCards.push(card.id);
            if (!cardLevels[card.id]) cardLevels[card.id] = { level: 0, experience: 0, dustSpent: 0 };
            updatePOIVisibility();
            checkNearbyPOI();
            openMiseAuPoint(card);
        }

        function collectDust() {
            if (!currentNearbyDust) return;
            collectedDustPoints.push(currentNearbyDust.id);
            const amount = Math.floor(Math.random() * (MAX_DUST_DROP - MIN_DUST_DROP + 1)) + MIN_DUST_DROP;
            memorialDust += amount;
            document.getElementById('dustCounter').textContent = memorialDust;
            updateDustVisibility();
            checkNearbyPOI();
        }

        function collectEcho() {
            if (!currentNearbyEcho) return;
            collectedEchoes.push(currentNearbyEcho.id);
            echoInventory[currentNearbyEcho.supertype]++;
            updateEchoVisibility();
            checkNearbyPOI();
        }

        function closeCardPopup() {
            document.getElementById('cardPopup').classList.remove('show');
        }

        function openRevealedCard() {
            if (!lastRevealedCard) return;
            closeCardPopup();
            // Small delay so the toast closes cleanly before opening card
            setTimeout(() => openCardDetail(lastRevealedCard), 150);
        }

        // ==================== COLLECTIONS UI ====================

        let currentColTab = 'collections';

        // ==================== AVATAR MENU ====================

        function toggleAvatarMenu() {
            const menu = document.getElementById('avatarMenu');
            menu.classList.toggle('hidden');
        }

        function closeAvatarMenu() {
            document.getElementById('avatarMenu').classList.add('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const wrap = document.getElementById('avatarBtn')?.closest('.hud-avatar-wrap');
            if (wrap && !wrap.contains(e.target)) closeAvatarMenu();
        });

        function openCollections() {
            document.getElementById('collectionsPanel').classList.add('show');
            switchColTab('collections');
        }

        function closeCollections() {
            document.getElementById('collectionsPanel').classList.remove('show');
            selectedCollectionId = null;
            document.getElementById('collectionsList').classList.remove('hidden');
            document.getElementById('collectionDetail').classList.remove('show');
        }

        function switchColTab(tab) {
            currentColTab = tab;
            document.querySelectorAll('.col-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`colTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            document.getElementById('colPaneCollections').classList.toggle('hidden', tab !== 'collections');
            document.getElementById('colPaneEchoes').classList.toggle('hidden', tab !== 'echoes');
            if (tab === 'collections') renderCollectionsList();
            if (tab === 'echoes') renderEchoesPanel();
        }

        function renderEchoesPanel() {
            const panel = document.getElementById('echoesPanel');
            panel.innerHTML = '';

            const hasAny = Object.values(echoInventory).some(v => v > 0);

            if (!hasAny) {
                panel.innerHTML = `<div class="echo-empty"><div style="font-size:48px;margin-bottom:12px;">✨</div><div>Aucun écho collecté pour le moment.<br>Explorez Lyon pour en trouver !</div></div>`;
                return;
            }

            // All cards across all collections
            const allCards = Object.values(COLLECTIONS).flatMap(col => col.cards);

            Object.entries(SUPERTYPES).forEach(([supertypeKey, supertypeInfo]) => {
                const count = echoInventory[supertypeKey] || 0;

                // Find all cards matching this supertype (primary OR secondary)
                const matchingCards = allCards.filter(c => c.supertype === supertypeKey || c.supertype2 === supertypeKey);
                if (matchingCards.length === 0) return;

                const section = document.createElement('div');
                section.className = 'echo-type-section';

                section.innerHTML = `
                    <div class="echo-type-header supertype-${supertypeKey}">
                        <span style="font-size:20px;">${supertypeInfo.symbol}</span>
                        <span>${supertypeInfo.name}</span>
                        <span class="echo-type-count">${count} écho${count > 1 ? 's' : ''}</span>
                    </div>
                    <div class="echo-compatible-cards" id="echoCards_${supertypeKey}"></div>
                `;

                panel.appendChild(section);

                const cardsContainer = document.getElementById(`echoCards_${supertypeKey}`);

                matchingCards.forEach(card => {
                    const isCollected = collectedCards.includes(card.id);
                    const rarityInfo = RARITY_CONFIG[card.rarity] || RARITY_CONFIG.common;

                    const cardEl = document.createElement('div');
                    cardEl.className = `echo-compatible-card${isCollected ? '' : ' not-collected'}`;

                    if (isCollected) {
                        cardEl.onclick = () => {
                            closeCollections();
                            openCardDetail(card);
                        };
                    }

                    cardEl.innerHTML = `
                        <div class="echo-card-icon supertype-${supertypeKey}">
                            ${isCollected ? '🎴' : '❓'}
                        </div>
                        <div class="echo-card-info">
                            <div class="echo-card-name">${isCollected ? card.name : '???'}</div>
                            <div class="echo-card-meta">${isCollected ? card.type : 'Carte non collectée'} · <span style="color:${rarityInfo.color};font-weight:600;">${rarityInfo.name}</span></div>
                        </div>
                        <span class="echo-card-status ${isCollected ? 'collected' : 'locked'}">
                            ${isCollected ? '✓ Collectée' : '🔒 Verr.'}
                        </span>
                    `;

                    cardsContainer.appendChild(cardEl);
                });
            });
        }

        function renderCollectionsList() {
            const listDiv = document.getElementById('collectionsList');
            listDiv.innerHTML = '';
            const cols = Object.values(COLLECTIONS).filter(col => col.cards.some(c => collectedCards.includes(c.id)));
            if (cols.length === 0) {
                listDiv.innerHTML = `<div class="empty-state"><div class="empty-icon">📦</div><p>Aucune carte collectée pour le moment</p><p style="font-size:14px;margin-top:8px;">Explorez Lyon pour commencer votre collection!</p></div>`;
                return;
            }
            cols.forEach(col => {
                const p = getCollectionProgress(col.id);
                const div = document.createElement('div');
                div.className = 'collection-item';
                div.onclick = () => showCollectionDetail(col.id);
                div.innerHTML = `
                    <div class="collection-item-header">
                        <div><h3 class="collection-item-title">${col.name}</h3><p class="collection-item-desc">${col.description}</p></div>
                        <span class="collection-badge">${p.collected}/${p.total}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${(p.collected/p.total)*100}%"></div></div>`;
                listDiv.appendChild(div);
            });
        }

        function getCollectionProgress(collectionId) {
            const col = COLLECTIONS[collectionId];
            return { collected: col.cards.filter(c => collectedCards.includes(c.id)).length, total: col.cards.length };
        }

        function showCollectionDetail(collectionId) {
            selectedCollectionId = collectionId;
            const col = COLLECTIONS[collectionId];
            const p = getCollectionProgress(collectionId);
            document.getElementById('detailTitle').textContent = col.name;
            document.getElementById('detailDesc').textContent = col.description;
            document.getElementById('detailBadge').textContent = `${p.collected}/${p.total} cartes`;
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            col.cards.forEach(card => {
                const isCollected = collectedCards.includes(card.id);
                const div = document.createElement('div');
                div.className = `card-item ${isCollected ? 'collected' : 'locked'}`;
                if (isCollected) div.onclick = () => openCardDetail(card);
                div.innerHTML = `<div class="card-icon">${isCollected ? '🎴' : '❓'}</div><div class="card-name">${isCollected ? card.name : '???'}</div><div class="card-type">${isCollected ? card.type : 'Non collectée'}</div>`;
                grid.appendChild(div);
            });
            document.getElementById('collectionsList').classList.add('hidden');
            document.getElementById('collectionDetail').classList.add('show');
        }

        function backToCollections() {
            selectedCollectionId = null;
            document.getElementById('collectionsList').classList.remove('hidden');
            document.getElementById('collectionDetail').classList.remove('show');
        }

        // ==================== CARD DETAIL ====================

        function openCardDetail(card) {
            selectedCard = card;
            if (!cardLevels[card.id]) cardLevels[card.id] = { level: 0, experience: 0, dustSpent: 0 };
            document.getElementById('cardDetailHeaderTitle').textContent = card.name;
            document.getElementById('cardDetailName').textContent = card.name;
            document.getElementById('cardCategory').textContent = card.type;
            if (card.supertype) {
                const info = SUPERTYPES[card.supertype];
                const badge = document.getElementById('cardSupertypeBadge');
                badge.textContent = info.symbol;
                badge.className = `card-supertype-badge supertype-${card.supertype}`;
                const badge2 = document.getElementById('cardSupertypeBadge2');
                if (card.supertype2) {
                    const info2 = SUPERTYPES[card.supertype2];
                    badge2.textContent = info2.symbol;
                    badge2.className = `card-supertype-badge2 supertype-${card.supertype2}`;
                    badge2.classList.remove('hidden');
                } else {
                    badge2.classList.add('hidden');
                }
            }
            document.getElementById('cardDetailDustCounter').textContent = memorialDust;
            updateCardLevelDisplay();
            switchTabProgrammatically('general');
            document.getElementById('cardDetailView').classList.add('show');
        }

        function closeCardDetail() {
            document.getElementById('cardDetailView').classList.remove('show');
            selectedCard = null;
        }

        function getRarityGemHTML(rarity) {
            const cfg = RARITY_CONFIG[rarity] || RARITY_CONFIG.common;
            return `<div class="gem-${cfg.shape}" style="background: ${cfg.color};"></div>`;
        }

        function getExpNeeded(card, level) {
            const rarity = card.rarity || 'common';
            return RARITY_CONFIG[rarity].exp[level] || 0;
        }

        function updateCardLevelDisplay() {
            if (!selectedCard) return;
            const cl = cardLevels[selectedCard.id] || { level: 0, experience: 0 };
            document.getElementById('cardLevelDisplay').textContent = `Niveau ${cl.level}`;
            document.getElementById('cardRarityGem').innerHTML = getRarityGemHTML(selectedCard.rarity);
            if (cl.level >= MAX_LEVEL) {
                document.getElementById('cardExpDisplay').textContent = 'MAX';
                document.getElementById('cardExpBar').style.width = '100%';
                document.getElementById('addExpBtn').disabled = true;
                document.getElementById('addExpBtn').textContent = '✨ Niveau maximum atteint';
                return;
            }
            const needed = getExpNeeded(selectedCard, cl.level);
            document.getElementById('cardExpDisplay').textContent = `${cl.experience}/${needed} 💜`;
            document.getElementById('cardExpBar').style.width = `${(cl.experience / needed) * 100}%`;
            const btn = document.getElementById('addExpBtn');
            const canAdd = memorialDust >= DUST_INCREMENT;
            btn.disabled = !canAdd;
            btn.textContent = canAdd ? `💜 Ajouter ${DUST_INCREMENT} poudre (+EXP)` : `💜 Poudre insuffisante (${memorialDust}/${DUST_INCREMENT})`;
        }

        function addExperience() {
            if (!selectedCard || memorialDust < DUST_INCREMENT) return;
            const cl = cardLevels[selectedCard.id];
            if (cl.level >= MAX_LEVEL) return;
            memorialDust -= DUST_INCREMENT;
            document.getElementById('dustCounter').textContent = memorialDust;
            document.getElementById('cardDetailDustCounter').textContent = memorialDust;
            cl.dustSpent = (cl.dustSpent || 0) + DUST_INCREMENT;
            cl.experience += DUST_INCREMENT;
            const needed = getExpNeeded(selectedCard, cl.level);
            if (cl.experience >= needed) {
                cl.level += 1;
                cl.experience = Math.max(0, cl.experience - needed);
                const frame = document.querySelector('.card-frame');
                frame.style.animation = 'levelUpPulse 0.6s ease';
                setTimeout(() => {
                    frame.style.animation = '';
                    // Open journal with previous state (level-1 overlays shown, new slot empty)
                    openJournalScreen(cl.level - 1);
                    // Then animate the new overlay after a short pause for drama
                    setTimeout(() => animateJournalLevel(cl.level), 300);
                }, 600);
            }
            if (cl.dustSpent === 100) {
                document.getElementById('journalNotification').classList.remove('hidden');
                setTimeout(() => showCardDialogue(true), 500);
            }
            updateCardLevelDisplay();
        }

        function showCardDialogue(isMilestone = false) {
            const bubble = document.getElementById('cardDialogueBubble');
            const text = document.getElementById('cardDialogueText');
            if (isMilestone) {
                text.textContent = CARD_DIALOGUES.milestone;
            } else {
                text.textContent = CARD_DIALOGUES.random[Math.floor(Math.random() * CARD_DIALOGUES.random.length)];
            }
            bubble.classList.add('show');
            setTimeout(() => bubble.classList.remove('show'), 4000);
        }

        function switchTab(tabName, e) {
            currentTab = tabName;
            document.querySelectorAll('.card-tab:not(.journal-tab):not(.studio-tab)').forEach(t => t.classList.remove('active'));
            if (e && e.target) e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const map2 = { general: 'generalTab', skins: 'skinsTab', competences: 'competencesTab' };
            if (map2[tabName]) document.getElementById(map2[tabName]).classList.add('active');
        }

        function switchTabProgrammatically(tabName) {
            currentTab = tabName;
            const tabs = document.querySelectorAll('.card-tab:not(.journal-tab):not(.studio-tab)');
            tabs.forEach(t => t.classList.remove('active'));
            if (tabs[0]) tabs[0].classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const map2 = { general: 'generalTab', skins: 'skinsTab', competences: 'competencesTab' };
            if (map2[tabName]) document.getElementById(map2[tabName]).classList.add('active');
        }

        // ==================== JOURNAL ====================

        function openJournalScreen(maxLevel) {
            if (!selectedCard) return;
            document.getElementById('journalScreenCardName').textContent = selectedCard.name;
            document.getElementById('journalScreenCardType').textContent = selectedCard.type;
            document.getElementById('journalNotification').classList.add('hidden');
            // Restore this card's journal state (maxLevel limits overlay restore for animation)
            restoreJournalState(selectedCard.id, maxLevel);
            document.getElementById('journalScreen').classList.add('show');
            renderEchoInventory();
        }

        const OVERLAY_COLORS = [
            'linear-gradient(180deg, #10B981 0%, #059669 100%)',
            'linear-gradient(180deg, #3B82F6 0%, #2563EB 100%)',
            'linear-gradient(180deg, #F59E0B 0%, #D97706 100%)'
        ];

        function resetJournalOverlays() {
            // Instantly clear all overlays (no transition)
            ['journalLevelOverlay1','journalLevelOverlay2','journalLevelOverlay3'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.style.transition = 'none';
                el.style.height = '0%';
                el.style.background = '';
            });
            ['journalBtn1','journalBtn2','journalBtn3'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        function applyOverlaysInstant(level) {
            const ids = ['journalLevelOverlay1','journalLevelOverlay2','journalLevelOverlay3'];
            for (let i = 0; i < level && i < 3; i++) {
                const el = document.getElementById(ids[i]);
                if (!el) continue;
                el.style.transition = 'none';
                el.style.background = OVERLAY_COLORS[i];
                el.style.height = '33.33%';
                const btn = document.getElementById(`journalBtn${i+1}`);
                if (btn) btn.style.display = 'block';
            }
        }

        function restoreJournalState(cardId, maxLevel) {
            // Reset slots
            for (let i = 1; i <= 3; i++) {
                const slot = document.getElementById(`echoSlot${i}`);
                const content = slot.querySelector('.echo-slot-content');
                content.textContent = '';
                content.style.background = '';
                slot.className = 'echo-slot';
                slot.setAttribute('ondragover', 'allowDrop(event)');
                slot.setAttribute('ondrop', 'dropEcho(event)');
                const unlockedDiv = document.getElementById(`unlockedContent${i}`);
                if (unlockedDiv) unlockedDiv.classList.add('hidden');
            }
            // Reset overlays instantly
            resetJournalOverlays();
            // Re-apply echo slots
            const journal = cardJournals[cardId] || {};
            Object.entries(journal).forEach(([slotId, supertype]) => {
                placeEchoInSlot(slotId, supertype);
            });
            // Re-apply level overlays instantly (maxLevel caps restore for level-up animation)
            const cl = cardLevels[cardId];
            const levelToShow = (maxLevel !== undefined) ? maxLevel : (cl ? cl.level : 0);
            if (levelToShow > 0) applyOverlaysInstant(levelToShow);
        }

        function closeJournalScreen() {
            document.getElementById('journalScreen').classList.remove('show');
        }

        // ==================== STUDIO ====================

        const STUDIO_ITEMS = {
            window: {
                icon: '🖼️',
                name: 'Fenêtre magique',
                desc: 'Une fenêtre qui s\'ouvre sur des panoramas de Lyon à travers les âges. La lumière qui en filtre change selon l\'heure.'
            },
            bookshelf: {
                icon: '📚',
                name: 'Bibliothèque',
                desc: 'Remplie de volumes sur l\'histoire de Lyon. Chaque carte collectée y ajoute un nouveau chapitre.'
            },
            desk: {
                icon: '🗃️',
                name: 'Bureau de recherche',
                desc: 'Vos notes et cartes d\'exploration s\'y accumulent. Un endroit idéal pour organiser vos découvertes.'
            },
            chest: {
                icon: '💎',
                name: 'Coffre aux merveilles',
                desc: 'Un coffre mystérieux qui contient vos plus précieux artefacts. Il grandit à mesure que vous collectez.'
            },
            plant: {
                icon: '🌿',
                name: 'Plante mémorielle',
                desc: 'Une plante rare qui fleurit chaque fois que vous débloquez un nouveau contenu dans vos carnets.'
            },
            armchair: {
                icon: '💺',
                name: 'Fauteuil de lecture',
                desc: 'Un fauteuil confortable pour relire vos carnets et méditer sur vos découvertes lyonnaises.'
            },
            lamp: {
                icon: '🕯️',
                name: 'Lampe à mémoire',
                desc: 'Sa lumière s\'intensifie avec chaque poudre mémorielle collectée. Elle illumine vos souvenirs.'
            },
            mirror: {
                icon: '🔮',
                name: 'Miroir de réflexion',
                desc: 'Reflète les échos que vous avez récoltés. Regardez-y pour voir les connexions entre vos cartes.'
            },
            globe: {
                icon: '🌍',
                name: 'Globe de Lyon',
                desc: 'Retourne à la carte d\'exploration. Tous vos points d\'intérêt y sont marqués en lumière.'
            },
            arch: {
                icon: '🌀',
                name: 'Arche de retour',
                desc: 'Un portail magique qui vous ramène à la carte d\'exploration de Lyon.'
            },
            harp: {
                icon: '🎵',
                name: 'Harpe lyonnaise',
                desc: 'Joue les mélodies associées à vos cartes de type Arts. Chaque note est un souvenir.'
            },
            cauldron: {
                icon: '💧',
                name: 'Chaudron alchimique',
                desc: 'Permet de fusionner des poudres mémorielles pour créer des échos rares. En cours de développement...'
            }
        };

        let studioOwnedItems = ['window', 'bookshelf', 'desk', 'chest', 'plant', 'armchair', 'lamp', 'globe'];

        function openStudioScreen() {
            document.getElementById('studioCardName').textContent = selectedCard ? selectedCard.name : '';
            document.getElementById('studioDustCounter').textContent = memorialDust;
            updateStudioShop();
            document.getElementById('studioScreen').classList.add('show');
        }

        function openStudioFromMap() {
            // Open studio without requiring a selected card
            document.getElementById('studioCardName').textContent = 'Mon espace';
            document.getElementById('studioDustCounter').textContent = memorialDust;
            updateStudioShop();
            document.getElementById('studioScreen').classList.add('show');
        }

        function closeStudioScreen() {
            document.getElementById('studioScreen').classList.remove('show');
            closeStudioTooltip();
        }

        function studioItemClick(itemId) {
            // Special actions
            if (itemId === 'globe' || itemId === 'arch') {
                closeStudioScreen();
                return;
            }
            if (itemId === 'bookshelf') {
                closeStudioScreen();
                openCollections();
                return;
            }

            const item = STUDIO_ITEMS[itemId];
            if (!item) return;
            const tooltip = document.getElementById('studioTooltip');
            document.getElementById('tooltipIcon').textContent = item.icon;
            document.getElementById('tooltipName').textContent = item.name;
            document.getElementById('tooltipDesc').textContent = item.desc;
            tooltip.classList.remove('hidden');
        }

        function closeStudioTooltip() {
            document.getElementById('studioTooltip').classList.add('hidden');
        }

        function buyStudioItem(itemId, price) {
            if (studioOwnedItems.includes(itemId)) return;
            if (memorialDust < price) {
                const tooltip = document.getElementById('studioTooltip');
                document.getElementById('tooltipIcon').textContent = '💜';
                document.getElementById('tooltipName').textContent = 'Poudre insuffisante';
                document.getElementById('tooltipDesc').textContent = `Il vous faut ${price} poudres mémorielle pour débloquer cet objet. Vous en avez ${memorialDust}.`;
                tooltip.classList.remove('hidden');
                return;
            }
            memorialDust -= price;
            document.getElementById('dustCounter').textContent = memorialDust;
            document.getElementById('studioDustCounter').textContent = memorialDust;
            studioOwnedItems.push(itemId);

            // Add item to the scene
            addItemToScene(itemId);
            updateStudioShop();

            // Show success tooltip
            const item = STUDIO_ITEMS[itemId];
            const tooltip = document.getElementById('studioTooltip');
            document.getElementById('tooltipIcon').textContent = item.icon;
            document.getElementById('tooltipName').textContent = `${item.name} ajouté !`;
            document.getElementById('tooltipDesc').textContent = `Nouvel objet ajouté à votre studio. ${item.desc}`;
            tooltip.classList.remove('hidden');
        }

        // SVG snippets for buyable items
        const STUDIO_ITEM_SVG = {
            mirror: `<g id="item-mirror" onclick="studioItemClick('mirror')" style="cursor:pointer;opacity:0">
              <polygon points="0,45 35,30 35,50 0,65" fill="#3d2010"/>
              <polygon points="5,42 30,28 30,32 5,46" fill="#8c5020" opacity="0.8"/>
              <ellipse cx="17" cy="22" rx="12" ry="16" fill="#1a1a3e" stroke="#a070d0" stroke-width="2"/>
              <ellipse cx="17" cy="22" rx="9" ry="13" fill="#22224e"/>
              <ellipse cx="12" cy="15" rx="4" ry="5" fill="rgba(180,120,255,0.25)"/>
              <text x="17" y="68" font-size="8" fill="rgba(255,220,120,0.8)" text-anchor="middle" font-family="sans-serif">Miroir</text>
            </g>`,
            harp: `<g id="item-harp" onclick="studioItemClick('harp')" style="cursor:pointer;opacity:0">
              <polygon points="0,50 45,34 45,54 0,70" fill="#3d2010"/>
              <line x1="8" y1="48" x2="8" y2="5" stroke="#a06820" stroke-width="3"/>
              <path d="M8,5 Q40,-5 38,35" fill="none" stroke="#c88030" stroke-width="3"/>
              <line x1="38" y1="35" x2="8" y2="48" stroke="#8c5010" stroke-width="3"/>
              <line x1="12" y1="44" x2="16" y2="10" stroke="#ffd080" stroke-width="1"/>
              <line x1="18" y1="42" x2="22" y2="8" stroke="#ffd080" stroke-width="1"/>
              <line x1="24" y1="40" x2="28" y2="7" stroke="#ffd080" stroke-width="1"/>
              <line x1="30" y1="40" x2="33" y2="10" stroke="#ffd080" stroke-width="1"/>
              <line x1="35" y1="40" x2="37" y2="17" stroke="#ffd080" stroke-width="1"/>
              <text x="22" y="78" font-size="8" fill="rgba(255,220,120,0.8)" text-anchor="middle" font-family="sans-serif">Harpe</text>
            </g>`,
            cauldron: `<g id="item-cauldron" onclick="studioItemClick('cauldron')" style="cursor:pointer;opacity:0">
              <ellipse cx="30" cy="60" rx="28" ry="7" fill="rgba(0,0,0,0.4)"/>
              <polygon points="5,52 55,38 55,48 5,62" fill="#1a1a1a"/>
              <ellipse cx="30" cy="48" rx="28" ry="12" fill="#2a2a2a"/>
              <ellipse cx="30" cy="38" rx="24" ry="10" fill="#1a1a1a"/>
              <ellipse cx="30" cy="38" rx="22" ry="8" fill="#0a1520"/>
              <ellipse cx="30" cy="36" rx="18" ry="6" fill="#0f2535" opacity="0.8"/>
              <circle cx="22" cy="34" r="3" fill="rgba(0,180,255,0.6)"/>
              <circle cx="35" cy="32" r="2" fill="rgba(0,220,255,0.5)"/>
              <circle cx="30" cy="30" r="2.5" fill="rgba(80,160,255,0.4)"/>
              <line x1="6" y1="40" x2="16" y2="34" stroke="#5a5a5a" stroke-width="3"/>
              <line x1="54" y1="32" x2="44" y2="26" stroke="#5a5a5a" stroke-width="3"/>
              <text x="30" y="72" font-size="8" fill="rgba(255,220,120,0.8)" text-anchor="middle" font-family="sans-serif">Chaudron</text>
            </g>`
        };

        const STUDIO_ITEM_POS = {
            mirror:   'translate(60,90)',
            harp:     'translate(195,155)',
            cauldron: 'translate(78,165)'
        };

        function addItemToScene(itemId) {
            const svg = document.getElementById('studioSvg');
            if (!svg || !STUDIO_ITEM_SVG[itemId]) return;
            const tmp = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            tmp.innerHTML = STUDIO_ITEM_SVG[itemId];
            const g = tmp.firstElementChild;
            g.setAttribute('transform', STUDIO_ITEM_POS[itemId] || 'translate(150,150)');
            svg.appendChild(g);
            // Animate in
            requestAnimationFrame(() => {
                g.style.transition = 'opacity 0.5s ease';
                g.style.opacity = '1';
            });
        }

        function updateStudioShop() {
            document.querySelectorAll('.shop-item').forEach(el => {
                const itemId = el.getAttribute('onclick')?.match(/'(\w+)'/)?.[1];
                if (itemId && studioOwnedItems.includes(itemId)) {
                    el.classList.add('owned');
                    el.querySelector('.shop-item-price').textContent = '✓ Acquis';
                }
            });
        }

        function animateJournalLevel(level) {
            // Animate only the NEW overlay for `level` (previous ones already set by restoreJournalState)
            const idx = level - 1; // 0-based index of the new overlay
            if (idx < 0 || idx > 2) return;
            const id = ['journalLevelOverlay1','journalLevelOverlay2','journalLevelOverlay3'][idx];
            const el = document.getElementById(id);
            if (!el) return;
            // Set color, re-enable transition, then trigger height
            el.style.background = OVERLAY_COLORS[idx];
            el.style.transition = ''; // re-enable CSS transition
            // Force browser to register the transition before changing height
            el.getBoundingClientRect(); // trigger reflow
            el.style.height = '33.33%';
            // Show interaction button after animation
            setTimeout(() => {
                const btn = document.getElementById(`journalBtn${level}`);
                if (btn) btn.style.display = 'block';
                document.getElementById('journalNotification').classList.remove('hidden');
            }, 1400);
        }

        // ==================== ECHOES ====================

        // Touch drag state
        let touchDragSupertype = null;
        let touchDragGhost = null;

        function createTouchGhost(supertype, info) {
            const ghost = document.createElement('div');
            ghost.style.cssText = `
                position: fixed; z-index: 9999; pointer-events: none;
                width: 48px; height: 48px; border-radius: 50%;
                background: ${info.color}; border: 3px solid white;
                display: flex; align-items: center; justify-content: center;
                font-size: 22px; opacity: 0.85;
                box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                transform: translate(-50%, -50%) scale(1.15);
                transition: transform 0.05s;
            `;
            ghost.textContent = info.symbol;
            document.body.appendChild(ghost);
            return ghost;
        }

        function getSlotAtPoint(x, y) {
            const slots = document.querySelectorAll('.echo-slot:not(.filled)');
            for (const slot of slots) {
                const r = slot.getBoundingClientRect();
                if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) return slot;
            }
            return null;
        }

        function renderEchoInventory() {
            if (!selectedCard) return;
            const div = document.getElementById('echoInventory');
            div.innerHTML = '';

            // Collect valid supertypes for this card
            const validTypes = [selectedCard.supertype];
            if (selectedCard.supertype2) validTypes.push(selectedCard.supertype2);

            const anyEcho = validTypes.some(st => (echoInventory[st] || 0) > 0);
            if (!anyEcho) {
                const label = validTypes.map(st => SUPERTYPES[st].name).join(' / ');
                div.innerHTML = `<div style="color:#9ca3af;text-align:center;width:100%;padding:20px;">Aucun écho ${label}</div>`;
                return;
            }

            validTypes.forEach(function(st) {
                const count = echoInventory[st] || 0;
                if (count === 0) return;
                const info = SUPERTYPES[st];

                const item = document.createElement('div');
                item.className = 'echo-inventory-item';

                const orb = document.createElement('div');
                orb.className = 'echo-orb supertype-' + st;
                orb.draggable = true;
                orb.textContent = info.symbol;
                orb.dataset.supertype = st;

                // ── Mouse drag (desktop) ──
                orb.ondragstart = function(e) { e.dataTransfer.setData('supertype', st); orb.classList.add('dragging'); };
                orb.ondragend = function() { orb.classList.remove('dragging'); };

                // ── Touch drag (mobile) ──
                orb.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    touchDragSupertype = st;
                    const t = e.touches[0];
                    touchDragGhost = createTouchGhost(st, info);
                    touchDragGhost.style.left = t.clientX + 'px';
                    touchDragGhost.style.top  = t.clientY + 'px';
                    orb.classList.add('dragging');
                }, { passive: false });

                orb.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    if (!touchDragGhost) return;
                    const t = e.touches[0];
                    touchDragGhost.style.left = t.clientX + 'px';
                    touchDragGhost.style.top  = t.clientY + 'px';
                    document.querySelectorAll('.echo-slot').forEach(function(s) { s.classList.remove('drag-over'); });
                    const slot = getSlotAtPoint(t.clientX, t.clientY);
                    if (slot && !slot.classList.contains('filled')) slot.classList.add('drag-over');
                }, { passive: false });

                orb.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!touchDragGhost) return;
                    const t = e.changedTouches[0];
                    const slot = getSlotAtPoint(t.clientX, t.clientY);
                    document.querySelectorAll('.echo-slot').forEach(function(s) { s.classList.remove('drag-over'); });
                    touchDragGhost.remove(); touchDragGhost = null;
                    orb.classList.remove('dragging');
                    if (slot && !slot.classList.contains('filled') && touchDragSupertype) {
                        const slotId = slot.dataset.slotId;
                        if (validTypes.includes(touchDragSupertype)) {
                            placeEchoInSlot(slotId, touchDragSupertype);
                            echoInventory[touchDragSupertype]--;
                            renderEchoInventory();
                        }
                    }
                    touchDragSupertype = null;
                }, { passive: false });

                if (count > 1) {
                    const badge = document.createElement('div');
                    badge.className = 'echo-count';
                    badge.textContent = count;
                    item.appendChild(badge);
                }
                item.appendChild(orb);
                div.appendChild(item);
            });
        }

        function allowDrop(event) {
            event.preventDefault();
            const slot = event.currentTarget;
            if (!slot.classList.contains('filled')) slot.classList.add('drag-over');
        }

        function dropEcho(event) {
            event.preventDefault();
            const slot = event.currentTarget;
            slot.classList.remove('drag-over');
            if (slot.classList.contains('filled')) return;
            const supertype = event.dataTransfer.getData('supertype');
            const slotId = slot.dataset.slotId;
            if (!supertype || !slotId) return;
            const validTypes = [selectedCard.supertype];
            if (selectedCard.supertype2) validTypes.push(selectedCard.supertype2);
            if (selectedCard && validTypes.includes(supertype)) {
                placeEchoInSlot(slotId, supertype);
                echoInventory[supertype]--;
                renderEchoInventory();
            }
        }

        function placeEchoInSlot(slotId, supertype) {
            const slotNum = slotId.replace('slot', '');
            const slot = document.getElementById(`echoSlot${slotNum}`);
            const content = slot.querySelector('.echo-slot-content');
            const info = SUPERTYPES[supertype];
            content.textContent = info.symbol;
            content.style.background = info.color;
            slot.classList.add('filled', `supertype-${supertype}`);
            // Save per-card
            if (selectedCard) {
                if (!cardJournals[selectedCard.id]) cardJournals[selectedCard.id] = {};
                cardJournals[selectedCard.id][slotId] = supertype;
            }
            placedEchoes[slotId] = supertype; // kept for compat
            const contentDiv = document.getElementById(`unlockedContent${slotNum}`);
            if (contentDiv) {
                contentDiv.querySelector('.unlocked-content-text').textContent = ECHO_UNLOCKS[slotId];
                contentDiv.classList.remove('hidden');
            }
        }

        // ==================== GPS ====================

        function startGPS() {
            if (!('geolocation' in navigator)) return;
            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    playerPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    if (playerMarker && map) {
                        map.easeTo({
                            center: [playerPos.lng, playerPos.lat + CAM_LAT_OFFSET],
                            duration: 300
                        });
                        updatePlayerOnMap();
                    }
                    checkNearbyPOI();
                },
                (error) => { console.error('Erreur GPS:', error); gpsActive = false; },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
            gpsActive = true;
        }
        // ==================== PROGRESSION SYSTEM ====================

        // ---- Config ----
        const PLAYER_RANKS = [
            { level: 1,  name: 'Novice',           title: 'Les premiers pas de l\'explorateur', xpNeeded: 0,    icon: '🌱' },
            { level: 2,  name: 'Curieux',           title: 'La curiosité éveille la mémoire',    xpNeeded: 100,  icon: '🔍' },
            { level: 3,  name: 'Flâneur',           title: 'Les rues n\'ont plus de secrets',    xpNeeded: 250,  icon: '🚶' },
            { level: 4,  name: 'Chroniqueur',       title: 'Gardien des récits lyonnais',         xpNeeded: 500,  icon: '📖' },
            { level: 5,  name: 'Passeur',           title: 'Passeur de mémoire collective',       xpNeeded: 900,  icon: '🕯️' },
            { level: 6,  name: 'Archiviste',        title: 'Maître des archives de Lyon',         xpNeeded: 1400, icon: '📜' },
            { level: 7,  name: 'Mémoriel',          title: 'La ville n\'a plus d\'ombre pour toi',xpNeeded: 2000, icon: '🏛️' },
            { level: 8,  name: 'Écho Vivant',       title: 'Tu es devenu un écho toi-même',       xpNeeded: 3000, icon: '✨' },
            { level: 9,  name: 'Gardien de Lyon',   title: 'La cité te confie ses secrets',       xpNeeded: 4500, icon: '🦁' },
            { level: 10, name: 'Légende',           title: 'Ton nom résonne dans les siècles',    xpNeeded: 6500, icon: '👑' },
        ];

        const BATTLEPASS_NODES = [
            { palier: 1,  icon: '💜',  name: '+50 Poudre',          type: 'Poudre mémorielle',  xpRequired: 0   },
            { palier: 2,  icon: '🎴',  name: 'Carte bonus : Guignol', type: 'Carte rare',       xpRequired: 50  },
            { palier: 3,  icon: '💜',  name: '+100 Poudre',         type: 'Poudre mémorielle',  xpRequired: 120 },
            { palier: 4,  icon: '🎨',  name: 'Skin Aurora',         type: 'Skin de carte',      xpRequired: 220 },
            { palier: 5,  icon: '⭐',  name: 'Badge Flâneur',       type: 'Titre spécial',      xpRequired: 350, milestone: true },
            { palier: 6,  icon: '💜',  name: '+150 Poudre',         type: 'Poudre mémorielle',  xpRequired: 500 },
            { palier: 7,  icon: '✨',  name: '3 Échos Histoire',    type: 'Échos rares',        xpRequired: 680 },
            { palier: 8,  icon: '🏠',  name: 'Déco Studio : Parchemin', type: 'Décoration',    xpRequired: 880 },
            { palier: 9,  icon: '💜',  name: '+200 Poudre',         type: 'Poudre mémorielle',  xpRequired: 1100 },
            { palier: 10, icon: '🦁',  name: 'Carte Légendaire : Fourvière', type: 'Légendaire', xpRequired: 1350, milestone: true },
            { palier: 11, icon: '💜',  name: '+250 Poudre',         type: 'Poudre mémorielle',  xpRequired: 1620 },
            { palier: 12, icon: '🎴',  name: 'Carte : Saône la Bleue', type: 'Carte exclusive', xpRequired: 1920 },
            { palier: 13, icon: '🌿',  name: '5 Échos Nature',      type: 'Échos rares',        xpRequired: 2250 },
            { palier: 14, icon: '🎨',  name: 'Skin Crépuscule',     type: 'Skin de carte',      xpRequired: 2600 },
            { palier: 15, icon: '👑',  name: 'Titre : Passeur de Mémoire', type: 'Titre légendaire', xpRequired: 3000, milestone: true },
            { palier: 16, icon: '💜',  name: '+300 Poudre',         type: 'Poudre mémorielle',  xpRequired: 3420 },
            { palier: 17, icon: '🏛️',  name: 'Écho légendaire x1',  type: 'Écho légendaire',   xpRequired: 3870 },
            { palier: 18, icon: '🎴',  name: 'Carte : Le Vieux-Lyon', type: 'Carte exclusive',  xpRequired: 4350 },
            { palier: 19, icon: '💜',  name: '+400 Poudre',         type: 'Poudre mémorielle',  xpRequired: 4860 },
            { palier: 20, icon: '✨',  name: 'Cadre dorée pour cartes', type: 'Décoration',     xpRequired: 5400, milestone: true },
            { palier: 21, icon: '🎨',  name: 'Skin Nebula',         type: 'Skin de carte',      xpRequired: 5970 },
            { palier: 22, icon: '💜',  name: '+500 Poudre',         type: 'Poudre mémorielle',  xpRequired: 6570 },
            { palier: 23, icon: '🎴',  name: 'Carte : Bellecour Nuit', type: 'Carte exclusive', xpRequired: 7200 },
            { palier: 24, icon: '🏠',  name: 'Déco Studio : Portail', type: 'Décoration',       xpRequired: 7860 },
            { palier: 25, icon: '👑',  name: 'Avatar : Gardien des Étoiles', type: 'Avatar légendaire', xpRequired: 8550, milestone: true },
            { palier: 26, icon: '💜',  name: '+600 Poudre',         type: 'Poudre mémorielle',  xpRequired: 9270 },
            { palier: 27, icon: '🦁',  name: 'Skin Lyon Antique',   type: 'Skin légendaire',    xpRequired: 10020 },
            { palier: 28, icon: '🎴',  name: 'Carte Secrète : ???', type: 'Mystère',            xpRequired: 10800 },
            { palier: 29, icon: '✨',  name: 'Cadre Légendaire',    type: 'Décoration',         xpRequired: 11610 },
            { palier: 30, icon: '👑',  name: 'Titre : Légende de Lyon', type: 'Titre ultime',   xpRequired: 12450, milestone: true },
        ];

        const ACHIEVEMENTS_DATA = [
            // Explorateur
            { id: 'ach_first_card',  cat: 'Explorateur', icon: '🎴', name: 'Première découverte', desc: 'Collecter votre première carte',        xpReward: 20,  goal: 1,  stat: 'cards' },
            { id: 'ach_cards5',      cat: 'Explorateur', icon: '🗺️', name: 'Aventurier',           desc: 'Collecter 5 cartes différentes',        xpReward: 50,  goal: 5,  stat: 'cards' },
            { id: 'ach_cards15',     cat: 'Explorateur', icon: '🧭', name: 'Grand Explorateur',    desc: 'Collecter 15 cartes différentes',       xpReward: 150, goal: 15, stat: 'cards' },
            { id: 'ach_dust100',     cat: 'Explorateur', icon: '💜', name: 'Collecteur de poudre', desc: 'Accumuler 100 poudres au total',        xpReward: 30,  goal: 100, stat: 'dust_total' },
            { id: 'ach_dust500',     cat: 'Explorateur', icon: '💫', name: 'Riche en mémoire',     desc: 'Accumuler 500 poudres au total',        xpReward: 80,  goal: 500, stat: 'dust_total' },
            // Archiviste
            { id: 'ach_first_echo',  cat: 'Archiviste',  icon: '✨', name: 'Premier Écho',         desc: 'Collecter votre premier écho',          xpReward: 20,  goal: 1,  stat: 'echoes' },
            { id: 'ach_echoes5',     cat: 'Archiviste',  icon: '🔮', name: 'Résonance',            desc: 'Collecter 5 échos',                     xpReward: 60,  goal: 5,  stat: 'echoes' },
            { id: 'ach_echoes10',    cat: 'Archiviste',  icon: '🌀', name: 'Maître des Échos',     desc: 'Collecter 10 échos',                    xpReward: 120, goal: 10, stat: 'echoes' },
            { id: 'ach_place_echo',  cat: 'Archiviste',  icon: '📖', name: 'Premier Souvenir',     desc: 'Placer un écho dans un carnet',         xpReward: 30,  goal: 1,  stat: 'echoes_placed' },
            // Alchimiste
            { id: 'ach_level_card',  cat: 'Alchimiste',  icon: '⬆️', name: 'Première évolution',   desc: 'Faire monter une carte de niveau',      xpReward: 40,  goal: 1,  stat: 'card_levels' },
            { id: 'ach_dust_spent',  cat: 'Alchimiste',  icon: '🔥', name: 'Investisseur',         desc: 'Dépenser 200 poudres sur les cartes',   xpReward: 70,  goal: 200, stat: 'dust_spent' },
            { id: 'ach_max_level',   cat: 'Alchimiste',  icon: '💎', name: 'Maîtrise totale',      desc: 'Atteindre le niveau max sur une carte',  xpReward: 200, goal: 1,  stat: 'max_level_cards' },
            // Collectionneur
            { id: 'ach_collection',  cat: 'Collectionneur', icon: '📦', name: 'Passion Cartes',    desc: 'Compléter une collection entière',      xpReward: 250, goal: 1,  stat: 'collections_done' },
            { id: 'ach_legendary',   cat: 'Collectionneur', icon: '🌟', name: 'Légendaire !',      desc: 'Collecter une carte légendaire',        xpReward: 100, goal: 1,  stat: 'legendary_cards' },
            { id: 'ach_all_types',   cat: 'Collectionneur', icon: '🌈', name: 'Touche-à-tout',     desc: 'Collecter une carte de chaque supertype', xpReward: 150, goal: 5, stat: 'supertypes_collected' },
        ];

        // ---- State ----
        let playerXP = 0;
        let playerTotalXP = 0;
        let playerLevel = 1;
        let achievementsState = {}; // { id: { progress, unlocked } }
        let bpClaimedPaliers = new Set();

        // XP rewards per action
        const XP_REWARDS = {
            collect_card:    25,
            collect_echo:    10,
            collect_dust:    5,
            level_card:      40,
            max_level_card:  100,
            place_echo:      15,
        };

        // Stats for achievements
        let playerStats = {
            cards: 0,
            echoes: 0,
            echoes_placed: 0,
            dust_total: 0,
            dust_spent: 0,
            card_levels: 0,
            max_level_cards: 0,
            collections_done: 0,
            legendary_cards: 0,
            supertypes_collected: 0,
        };

        // Init achievements state
        ACHIEVEMENTS_DATA.forEach(a => {
            achievementsState[a.id] = { progress: 0, unlocked: false };
        });

        // ---- Core XP functions ----

        function getCurrentRank(level) {
            let rank = PLAYER_RANKS[0];
            for (let i = PLAYER_RANKS.length - 1; i >= 0; i--) {
                if (level >= PLAYER_RANKS[i].level) { rank = PLAYER_RANKS[i]; break; }
            }
            return rank;
        }

        function getNextRank(level) {
            for (let i = 0; i < PLAYER_RANKS.length; i++) {
                if (PLAYER_RANKS[i].level > level) return PLAYER_RANKS[i];
            }
            return null; // max level
        }

        function getXpForLevel(level) {
            const nextRank = PLAYER_RANKS.find(r => r.level === level + 1);
            const curRank = PLAYER_RANKS.find(r => r.level === level) || PLAYER_RANKS[0];
            if (!nextRank) return Infinity;
            return nextRank.xpNeeded - curRank.xpNeeded;
        }

        function awardXP(amount, reason) {
            playerXP += amount;
            playerTotalXP += amount;

            // Level up check
            let leveled = false;
            while (true) {
                const xpForNext = getXpForLevel(playerLevel);
                if (playerXP >= xpForNext && xpForNext !== Infinity) {
                    playerXP -= xpForNext;
                    playerLevel++;
                    leveled = true;
                    showLevelupOverlay();
                    break; // show one at a time
                } else break;
            }

            updateProgressionHUD();
            updateAvatarMenuXP();
        }

        function updateProgressionHUD() {
            const rank = getCurrentRank(playerLevel);
            const xpNeeded = getXpForLevel(playerLevel);
            const pct = xpNeeded === Infinity ? 100 : Math.min(100, (playerXP / xpNeeded) * 100);

            // HUD pill
            const fill = document.getElementById('hudXpFill');
            const label = document.getElementById('hudXpLevel');
            if (fill) fill.style.width = pct + '%';
            if (label) label.textContent = `Nv.${playerLevel}`;
        }

        function updateAvatarMenuXP() {
            const rank = getCurrentRank(playerLevel);
            const xpNeeded = getXpForLevel(playerLevel);
            const pct = xpNeeded === Infinity ? 100 : Math.min(100, (playerXP / xpNeeded) * 100);

            const nameEl = document.getElementById('menuRankName');
            const badge = document.getElementById('menuLevelBadge');
            const fill = document.getElementById('menuXpFill');
            const xpLabel = document.getElementById('menuXpLabel');

            if (nameEl) nameEl.textContent = rank.name;
            if (badge) badge.textContent = `Nv. ${playerLevel}`;
            if (fill) fill.style.width = pct + '%';
            if (xpLabel) {
                const display = xpNeeded === Infinity ? `${playerXP} XP (MAX)` : `${playerXP} / ${xpNeeded} XP`;
                xpLabel.textContent = display;
            }
        }

        // ---- Achievement checks ----

        function updateStat(stat, value) {
            if (stat in playerStats) {
                playerStats[stat] = value !== undefined ? value : playerStats[stat] + 1;
            }
            checkAchievements();
        }

        function checkAchievements() {
            ACHIEVEMENTS_DATA.forEach(a => {
                const state = achievementsState[a.id];
                if (state.unlocked) return;

                const current = playerStats[a.stat] || 0;
                const prev = state.progress;
                state.progress = Math.min(a.goal, current);

                if (state.progress >= a.goal && !state.unlocked) {
                    state.unlocked = true;
                    awardXP(a.xpReward, `Achievement: ${a.name}`);
                    showAchievementToast(a);
                }
            });
        }

        function showAchievementToast(achievement) {
            // Remove any existing toast
            const existing = document.getElementById('achieveToast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'achieveToast';
            toast.className = 'achievement-toast';
            toast.innerHTML = `
                <div class="achievement-toast-icon">${achievement.icon}</div>
                <div class="achievement-toast-text">
                    <div class="achievement-toast-label">🏆 Succès débloqué !</div>
                    <div class="achievement-toast-name">${achievement.name}</div>
                </div>
                <div class="achievement-toast-xp">+${achievement.xpReward} XP</div>
            `;
            document.getElementById('mainApp').appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3500);
        }

        // ---- Level-up overlay ----
        function showLevelupOverlay() {
            const rank = getCurrentRank(playerLevel);
            document.getElementById('levelupNum').textContent = playerLevel;
            document.getElementById('levelupRank').textContent = rank.name;
            document.getElementById('levelupBurst').textContent = rank.icon;
            const overlay = document.getElementById('levelupOverlay');
            overlay.classList.add('show');
        }

        function closeLevelupOverlay() {
            document.getElementById('levelupOverlay').classList.remove('show');
        }

        // ---- Progression Screen ----
        function openProgressionScreen() {
            const screen = document.getElementById('progressionScreen');
            // Reparent to mainApp if needed
            const app = document.getElementById('mainApp');
            if (screen.parentNode !== app) app.appendChild(screen);
            renderProgPlayerCard();
            renderBattlepassNodes();
            renderAchievementsList();
            switchProgTab('battlepass');
            screen.classList.add('show');
        }

        function closeProgressionScreen() {
            document.getElementById('progressionScreen').classList.remove('show');
        }

        function switchProgTab(tab) {
            document.querySelectorAll('.prog-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab === 'battlepass' ? 'progTabBP' : 'progTabAchiev').classList.add('active');
            document.getElementById('progPaneBP').classList.toggle('hidden', tab !== 'battlepass');
            document.getElementById('progPaneAchiev').classList.toggle('hidden', tab !== 'achievements');
        }

        function renderProgPlayerCard() {
            const rank = getCurrentRank(playerLevel);
            const xpNeeded = getXpForLevel(playerLevel);
            const pct = xpNeeded === Infinity ? 100 : Math.min(100, (playerXP / xpNeeded) * 100);

            document.getElementById('progAvatar').querySelector('.avatar-emoji') &&
                (document.getElementById('progAvatar').querySelector('.avatar-emoji').textContent = '🧙');
            document.getElementById('progAvatarLevel').textContent = playerLevel;
            document.getElementById('progRankName').textContent = rank.name;
            document.getElementById('progRankTitle').textContent = rank.title;
            document.getElementById('progXpTotal').textContent = `${playerTotalXP} XP accumulés`;
            document.getElementById('progXpFill').style.width = pct + '%';
            document.getElementById('progXpCurrent').textContent = `${playerXP} XP`;
            document.getElementById('progXpNext').textContent =
                xpNeeded === Infinity ? 'Niveau maximum !' : `Prochain rang : ${xpNeeded - playerXP} XP`;
        }

        function renderBattlepassNodes() {
            const container = document.getElementById('bpNodesList');
            container.innerHTML = '';

            BATTLEPASS_NODES.forEach((node, idx) => {
                const done = playerTotalXP >= node.xpRequired;
                const isCurrent = !done && (idx === 0 || playerTotalXP >= BATTLEPASS_NODES[idx - 1]?.xpRequired);

                if (node.milestone) {
                    const ms = document.createElement('div');
                    ms.className = 'bp-milestone';
                    ms.innerHTML = `
                        <div class="bp-milestone-icon">${node.icon}</div>
                        <div class="bp-milestone-info">
                            <div class="bp-milestone-name">${node.name}</div>
                            <div class="bp-milestone-desc">${node.type}</div>
                        </div>
                        <div class="bp-milestone-badge">${done ? '✓ Débloqué' : `${node.xpRequired} XP`}</div>
                    `;
                    container.appendChild(ms);
                    return;
                }

                const row = document.createElement('div');
                row.className = 'bp-node-row';
                row.innerHTML = `
                    <div class="bp-node ${done ? 'done' : isCurrent ? 'current' : 'locked'}">
                        ${done ? '✓' : node.icon}
                        <span class="bp-node-num">${node.palier}</span>
                    </div>
                    <div style="width:10px;flex-shrink:0;"></div>
                    <div class="bp-reward-card ${done ? 'done' : ''}">
                        <div class="bp-reward-icon">${done ? '✅' : isCurrent ? '🔓' : '🔒'}</div>
                        <div class="bp-reward-info">
                            <div class="bp-reward-name">${node.name}</div>
                            <div class="bp-reward-type">${node.type}</div>
                        </div>
                        <div class="bp-reward-status ${done ? '' : isCurrent ? 'current' : 'locked'}">
                            ${done ? '✓' : isCurrent ? `${node.xpRequired} XP` : `${node.xpRequired} XP`}
                        </div>
                    </div>
                `;

                // Add connector below (not for last)
                if (idx < BATTLEPASS_NODES.length - 1) {
                    const conn = document.createElement('div');
                    conn.style.cssText = 'display:flex;align-items:center;padding-left:20px;';
                    conn.innerHTML = `<div class="bp-connector ${done ? 'done' : ''}"></div>`;
                    container.appendChild(row);
                    container.appendChild(conn);
                } else {
                    container.appendChild(row);
                }
            });
        }

        function renderAchievementsList() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';

            const cats = [...new Set(ACHIEVEMENTS_DATA.map(a => a.cat))];

            cats.forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.className = 'achievement-category';
                catDiv.innerHTML = `<div class="achievement-cat-title">${cat}</div>`;

                ACHIEVEMENTS_DATA.filter(a => a.cat === cat).forEach(a => {
                    const state = achievementsState[a.id];
                    const progress = Math.min(a.goal, playerStats[a.stat] || 0);
                    const pct = Math.min(100, (progress / a.goal) * 100);
                    const inProgress = progress > 0 && !state.unlocked;

                    const item = document.createElement('div');
                    item.className = `achievement-item ${state.unlocked ? 'unlocked' : inProgress ? 'in-progress' : ''}`;
                    item.innerHTML = `
                        <div class="achievement-icon">
                            ${a.icon}
                            ${state.unlocked ? '<div class="achievement-check">✓</div>' : ''}
                        </div>
                        <div class="achievement-info">
                            <div class="achievement-name">${a.name}</div>
                            <div class="achievement-desc">${a.desc}</div>
                            <div class="achievement-progress-row">
                                <div class="achievement-prog-bar">
                                    <div class="achievement-prog-fill" style="width:${pct}%"></div>
                                </div>
                                <span class="achievement-prog-label">${progress}/${a.goal}</span>
                            </div>
                        </div>
                        <div class="achievement-xp">+${a.xpReward} XP</div>
                    `;
                    catDiv.appendChild(item);
                });

                container.appendChild(catDiv);
            });
        }

        // ---- Hook into existing game actions ----

        // Wrap collectCard to award XP
        const _origCollectCard = collectCard;
        collectCard = function() {
            const before = collectedCards.length;
            _origCollectCard();
            if (collectedCards.length > before) {
                awardXP(XP_REWARDS.collect_card, 'carte');
                playerStats.cards = collectedCards.length;
                // Check legendary
                const allCards = Object.values(COLLECTIONS).flatMap(c => c.cards);
                const newCard = allCards.find(c => collectedCards.includes(c.id) && !collectedCards.slice(0,-1).includes(c.id));
                if (newCard && newCard.rarity === 'legendary') {
                    playerStats.legendary_cards++;
                }
                // Count unique supertypes
                const types = new Set(collectedCards.map(id => allCards.find(c => c.id === id)?.supertype).filter(Boolean));
                playerStats.supertypes_collected = types.size;
                updateStat('cards', collectedCards.length);
            }
        };

        // Wrap collectEcho
        const _origCollectEcho = collectEcho;
        collectEcho = function() {
            const before = collectedEchoes.length;
            _origCollectEcho();
            if (collectedEchoes.length > before) {
                awardXP(XP_REWARDS.collect_echo, 'écho');
                playerStats.echoes = collectedEchoes.length;
                updateStat('echoes', collectedEchoes.length);
            }
        };

        // Wrap collectDust
        const _origCollectDust = collectDust;
        collectDust = function() {
            const before = memorialDust;
            _origCollectDust();
            if (memorialDust > before) {
                const gained = memorialDust - before;
                awardXP(XP_REWARDS.collect_dust, 'poudre');
                playerStats.dust_total += gained;
                updateStat('dust_total', playerStats.dust_total);
            }
        };

        // Wrap addExperience
        const _origAddExperience = addExperience;
        addExperience = function() {
            const levelsBefore = selectedCard ? (cardLevels[selectedCard.id]?.level || 0) : 0;
            const dustBefore = memorialDust;
            _origAddExperience();
            const levelsAfter = selectedCard ? (cardLevels[selectedCard.id]?.level || 0) : 0;
            const dustSpent = dustBefore - memorialDust;
            if (dustSpent > 0) {
                playerStats.dust_spent += dustSpent;
                updateStat('dust_spent', playerStats.dust_spent);
            }
            if (levelsAfter > levelsBefore) {
                awardXP(XP_REWARDS.level_card, 'level');
                playerStats.card_levels++;
                updateStat('card_levels', playerStats.card_levels);
                if (levelsAfter >= MAX_LEVEL) {
                    awardXP(XP_REWARDS.max_level_card, 'max_level');
                    playerStats.max_level_cards++;
                    updateStat('max_level_cards', playerStats.max_level_cards);
                }
            }
        };

        // Wrap placeEchoInSlot
        const _origPlaceEchoInSlot = placeEchoInSlot;
        placeEchoInSlot = function(slotId, supertype) {
            _origPlaceEchoInSlot(slotId, supertype);
            awardXP(XP_REWARDS.place_echo, 'écho placé');
            playerStats.echoes_placed++;
            updateStat('echoes_placed', playerStats.echoes_placed);
        };

        // Init HUD on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateProgressionHUD();
                updateAvatarMenuXP();
            }, 100);
        });

    </script>
</body>
</html>
