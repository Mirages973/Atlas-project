<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lyon Cards - Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            background: white;
            margin: 0;
        }

        .app-container {
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            margin: 0;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(79,70,229,0.92) 0%, rgba(124,58,237,0.92) 100%);
            color: white;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 30;
            backdrop-filter: blur(4px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
        }

        .collections-btn {
            background: white;
            color: #4F46E5;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .collections-btn:hover {
            background: #EEF2FF;
        }

        /* Map */
        #map {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        #map.isometric-fallback .gm-style {
            transform: perspective(1200px) rotateX(32deg) scale(1.08);
            transform-origin: center 72%;
            flex: 1;
            position: relative;
            transition: transform 0.3s ease;
        }

        #map.isometric-fallback {
            transform: perspective(1200px) rotateX(38deg) scale(1.18);
            transform-origin: center 70%;
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 16px;
            z-index: 20;
        }

        .controls-hint {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .nearby-poi {
            background: #ECFDF5;
            border: 2px solid #10B981;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .nearby-poi-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .nearby-poi-name {
            font-weight: bold;
            color: #047857;
            font-size: 16px;
        }

        .nearby-poi-distance {
            font-size: 14px;
            color: #059669;
            margin-top: 4px;
        }

        .collect-btn {
            width: 100%;
            background: #10B981;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .collect-btn:hover {
            background: #059669;
        }

        /* Card Popup */
        .popup-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .popup-overlay.show {
            display: flex;
        }

        .popup-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .popup-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FBBF24 0%, #F97316 100%);
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .popup-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .popup-card-info {
            background: #EEF2FF;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .popup-card-name {
            font-size: 18px;
            font-weight: bold;
            color: #312E81;
        }

        .popup-card-type {
            font-size: 14px;
            color: #4F46E5;
            margin-top: 4px;
        }

        .popup-close-btn {
            width: 100%;
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .popup-close-btn:hover {
            background: #4338CA;
        }

        /* Collections Panel */
        .collections-panel {
            display: none;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 200;
            flex-direction: column;
        }

        .collections-panel.show {
            display: flex;
        }

        .collections-header {
            background: #4F46E5;
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collections-title {
            font-size: 20px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collections-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .collection-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .collection-item:hover {
            border-color: #818CF8;
        }

        .collection-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .collection-item-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .collection-item-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .collection-badge {
            background: #EEF2FF;
            color: #4F46E5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4F46E5;
            transition: width 0.3s;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 64px;
            opacity: 0.5;
            margin-bottom: 16px;
        }

        /* Collection Detail */
        .collection-detail {
            display: none;
        }

        .collection-detail.show {
            display: block;
        }

        .back-btn {
            background: none;
            border: none;
            color: #4F46E5;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 16px;
            padding: 8px 0;
        }

        .collection-detail-header {
            margin-bottom: 24px;
        }

        .collection-detail-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .collection-detail-desc {
            color: #6b7280;
            margin-bottom: 12px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .card-item {
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .card-item:hover {
            transform: scale(1.05);
        }

        .card-item.collected {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
        }

        .card-item.locked {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .card-item.locked:hover {
            transform: none;
        }

        .card-icon {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 8px;
        }

        .card-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .card-type {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Card Detail View */
        .card-detail-view {
            display: none;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 300;
            flex-direction: column;
        }

        .card-detail-view.show {
            display: flex;
        }

        .card-detail-header {
            background: #4F46E5;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .card-detail-title-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-detail-dust-display {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .card-detail-back {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .card-detail-body {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding-bottom: max(0px, env(safe-area-inset-bottom));
        }

        /* Card Display */
        .card-display {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 480px) {
            .card-display {
                padding: 16px;
            }
        }

        .card-frame {
            background: white;
            border-radius: 16px;
            padding: 16px;
            width: 100%;
            max-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        @media (max-width: 480px) {
            .card-frame {
                max-width: 220px;
                padding: 12px;
                border-radius: 12px;
            }
        }

        .card-rarity-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #F59E0B;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .card-category-badge {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            color: #92400E;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 12px;
        }

        .card-title-box {
            background: white;
            border: 2px solid #1f2937;
            border-radius: 8px;
            padding: 8px 16px;
            text-align: center;
            margin-bottom: 16px;
        }

        .card-title-text {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .card-art-area {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border-radius: 12px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            position: relative;
        }

        @media (max-width: 480px) {
            .card-art-area {
                min-height: 140px;
                margin-bottom: 12px;
            }
        }

        .card-art-placeholder {
            font-size: 80px;
        }

        @media (max-width: 480px) {
            .card-art-placeholder {
                font-size: 60px;
            }
        }

        .card-footer {
            text-align: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            position: relative;
        }

        .card-level-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-level-label {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .card-exp-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .card-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #A855F7 0%, #7C3AED 100%);
            transition: width 0.3s ease;
        }

        .card-level-up-btn {
            width: 100%;
            background: linear-gradient(135deg, #A855F7 0%, #7C3AED 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: transform 0.2s;
        }

        .card-level-up-btn:hover {
            transform: scale(1.05);
        }

        .card-level-up-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        /* Gemmes de raret√© */
        .rarity-gem {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gem-triangle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 26px solid;
        }

        .gem-pentagon {
            width: 20px;
            height: 18px;
            position: relative;
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        }

        .gem-hexagon {
            width: 24px;
            height: 24px;
            clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
        }

        .card-level-badge-display {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #1f2937;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            color: #1f2937;
        }

        .card-eye-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }

        .card-quote-text {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 4px;
        }

        .card-level-badge {
            display: inline-block;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        .card-related-characters {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }

        @media (max-width: 480px) {
            .card-related-characters {
                gap: 6px;
                margin-top: 8px;
            }
        }

        .related-char {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        @media (max-width: 480px) {
            .related-char {
                width: 30px;
                height: 30px;
                font-size: 18px;
                border-radius: 6px;
            }
        }

        .related-char.green {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .related-char.orange {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        }

        .related-char.purple {
            background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%);
        }

        /* Tabs */
        .card-tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .card-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 4px;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 70px;
        }

        .card-tab.journal-tab {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            margin: 0 2px;
        }

        .card-tab.journal-tab:hover {
            background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
        }

        .card-tab.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
            background: white;
            font-size: 12px;
        }

        .card-tab.journal-tab.active {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            border-bottom-color: transparent;
        }

        .card-tab:hover {
            background: #f9fafb;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content p {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            color: #6b7280;
        }

        /* Journal Tab */
        .journal-header {
            background: #f3f4f6;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .journal-mini-card {
            width: 60px;
            height: 80px;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .journal-mini-info {
            flex: 1;
        }

        .journal-mini-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .journal-mini-type {
            font-size: 14px;
            color: #6b7280;
        }

        .journal-entries {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            position: relative;
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 30px,
                    #F59E0B 30px,
                    #F59E0B 31px
                );
        }

        .journal-quote {
            font-family: 'Courier New', monospace;
            font-style: italic;
            color: #78350F;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .journal-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
        }

        .journal-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: #D1D5DB;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            flex-shrink: 0;
        }

        .journal-date {
            font-size: 12px;
            font-weight: 600;
            color: #92400E;
            margin-bottom: 4px;
        }

        .journal-text {
            font-size: 14px;
            color: #78350F;
            font-family: 'Courier New', monospace;
        }

        .journal-interaction {
            margin-top: 20px;
            padding: 16px;
            background: white;
            border: 2px solid #4F46E5;
            border-radius: 12px;
        }

        .interaction-button {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .interaction-button:hover {
            border-color: #4F46E5;
            transform: scale(1.1);
        }

        .interaction-button.locked {
            background: #f3f4f6;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .interaction-button.locked:hover {
            transform: none;
            border-color: #e5e7eb;
        }

        /* Inventory */
        .inventory-grid {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        /* API Key Screen */
        .api-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            padding: 24px;
        }

        .api-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .api-title {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .api-subtitle {
            color: #6b7280;
            margin-bottom: 24px;
        }

        .api-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .api-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .api-input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .api-submit {
            width: 100%;
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .api-submit:hover {
            background: #4338CA;
        }

        .hidden {
            display: none !important;
        }

        /* Journal Screen */
        .journal-screen {
            display: none;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 400;
            flex-direction: column;
        }

        .journal-screen.show {
            display: flex;
        }

        .journal-screen-header {
            background: #4F46E5;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .journal-screen-back {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .journal-screen-card-mini {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .journal-screen-card-image {
            width: 50px;
            height: 70px;
            background: linear-gradient(135deg, #818CF8 0%, #6366F1 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .journal-screen-card-info h3 {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
        }

        .journal-screen-card-info p {
            font-size: 13px;
            margin: 2px 0 0 0;
            opacity: 0.9;
        }

        .journal-screen-body {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
        }

        .journal-screen-content {
            padding: 16px;
        }

        .journal-notebook {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 30px,
                    #F59E0B 30px,
                    #F59E0B 31px
                );
            margin-bottom: 16px;
        }

        .journal-screen-footer {
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 16px;
        }

        .journal-inventory-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            text-align: center;
        }

        /* Joystick virtuel */
        .joystick-container {
            position: absolute;
            bottom: 180px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 15;
        }

        .joystick-base {
            width: 120px;
            height: 120px;
            background: rgba(79, 70, 229, 0.3);
            border: 3px solid rgba(79, 70, 229, 0.5);
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }

        .joystick-stick {
            width: 50px;
            height: 50px;
            background: #4F46E5;
            border: 3px solid white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            touch-action: none;
            transition: all 0.1s ease;
        }

        /* GPS Toggle */
        .gps-toggle {
            position: absolute;
            bottom: 180px;
            right: 20px;
            z-index: 15;
        }

        .gps-btn {
            width: 56px;
            height: 56px;
            background: white;
            border: 2px solid #4F46E5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }

        .gps-btn.active {
            background: #4F46E5;
            color: white;
        }

        .gps-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp" class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>Lyon Cards</h1>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 18px;">üíú</span>
                        <span style="font-weight: 600; font-size: 14px;" id="dustCounter">0</span>
                    </div>
                    <button onclick="openCollections()" class="collections-btn">
                        üì¶ Collections
                    </button>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Joystick virtuel -->
        <div class="joystick-container">
            <div class="joystick-base" id="joystickBase">
                <div class="joystick-stick" id="joystickStick"></div>
            </div>
        </div>

        <!-- GPS Toggle -->
        <div class="gps-toggle">
            <button class="gps-btn" id="gpsBtn" onclick="toggleGPS()">üìç</button>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-hint">Utilisez les fl√®ches ‚Üê ‚Üë ‚Üí ‚Üì ou touchez la carte pour vous t√©l√©porter</div>
            
            <div id="nearbyPOI" class="nearby-poi hidden">
                <div class="nearby-poi-header">
                    <div>
                        <div class="nearby-poi-name" id="poiName"></div>
                        <div class="nearby-poi-distance">√Ä port√©e de collecte!</div>
                    </div>
                </div>
                <button onclick="collectCard()" class="collect-btn">Collecter la carte</button>
            </div>

            <div id="nearbyDust" class="nearby-poi hidden" style="background: #F3E8FF; border-color: #A855F7;">
                <div class="nearby-poi-header">
                    <div>
                        <div class="nearby-poi-name" style="color: #7C3AED;">üíú Poudre m√©morielle</div>
                        <div class="nearby-poi-distance" style="color: #9333EA;">√Ä port√©e de collecte!</div>
                    </div>
                </div>
                <button onclick="collectDust()" class="collect-btn" style="background: #A855F7;">Collecter la poudre</button>
            </div>

        </div>

        <!-- Card Popup -->
        <div id="cardPopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-icon">üé¥</div>
                <h3 class="popup-title">Carte obtenue!</h3>
                <div class="popup-card-info">
                    <div class="popup-card-name" id="popupCardName"></div>
                    <div class="popup-card-type" id="popupCardType"></div>
                </div>
                <button onclick="closeCardPopup()" class="popup-close-btn">Continuer</button>
            </div>
        </div>

        <!-- Collections Panel -->
        <div id="collectionsPanel" class="collections-panel">
            <div class="collections-header">
                <h2 class="collections-title">Mes Collections</h2>
                <button onclick="closeCollections()" class="close-btn">‚úï</button>
            </div>
            <div class="collections-content">
                <!-- Collections List -->
                <div id="collectionsList"></div>
                
                <!-- Collection Detail -->
                <div id="collectionDetail" class="collection-detail">
                    <button onclick="backToCollections()" class="back-btn">‚Üê Retour</button>
                    <div class="collection-detail-header">
                        <h3 class="collection-detail-title" id="detailTitle"></h3>
                        <p class="collection-detail-desc" id="detailDesc"></p>
                        <span class="collection-badge" id="detailBadge"></span>
                    </div>
                    <div class="cards-grid" id="cardsGrid"></div>
                </div>
            </div>
        </div>

        <!-- Card Detail View -->
        <div id="cardDetailView" class="card-detail-view">
        <div class="card-detail-header">
            <button onclick="closeCardDetail()" class="card-detail-back">‚Üê</button>
            <div class="card-detail-title-section">
                <h2 class="collections-title" id="cardDetailHeaderTitle"></h2>
                <div class="card-detail-dust-display">
                    <span>üíú</span>
                    <span id="cardDetailDustCounter">0</span>
                </div>
            </div>
        </div>
        <div class="card-detail-body">
            <!-- Card Display -->
            <div class="card-display">
                <div class="card-frame">
                    <div class="card-rarity-badge">üèÖ</div>
                    <div class="card-category-badge" id="cardCategory">Personnage</div>
                    <div class="card-title-box">
                        <div class="card-title-text" id="cardDetailName">Marie Curie</div>
                    </div>
                    <div class="card-art-area">
                        <div class="card-level-badge-display" id="cardArtLevel">Niv. 1</div>
                        <div class="card-art-placeholder">üë§</div>
                        <div class="rarity-gem" id="cardRarityGem"></div>
                    </div>
                    <div class="card-footer">
                        <div class="card-level-info">
                            <span class="card-level-label" id="cardLevelDisplay">Niveau 1</span>
                            <span class="card-level-label" id="cardExpDisplay">0/10 üíú</span>
                        </div>
                        <div class="card-exp-bar">
                            <div class="card-exp-fill" id="cardExpBar" style="width: 0%"></div>
                        </div>
                        <button id="addExpBtn" class="card-level-up-btn" onclick="addExperience()" disabled>
                            üíú Ajouter 50 poudre (+EXP)
                        </button>
                    </div>
                    <div class="card-related-characters">
                        <div class="related-char">üë§</div>
                        <div class="related-char green">üë§</div>
                        <div class="related-char orange">üë§</div>
                        <div class="related-char purple">üë§</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card-tabs">
                <button class="card-tab active" onclick="switchTab('general')">G√©n√©ral</button>
                <button class="card-tab" onclick="switchTab('skins')">Skins</button>
                <button class="card-tab" onclick="switchTab('competences')">Comp√©tences</button>
                <button class="card-tab journal-tab" onclick="openJournalScreen()">üìñ Carnet</button>
            </div>

            <!-- Tab Contents -->
            <div id="generalTab" class="tab-content active">
                <div class="info-row">
                    <span class="info-label">Naissance</span>
                    <span class="info-value">7 novembre 1867</span>
                </div>
                <div class="info-row">
                    <span class="info-label">D√©c√®s</span>
                    <span class="info-value">4 juillet 1934</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nationalit√©</span>
                    <span class="info-value">Polonaise, Fran√ßaise</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Conjoint</span>
                    <span class="info-value">Pierre Curie</span>
                </div>
                <p style="margin-top: 20px;">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
                </p>
            </div>

            <div id="skinsTab" class="tab-content">
                <h3 style="margin-bottom: 16px; color: #1f2937;">Apparences disponibles</h3>
                <div class="info-row">
                    <span class="info-label">Skin 1</span>
                    <span class="info-value">Tenue de laboratoire</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Skin 2</span>
                    <span class="info-value">Tenue de c√©r√©monie</span>
                </div>
                <p style="margin-top: 20px;">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                </p>
            </div>

            <div id="competencesTab" class="tab-content">
                <h3 style="margin-bottom: 16px; color: #1f2937;">Comp√©tences √† d√©bloquer</h3>
                <div class="info-row">
                    <span class="info-label">Radioactivit√©</span>
                    <span class="info-value">√Ä d√©finir</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Physique</span>
                    <span class="info-value">√Ä d√©finir</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Chimie</span>
                    <span class="info-value">√Ä d√©finir</span>
                </div>
                <p style="margin-top: 20px;">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </p>
            </div>
        </div>
    </div>

    <!-- Journal Screen -->
    <div id="journalScreen" class="journal-screen">
        <div class="journal-screen-header">
            <button onclick="closeJournalScreen()" class="journal-screen-back">‚Üê</button>
            <div class="journal-screen-card-mini">
                <div class="journal-screen-card-image">üé¥</div>
                <div class="journal-screen-card-info">
                    <h3 id="journalScreenCardName">Marie Curie</h3>
                    <p id="journalScreenCardType">Personnage</p>
                </div>
            </div>
        </div>

        <div class="journal-screen-body">
            <div class="journal-screen-content">
                <!-- Carnet de bord -->
                <div class="journal-notebook">
                    <div class="journal-quote">
                        "J'ai appris la voie du progr√®s n'√©tait ni rapide, ni facile..."
                    </div>

                    <div class="journal-item">
                        <div class="journal-image">üèÖ</div>
                        <div>
                            <div class="journal-date">1903</div>
                            <div class="journal-text">Prix Nobel de Physique</div>
                        </div>
                    </div>

                    <div class="journal-item">
                        <div class="journal-image">üèõÔ∏è</div>
                        <div>
                            <div class="journal-date">1891</div>
                            <div class="journal-text">Arrive √† Paris pour √©tudier</div>
                        </div>
                    </div>

                    <div class="journal-item">
                        <div class="journal-image">üß™</div>
                        <div>
                            <div class="journal-date">1898</div>
                            <div class="journal-text">D√©couverte du radium</div>
                        </div>
                    </div>

                    <div class="journal-interaction">
                        <div style="font-size: 14px; font-weight: 600; color: #4F46E5; margin-bottom: 12px;">
                            Possibilit√©s d'interaction
                        </div>
                        <div class="journal-item" style="margin-bottom: 12px;">
                            <div class="interaction-button">üéµ</div>
                            <div class="journal-text" style="color: #4F46E5;">Audio explicatif</div>
                        </div>
                        <div class="journal-item" style="margin-bottom: 12px;">
                            <div class="interaction-button locked">üîí</div>
                            <div class="journal-text" style="color: #6b7280;">Cadenas √† d√©faire (mini-jeu)</div>
                        </div>
                        <div class="journal-item" style="margin-bottom: 12px;">
                            <div class="interaction-button locked">üîß</div>
                            <div class="journal-text" style="color: #6b7280;">Outil √† r√©cup√©rer</div>
                        </div>
                        <div class="journal-item">
                            <div class="journal-image" style="width: 100px; height: 100px;">üë§</div>
                            <div>
                                <div class="journal-date">1934</div>
                                <div class="journal-text">Fr√©d√©ric Joliot, radiochimiste</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventaire -->
        <div class="journal-screen-footer" style="padding-bottom: max(16px, env(safe-area-inset-bottom));">
            <div class="journal-inventory-title">Inventaire</div>
            <div class="inventory-grid">
                <div class="interaction-button">üêï</div>
                <div class="interaction-button">üîç</div>
                <div class="interaction-button">üìñ</div>
                <button class="interaction-button" style="background: #4F46E5; color: white; border-color: #4F46E5;">üëÜ</button>
            </div>
        </div>
    </div>
    
    </div><!-- Fin mainApp -->

    <script>
        // Data
        const COLLECTIONS = {
            lumieres: {
                id: 'lumieres',
                name: 'Lumi√®res de Lyon',
                type: 'th√©matique',
                description: 'Personnages historiques lyonnais',
                cards: [
                    { id: 'card1', name: 'Antoine de Saint-Exup√©ry', type: 'Personnage', poiId: 'bellecour', rarity: 'rare' },
                    { id: 'card2', name: 'Les Fr√®res Lumi√®re', type: 'Personnage', poiId: 'institut_lumiere', rarity: 'legendary' },
                    { id: 'card3', name: 'Paul Bocuse', type: 'Personnage', poiId: 'halles_bocuse', rarity: 'rare' },
                    { id: 'card4', name: 'Guignol', type: 'Personnage', poiId: 'vieux_lyon', rarity: 'common' },
                    { id: 'card5', name: 'Tony Garnier', type: 'Personnage', poiId: 'confluence', rarity: 'common' },
                ]
            },
            presquile: {
                id: 'presquile',
                name: 'Presqu\'√Æle',
                type: 'locale',
                description: 'Tr√©sors de la Presqu\'√Æle lyonnaise',
                cards: [
                    { id: 'card6', name: 'Place Bellecour', type: 'Lieu', poiId: 'bellecour', rarity: 'legendary' },
                    { id: 'card7', name: 'Op√©ra de Lyon', type: 'Lieu', poiId: 'opera', rarity: 'rare' },
                    { id: 'card8', name: 'H√¥tel de Ville', type: 'Lieu', poiId: 'hotel_ville', rarity: 'common' },
                    { id: 'card9', name: 'Les Terreaux', type: 'Lieu', poiId: 'terreaux', rarity: 'common' },
                    { id: 'card10', name: 'Fontaine Bartholdi', type: 'Objet', poiId: 'terreaux', rarity: 'rare' },
                ]
            },
            fourviere: {
                id: 'fourviere',
                name: 'Fourvi√®re & Vieux-Lyon',
                type: 'locale',
                description: 'Patrimoine de la colline et du Vieux-Lyon',
                cards: [
                    { id: 'card11', name: 'Basilique Notre-Dame', type: 'Lieu', poiId: 'fourviere', rarity: 'legendary' },
                    { id: 'card12', name: 'Th√©√¢tre Romain', type: 'Lieu', poiId: 'theatre_romain', rarity: 'rare' },
                    { id: 'card13', name: 'Cath√©drale Saint-Jean', type: 'Lieu', poiId: 'saint_jean', rarity: 'rare' },
                    { id: 'card14', name: 'Traboule Renaissance', type: 'Lieu', poiId: 'vieux_lyon', rarity: 'common' },
                    { id: 'card15', name: 'Horloge Astronomique', type: 'Objet', poiId: 'saint_jean', rarity: 'common' },
                ]
            }
        };

        const POIS = [
            { id: 'fourviere', name: 'Basilique de Fourvi√®re', lat: 45.7624, lng: 4.8227 },
            { id: 'bellecour', name: 'Place Bellecour', lat: 45.7578, lng: 4.8320 },
            { id: 'vieux_lyon', name: 'Vieux-Lyon', lat: 45.7640, lng: 4.8270 },
            { id: 'parc_tete_or', name: 'Parc de la T√™te d\'Or', lat: 45.7772, lng: 4.8542 },
            { id: 'confluence', name: 'Mus√©e des Confluences', lat: 45.7326, lng: 4.8181 },
            { id: 'terreaux', name: 'Place des Terreaux', lat: 45.7675, lng: 4.8336 },
            { id: 'opera', name: 'Op√©ra de Lyon', lat: 45.7673, lng: 4.8361 },
            { id: 'hotel_ville', name: 'H√¥tel de Ville', lat: 45.7674, lng: 4.8348 },
            { id: 'theatre_romain', name: 'Th√©√¢tre Romain', lat: 45.7605, lng: 4.8205 },
            { id: 'saint_jean', name: 'Cath√©drale Saint-Jean', lat: 45.7606, lng: 4.8268 },
            { id: 'institut_lumiere', name: 'Institut Lumi√®re', lat: 45.7432, lng: 4.8687 },
            { id: 'halles_bocuse', name: 'Halles Paul Bocuse', lat: 45.7638, lng: 4.8542 },
        ];

        // Points de poudre m√©morielle (environ tous les 150m)
        const DUST_POINTS = [
            { id: 'dust1', lat: 45.7590, lng: 4.8290 },
            { id: 'dust2', lat: 45.7610, lng: 4.8310 },
            { id: 'dust3', lat: 45.7630, lng: 4.8330 },
            { id: 'dust4', lat: 45.7650, lng: 4.8300 },
            { id: 'dust5', lat: 45.7620, lng: 4.8250 },
            { id: 'dust6', lat: 45.7600, lng: 4.8230 },
            { id: 'dust7', lat: 45.7660, lng: 4.8320 },
            { id: 'dust8', lat: 45.7640, lng: 4.8380 },
            { id: 'dust9', lat: 45.7680, lng: 4.8360 },
            { id: 'dust10', lat: 45.7700, lng: 4.8340 },
            { id: 'dust11', lat: 45.7720, lng: 4.8380 },
            { id: 'dust12', lat: 45.7740, lng: 4.8420 },
            { id: 'dust13', lat: 45.7760, lng: 4.8460 },
            { id: 'dust14', lat: 45.7780, lng: 4.8500 },
            { id: 'dust15', lat: 45.7650, lng: 4.8420 },
            { id: 'dust16', lat: 45.7580, lng: 4.8380 },
            { id: 'dust17', lat: 45.7560, lng: 4.8340 },
            { id: 'dust18', lat: 45.7540, lng: 4.8280 },
            { id: 'dust19', lat: 45.7520, lng: 4.8240 },
            { id: 'dust20', lat: 45.7500, lng: 4.8200 },
            { id: 'dust21', lat: 45.7480, lng: 4.8260 },
            { id: 'dust22', lat: 45.7460, lng: 4.8300 },
            { id: 'dust23', lat: 45.7440, lng: 4.8340 },
            { id: 'dust24', lat: 45.7420, lng: 4.8380 },
            { id: 'dust25', lat: 45.7400, lng: 4.8420 },
            { id: 'dust26', lat: 45.7380, lng: 4.8280 },
            { id: 'dust27', lat: 45.7360, lng: 4.8240 },
            { id: 'dust28', lat: 45.7340, lng: 4.8200 },
            { id: 'dust29', lat: 45.7600, lng: 4.8460 },
            { id: 'dust30', lat: 45.7620, lng: 4.8500 },
        ];

        const LYON_CENTER = { lat: 45.7640, lng: 4.8357 };
        const isMobileDevice = window.matchMedia('(max-width: 768px)').matches || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // State
        let playerPos = { ...LYON_CENTER };
        let collectedCards = [];
        let cardLevels = {}; // { cardId: { level: 1, experience: 0 } }
        let memorialDust = 0; // Quantit√© de poudre m√©morielle
        let collectedDustPoints = []; // IDs des points de poudre collect√©s
        let map = null;
        let playerMarker = null;
        let poiMarkers = [];
        let dustMarkers = []; // Marqueurs de poudre m√©morielle
        let currentNearbyPOI = null;
        let currentNearbyDust = null;
        let selectedCollectionId = null;
        let currentTab = 'general';
        let selectedCard = null;
        let gpsWatchId = null;
        let gpsActive = false;
        let joystickActive = false;
        let joystickInterval = null;
        let joystickDirection = { x: 0, y: 0 };

        const COLLECTION_RADIUS = 50;
        const DUST_RADIUS = 30;
        const MOVE_SPEED = 0.000015;
        const ISOMETRIC_TILT = 67.5;
        const ISOMETRIC_HEADING = 20;
        const DUST_INCREMENT = 50; // Montant ajout√© par clic sur le bouton
        const MIN_DUST_DROP = 25;
        const MAX_DUST_DROP = 75;
        
        // Syst√®me de raret√© et d'exp√©rience
        const RARITY_CONFIG = {
            common: {
                name: 'Commune',
                color: '#10B981',
                shape: 'triangle',
                exp: { 1: 150, 2: 500 } // Niveau 1‚Üí2 : 150, Niveau 2‚Üí3 : 500
            },
            rare: {
                name: 'Rare',
                color: '#3B82F6',
                shape: 'pentagon',
                exp: { 1: 250, 2: 750 }
            },
            legendary: {
                name: 'L√©gendaire',
                color: '#F97316',
                shape: 'hexagon',
                exp: { 1: 500, 2: 1500 }
            }
        };
        
        const MAX_LEVEL = 3;

        // Utility Functions
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        function checkNearbyPOI() {
            const nearby = POIS.find(poi => {
                const distance = getDistance(playerPos.lat, playerPos.lng, poi.lat, poi.lng);
                if (distance > COLLECTION_RADIUS) return false;
                
                // V√©rifier s'il reste des cartes non collect√©es √† ce POI
                const allCards = Object.values(COLLECTIONS).flatMap(col => col.cards);
                const cardsAtPOI = allCards.filter(card => 
                    card.poiId === poi.id && !collectedCards.includes(card.id)
                );
                
                return cardsAtPOI.length > 0;
            });

            currentNearbyPOI = nearby;
            const nearbyDiv = document.getElementById('nearbyPOI');
            
            if (nearby) {
                document.getElementById('poiName').textContent = nearby.name;
                nearbyDiv.classList.remove('hidden');
            } else {
                nearbyDiv.classList.add('hidden');
            }

            // V√©rifier la proximit√© avec la poudre m√©morielle
            const nearbyDustPoint = DUST_POINTS.find(dust => {
                const distance = getDistance(playerPos.lat, playerPos.lng, dust.lat, dust.lng);
                return distance <= DUST_RADIUS && !collectedDustPoints.includes(dust.id);
            });

            currentNearbyDust = nearbyDustPoint;
            const nearbyDustDiv = document.getElementById('nearbyDust');
            
            if (nearbyDustPoint) {
                nearbyDustDiv.classList.remove('hidden');
            } else {
                nearbyDustDiv.classList.add('hidden');
            }
        }

        // App Initialization
        function startApp() {
            const apiKey = 'AIzaSyD1vGcHSX9bL0Y36Rx8bXmiB_Gc2BhPPic';

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}`;
            script.onload = initMap;
            document.head.appendChild(script);
        }
        
        // D√©marrer l'app automatiquement
        window.addEventListener('load', startApp);

        function initMap() {
            // Point de d√©part : Lyon sur web et mobile.
            // Sur mobile, l'utilisateur peut ensuite activer le GPS via le bouton üìç.
            playerPos = { ...LYON_CENTER };
            createMap();
        }

        function applyIsometricCamera() {
            if (!map) return;

            if (typeof map.moveCamera === 'function') {
                map.moveCamera({
                    tilt: ISOMETRIC_TILT,
                    heading: ISOMETRIC_HEADING,
                    zoom: 17.2
                });
            } else {
                if (typeof map.setTilt === 'function') {
                    map.setTilt(ISOMETRIC_TILT);
                }
                if (typeof map.setHeading === 'function') {
                    map.setHeading(ISOMETRIC_HEADING);
                }
                if (typeof map.setZoom === 'function' && map.getZoom() < 17) {
                    map.setZoom(17);
                }
            }

            const mapElement = document.getElementById('map');
            const currentTilt = typeof map.getTilt === 'function' ? (map.getTilt() || 0) : 0;
            mapElement.classList.toggle('isometric-fallback', currentTilt < 30);
        }

        function createMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: playerPos,
                zoom: 17.2,
                tilt: ISOMETRIC_TILT,
                heading: ISOMETRIC_HEADING,
                mapTypeId: 'roadmap',
                disableDefaultUI: true,
                zoomControl: true,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            applyIsometricCamera();
            google.maps.event.addListenerOnce(map, 'idle', applyIsometricCamera);

            playerMarker = new google.maps.Marker({
                position: playerPos,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#4F46E5',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 3,
                },
                zIndex: 1000
            });

            POIS.forEach(poi => {
                const marker = new google.maps.Marker({
                    position: { lat: poi.lat, lng: poi.lng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#EF4444',
                        fillOpacity: 0.8,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2,
                    },
                    title: poi.name
                });

                const circle = new google.maps.Circle({
                    map: map,
                    center: { lat: poi.lat, lng: poi.lng },
                    radius: COLLECTION_RADIUS,
                    fillColor: '#EF4444',
                    fillOpacity: 0.1,
                    strokeColor: '#EF4444',
                    strokeOpacity: 0.3,
                    strokeWeight: 1,
                });

                poiMarkers.push({ marker, circle, poi });
            });

            checkNearbyPOI();
            updatePOIVisibility();

            // Cr√©er les marqueurs de poudre m√©morielle
            DUST_POINTS.forEach(dust => {
                const marker = new google.maps.Marker({
                    position: { lat: dust.lat, lng: dust.lng },
                    map: map,
                    icon: {
                        path: 'M 0,-10 L 6,0 L 0,10 L -6,0 Z', // Losange
                        scale: 1.2,
                        fillColor: '#A855F7',
                        fillOpacity: 0.8,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2,
                    },
                    title: 'Poudre m√©morielle'
                });

                const circle = new google.maps.Circle({
                    map: map,
                    center: { lat: dust.lat, lng: dust.lng },
                    radius: DUST_RADIUS,
                    fillColor: '#A855F7',
                    fillOpacity: 0.1,
                    strokeColor: '#A855F7',
                    strokeOpacity: 0.3,
                    strokeWeight: 1,
                });

                dustMarkers.push({ marker, circle, dust });
            });

            updateDustVisibility();

            map.addListener('click', (event) => {
                if (gpsActive) return;
                if (document.getElementById('collectionsPanel').classList.contains('show') ||
                    document.getElementById('cardPopup').classList.contains('show') ||
                    document.getElementById('cardDetailView').classList.contains('show')) {
                    return;
                }

                teleportToLatLng(event.latLng);
            });
        }

        function updateDustVisibility() {
            dustMarkers.forEach(({ marker, circle, dust }) => {
                const visible = !collectedDustPoints.includes(dust.id);
                marker.setVisible(visible);
                circle.setVisible(visible);
            });
        }

        function updatePOIVisibility() {
            poiMarkers.forEach(({ marker, circle, poi }) => {
                const allCards = Object.values(COLLECTIONS).flatMap(col => col.cards);
                const cardsAtPOI = allCards.filter(card => 
                    card.poiId === poi.id && !collectedCards.includes(card.id)
                );
                
                const visible = cardsAtPOI.length > 0;
                marker.setVisible(visible);
                circle.setVisible(visible);
            });
        }

        // Movement
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('collectionsPanel').classList.contains('show') ||
                document.getElementById('cardPopup').classList.contains('show') ||
                document.getElementById('cardDetailView').classList.contains('show')) {
                return;
            }

            let newLat = playerPos.lat;
            let newLng = playerPos.lng;

            switch (e.key) {
                case 'ArrowUp':
                    newLat += MOVE_SPEED;
                    break;
                case 'ArrowDown':
                    newLat -= MOVE_SPEED;
                    break;
                case 'ArrowLeft':
                    newLng -= MOVE_SPEED;
                    break;
                case 'ArrowRight':
                    newLng += MOVE_SPEED;
                    break;
                default:
                    return;
            }

            playerPos = { lat: newLat, lng: newLng };
            if (playerMarker && map) {
                playerMarker.setPosition(playerPos);
                map.panTo(playerPos);
                applyIsometricCamera();
            }
            checkNearbyPOI();
        });

        function teleportToLatLng(latLng) {
            playerPos = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };

            if (playerMarker && map) {
                playerMarker.setPosition(playerPos);
                map.panTo(playerPos);
                applyIsometricCamera();
            }
            checkNearbyPOI();
        }

        // Card Collection
        function collectCard() {
            if (!currentNearbyPOI) return;

            const allCards = Object.values(COLLECTIONS).flatMap(col => col.cards);
            const cardsAtPOI = allCards.filter(card => 
                card.poiId === currentNearbyPOI.id && !collectedCards.includes(card.id)
            );

            if (cardsAtPOI.length > 0) {
                const card = cardsAtPOI[0];
                collectedCards.push(card.id);
                
                // Initialiser le niveau de la carte
                if (!cardLevels[card.id]) {
                    cardLevels[card.id] = { level: 1, experience: 0 };
                }
                
                document.getElementById('popupCardName').textContent = card.name;
                document.getElementById('popupCardType').textContent = card.type;
                document.getElementById('cardPopup').classList.add('show');
                
                // Mettre √† jour la visibilit√© des POI
                updatePOIVisibility();
                checkNearbyPOI();
            }
        }

        function collectDust() {
            if (!currentNearbyDust) return;

            collectedDustPoints.push(currentNearbyDust.id);
            
            // Montant al√©atoire entre 25 et 75
            const dustAmount = Math.floor(Math.random() * (MAX_DUST_DROP - MIN_DUST_DROP + 1)) + MIN_DUST_DROP;
            memorialDust += dustAmount;
            
            document.getElementById('dustCounter').textContent = memorialDust;
            
            // Animation ou notification (optionnel)
            console.log(`+${dustAmount} poudre m√©morielle collect√©e!`);
            
            // Mettre √† jour la visibilit√© des points de poudre
            updateDustVisibility();
            checkNearbyPOI();
        }

        function closeCardPopup() {
            document.getElementById('cardPopup').classList.remove('show');
        }

        // Collections
        function openCollections() {
            document.getElementById('collectionsPanel').classList.add('show');
            renderCollectionsList();
        }

        function closeCollections() {
            document.getElementById('collectionsPanel').classList.remove('show');
            selectedCollectionId = null;
            document.getElementById('collectionsList').classList.remove('hidden');
            document.getElementById('collectionDetail').classList.remove('show');
        }

        function renderCollectionsList() {
            const listDiv = document.getElementById('collectionsList');
            listDiv.innerHTML = '';

            const collectionsWithCards = Object.values(COLLECTIONS).filter(col =>
                col.cards.some(card => collectedCards.includes(card.id))
            );

            if (collectionsWithCards.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <p>Aucune carte collect√©e pour le moment</p>
                        <p style="font-size: 14px; margin-top: 8px;">Explorez Lyon pour commencer votre collection!</p>
                    </div>
                `;
                return;
            }

            collectionsWithCards.forEach(collection => {
                const progress = getCollectionProgress(collection.id);
                const div = document.createElement('div');
                div.className = 'collection-item';
                div.onclick = () => showCollectionDetail(collection.id);
                div.innerHTML = `
                    <div class="collection-item-header">
                        <div>
                            <h3 class="collection-item-title">${collection.name}</h3>
                            <p class="collection-item-desc">${collection.description}</p>
                        </div>
                        <span class="collection-badge">${progress.collected}/${progress.total}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(progress.collected / progress.total) * 100}%"></div>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        function getCollectionProgress(collectionId) {
            const collection = COLLECTIONS[collectionId];
            const collected = collection.cards.filter(card => collectedCards.includes(card.id)).length;
            return { collected, total: collection.cards.length };
        }

        function showCollectionDetail(collectionId) {
            selectedCollectionId = collectionId;
            const collection = COLLECTIONS[collectionId];
            const progress = getCollectionProgress(collectionId);

            document.getElementById('detailTitle').textContent = collection.name;
            document.getElementById('detailDesc').textContent = collection.description;
            document.getElementById('detailBadge').textContent = `${progress.collected}/${progress.total} cartes`;

            const cardsGrid = document.getElementById('cardsGrid');
            cardsGrid.innerHTML = '';

            collection.cards.forEach(card => {
                const isCollected = collectedCards.includes(card.id);
                const div = document.createElement('div');
                div.className = `card-item ${isCollected ? 'collected' : 'locked'}`;
                if (isCollected) {
                    div.onclick = () => openCardDetail(card);
                }
                div.innerHTML = `
                    <div class="card-icon">${isCollected ? 'üé¥' : '‚ùì'}</div>
                    <div class="card-name">${isCollected ? card.name : '???'}</div>
                    <div class="card-type">${isCollected ? card.type : 'Non collect√©e'}</div>
                `;
                cardsGrid.appendChild(div);
            });

            document.getElementById('collectionsList').classList.add('hidden');
            document.getElementById('collectionDetail').classList.add('show');
        }

        function backToCollections() {
            selectedCollectionId = null;
            document.getElementById('collectionsList').classList.remove('hidden');
            document.getElementById('collectionDetail').classList.remove('show');
        }

        // Card Detail View
        function openCardDetail(card) {
            selectedCard = card;
            
            // Initialiser le niveau si n√©cessaire
            if (!cardLevels[card.id]) {
                cardLevels[card.id] = { level: 1, experience: 0 };
            }
            
            document.getElementById('cardDetailHeaderTitle').textContent = card.name;
            document.getElementById('cardDetailName').textContent = card.name;
            document.getElementById('cardCategory').textContent = card.type;
            document.getElementById('cardDetailDustCounter').textContent = memorialDust;
            
            updateCardLevelDisplay();
            
            currentTab = 'general';
            switchTabProgrammatically('general');
            
            document.getElementById('cardDetailView').classList.add('show');
        }

        function getRarityGemHTML(rarity) {
            const config = RARITY_CONFIG[rarity];
            const shapeClass = `gem-${config.shape}`;
            return `<div class="${shapeClass}" style="background: ${config.color};"></div>`;
        }

        function getExpNeeded(card, currentLevel) {
            const rarity = card.rarity || 'common';
            return RARITY_CONFIG[rarity].exp[currentLevel] || 0;
        }

        function updateCardLevelDisplay() {
            if (!selectedCard) return;
            
            const cardLevel = cardLevels[selectedCard.id] || { level: 1, experience: 0 };
            const currentLevel = cardLevel.level;
            
            // Afficher le niveau sur la carte
            document.getElementById('cardLevelDisplay').textContent = `Niveau ${currentLevel}`;
            document.getElementById('cardArtLevel').textContent = `Niv. ${currentLevel}`;
            
            // Afficher la gemme de raret√©
            const rarityGem = document.getElementById('cardRarityGem');
            rarityGem.innerHTML = getRarityGemHTML(selectedCard.rarity);
            
            // Calculer l'exp√©rience n√©cessaire
            if (currentLevel >= MAX_LEVEL) {
                // Niveau maximum atteint
                document.getElementById('cardExpDisplay').textContent = `MAX`;
                document.getElementById('cardExpBar').style.width = `100%`;
                document.getElementById('addExpBtn').disabled = true;
                document.getElementById('addExpBtn').textContent = `‚ú® Niveau maximum atteint`;
                return;
            }
            
            const expNeeded = getExpNeeded(selectedCard, currentLevel);
            const expCurrent = cardLevel.experience;
            const expPercent = (expCurrent / expNeeded) * 100;
            
            document.getElementById('cardExpDisplay').textContent = `${expCurrent}/${expNeeded} üíú`;
            document.getElementById('cardExpBar').style.width = `${expPercent}%`;
            
            const canAddExp = memorialDust >= DUST_INCREMENT;
            const addExpBtn = document.getElementById('addExpBtn');
            addExpBtn.disabled = !canAddExp;
            
            if (canAddExp) {
                addExpBtn.textContent = `üíú Ajouter ${DUST_INCREMENT} poudre (+EXP)`;
            } else {
                addExpBtn.textContent = `üíú Poudre insuffisante (${memorialDust}/${DUST_INCREMENT})`;
            }
        }

        function addExperience() {
            if (!selectedCard) return;
            if (memorialDust < DUST_INCREMENT) return;
            
            const cardLevel = cardLevels[selectedCard.id];
            if (cardLevel.level >= MAX_LEVEL) return;
            
            // Retirer la poudre
            memorialDust -= DUST_INCREMENT;
            document.getElementById('dustCounter').textContent = memorialDust;
            document.getElementById('cardDetailDustCounter').textContent = memorialDust;
            
            // Ajouter l'exp√©rience
            cardLevel.experience += DUST_INCREMENT;
            
            // V√©rifier si on peut monter de niveau
            const expNeeded = getExpNeeded(selectedCard, cardLevel.level);
            
            if (cardLevel.experience >= expNeeded) {
                // Level up !
                cardLevel.level += 1;
                cardLevel.experience = Math.max(0, cardLevel.experience - expNeeded);
                
                // Animation ou notification
                console.log(`üéâ ${selectedCard.name} passe niveau ${cardLevel.level}!`);
            }
            
            updateCardLevelDisplay();
        }

        function switchTabProgrammatically(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.card-tab:not(.journal-tab)');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[0].classList.add('active'); // Activate first tab (general)
            
            // Update tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabMap = {
                'general': 'generalTab',
                'skins': 'skinsTab',
                'competences': 'competencesTab'
            };
            
            document.getElementById(tabMap[tabName]).classList.add('active');
        }

        function closeCardDetail() {
            document.getElementById('cardDetailView').classList.remove('show');
            selectedCard = null;
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.card-tab:not(.journal-tab)');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabMap = {
                'general': 'generalTab',
                'skins': 'skinsTab',
                'competences': 'competencesTab'
            };
            
            document.getElementById(tabMap[tabName]).classList.add('active');
        }

        function openJournalScreen() {
            if (!selectedCard) return;
            
            document.getElementById('journalScreenCardName').textContent = selectedCard.name;
            document.getElementById('journalScreenCardType').textContent = selectedCard.type;
            document.getElementById('journalScreen').classList.add('show');
        }

        function closeJournalScreen() {
            document.getElementById('journalScreen').classList.remove('show');
        }

        // GPS Functions
        function disableGPSTracking() {
            const gpsBtn = document.getElementById('gpsBtn');
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            gpsActive = false;
            gpsBtn.classList.remove('active');
        }

        function toggleGPS() {
            const gpsBtn = document.getElementById('gpsBtn');

            if (!isMobileDevice) {
                alert('La g√©olocalisation en direct est r√©serv√©e au mode t√©l√©phone. Sur web, la carte reste centr√©e sur Lyon.');
                return;
            }
            
            if (!gpsActive) {
                // Activer le GPS
                if ('geolocation' in navigator) {
                    gpsWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            playerPos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            if (playerMarker && map) {
                                playerMarker.setPosition(playerPos);
                                map.panTo(playerPos);
                                applyIsometricCamera();
                            }
                            
                            checkNearbyPOI();
                        },
                        (error) => {
                            console.error('Erreur GPS:', error);
                            alert('Impossible d\'acc√©der au GPS. V√©rifiez les permissions.');
                            gpsActive = false;
                            gpsBtn.classList.remove('active');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                    
                    gpsActive = true;
                    gpsBtn.classList.add('active');
                } else {
                    alert('La g√©olocalisation n\'est pas disponible sur cet appareil.');
                }
            } else {
                // D√©sactiver le GPS
                disableGPSTracking();
            }
        }

        // Joystick Functions
        function initJoystick() {
            const base = document.getElementById('joystickBase');
            const stick = document.getElementById('joystickStick');
            
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            
            function handleStart(e) {
                if (document.getElementById('collectionsPanel').classList.contains('show') ||
                    document.getElementById('cardPopup').classList.contains('show') ||
                    document.getElementById('cardDetailView').classList.contains('show') ||
                    document.getElementById('journalScreen').classList.contains('show')) {
                    return;
                }
                
                isDragging = true;
                const touch = e.touches ? e.touches[0] : e;
                const rect = base.getBoundingClientRect();
                startX = rect.left + rect.width / 2;
                startY = rect.top + rect.height / 2;
                
                handleMove(e);
            }
            
            function handleMove(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                
                let deltaX = touch.clientX - startX;
                let deltaY = touch.clientY - startY;
                
                // Limiter le d√©placement dans le cercle
                const maxDistance = 35;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > maxDistance) {
                    deltaX = (deltaX / distance) * maxDistance;
                    deltaY = (deltaY / distance) * maxDistance;
                }
                
                stick.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                
                // Calculer la direction normalis√©e
                joystickDirection.x = deltaX / maxDistance;
                joystickDirection.y = -deltaY / maxDistance; // Inverser Y pour correspondre aux coordonn√©es
                
                if (!joystickActive) {
                    joystickActive = true;
                    startJoystickMovement();
                }
            }
            
            function handleEnd(e) {
                isDragging = false;
                stick.style.transform = 'translate(-50%, -50%)';
                joystickDirection = { x: 0, y: 0 };
                joystickActive = false;
                
                if (joystickInterval) {
                    clearInterval(joystickInterval);
                    joystickInterval = null;
                }
            }
            
            // Touch events
            base.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
            
            // Mouse events (pour tester sur desktop)
            base.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
        }

        function startJoystickMovement() {
            joystickInterval = setInterval(() => {
                if (!joystickActive) return;
                
                const moveSpeed = MOVE_SPEED * 2; // Vitesse du joystick
                
                let newLat = playerPos.lat + (joystickDirection.y * moveSpeed);
                let newLng = playerPos.lng + (joystickDirection.x * moveSpeed);
                
                playerPos = { lat: newLat, lng: newLng };
                
                if (playerMarker && map && !gpsActive) {
                    playerMarker.setPosition(playerPos);
                    map.panTo(playerPos);
                }
                
                checkNearbyPOI();
            }, 50); // 20 FPS
        }

        // Initialiser le joystick au chargement de la carte
        window.addEventListener('load', () => {
            setTimeout(initJoystick, 1000);
        });
    </script>
</body>
</html>
